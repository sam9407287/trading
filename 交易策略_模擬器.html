<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“ç­–ç•¥æ¨¡æ“¬å™¨ - é˜²å®ˆå‹å¥—åˆ©</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .section h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .section h3 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-size: 20px;
        }
        
        .mermaid {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .action-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .result-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .risk-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .param-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .param-item strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        
        ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 14px;
            }
            
            .section {
                padding: 20px;
                margin: 30px 0;
            }
            
            .section h2 {
                font-size: 20px;
            }
            
            .section h3 {
                font-size: 18px;
            }
            
            .mermaid {
                padding: 10px;
            }
            
            .parameters {
                grid-template-columns: 1fr;
            }
            
            /* å„€è¡¨æ¿éŸ¿æ‡‰å¼ */
            .section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            .section input, .section button {
                font-size: 14px;
            }
        }
        
        @media (max-width: 768px) {
            /* æœªå¹³å€‰æŒå€‰å€åŸŸéŸ¿æ‡‰å¼ */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* è¼¸å…¥å€åŸŸéŸ¿æ‡‰å¼ */
            div[style*="grid-template-columns: 2fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* æŒ‰éˆ•éŸ¿æ‡‰å¼ */
            div[style*="grid-template-columns: 1fr 1fr"] button,
            div[style*="grid-template-columns: 1fr 1fr 1fr"] button {
                font-size: 12px;
                padding: 8px;
            }
            
            /* æ’è¡Œæ¦œéŸ¿æ‡‰å¼ */
            #leaderboard {
                grid-template-columns: 1fr !important;
            }
            
            /* ç™»éŒ„å€åŸŸéŸ¿æ‡‰å¼ */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] input,
            div[style*="grid-template-columns: 1fr 1fr 1fr"] button {
                font-size: 12px;
                padding: 8px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .section {
                padding: 15px;
            }
            
            input, button {
                font-size: 14px !important;
                padding: 8px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="äº¤æ˜“ç­–ç•¥_æ±ºç­–æ¨¹.html" class="back-link">â† è¿”å›æ±ºç­–æ¨¹</a>
        <h1>ğŸ® äº¤æ˜“ç­–ç•¥æ¨¡æ“¬å™¨</h1>
        <p class="subtitle">é˜²å®ˆå‹å¥—åˆ©ç­–ç•¥ - å‹•æ…‹å„€è¡¨æ¿æ¨¡æ“¬æ¨¡å¼</p>

        <!-- ç”¨æˆ¶ç™»éŒ„/è¨»å†Šå€åŸŸ -->
        <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; margin-bottom: 20px;">
            <div id="login-section" style="display: block;">
                <h3 style="color: white; margin-bottom: 15px;">ğŸ‘¤ ç”¨æˆ¶ç™»éŒ„ / è¨»å†Š</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="user-id" placeholder="ç”¨æˆ¶ID" style="padding: 10px; border: none; border-radius: 4px;">
                    <input type="password" id="user-password" placeholder="å¯†ç¢¼" style="padding: 10px; border: none; border-radius: 4px;">
                    <button onclick="loginOrRegister()" style="padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">ğŸ” ç™»éŒ„/è¨»å†Š</button>
                </div>
                <p style="font-size: 0.9em; opacity: 0.9;">æç¤ºï¼šé¦–æ¬¡ä½¿ç”¨æœƒè‡ªå‹•è¨»å†Šï¼Œæ•¸æ“šä¿å­˜åœ¨æ‚¨çš„è¨­å‚™ä¸Š</p>
            </div>
            <div id="user-info-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: white; margin: 0;">ğŸ‘¤ æ­¡è¿ï¼Œ<span id="current-user-id"></span></h3>
                        <p style="font-size: 0.9em; opacity: 0.9; margin: 5px 0 0 0;">ç¸½ç›ˆåˆ©ï¼š<span id="user-total-profit" style="font-weight: bold;">$0.00</span></p>
                    </div>
                    <button onclick="logout()" style="padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">ç™»å‡º</button>
                </div>
            </div>
        </div>
        
        <!-- æ’è¡Œæ¦œ -->
        <div class="section" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; margin-bottom: 20px;">
            <h3 style="color: white; margin-bottom: 15px;">ğŸ† ç›ˆåˆ©æ’è¡Œæ¦œï¼ˆå‰ä¸‰åï¼‰</h3>
            <div id="leaderboard" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">ğŸ¥‡</div>
                    <div style="font-weight: bold; font-size: 1.1em;" id="leader-1">-</div>
                    <div style="font-size: 0.9em; opacity: 0.9;" id="leader-1-amount">$0.00</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">ğŸ¥ˆ</div>
                    <div style="font-weight: bold; font-size: 1.1em;" id="leader-2">-</div>
                    <div style="font-size: 0.9em; opacity: 0.9;" id="leader-2-amount">$0.00</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">ğŸ¥‰</div>
                    <div style="font-weight: bold; font-size: 1.1em;" id="leader-3">-</div>
                    <div style="font-size: 0.9em; opacity: 0.9;" id="leader-3-amount">$0.00</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 6px; font-size: 0.9em; line-height: 1.6;">
                <p style="margin: 0; opacity: 0.95;">ğŸ’¡ <strong>èªªæ˜ï¼š</strong>æ­¤æ’è¡Œæ¦œé¡¯ç¤ºçš„æ˜¯æ‚¨è‡ªå·±ä¸åŒå¸³æˆ¶çš„ç›ˆåˆ©æ¯”è¼ƒã€‚æ‚¨å¯ä»¥å»ºç«‹å¤šå€‹å¸³æˆ¶ï¼ˆä½¿ç”¨ä¸åŒçš„ç”¨æˆ¶IDï¼‰ä¾†æ¸¬è©¦ä¸åŒçš„äº¤æ˜“ç­–ç•¥æˆ–æ–¹æ³•ï¼Œä¸¦åœ¨æ­¤æ¯”è¼ƒå„å¸³æˆ¶çš„è¡¨ç¾ã€‚</p>
                <p style="margin: 8px 0 0 0; opacity: 0.9;">ğŸ“Š <strong>æœªä¾†è¦åŠƒï¼š</strong>ç³»çµ±æœªä¾†å°‡é€£æ¥è³‡æ–™åº«å¾Œï¼Œæ‰èƒ½èˆ‡å…¶ä»–ç”¨æˆ¶é€²è¡Œè·¨ç”¨æˆ¶çš„ç›ˆåˆ©æ¯”è¼ƒã€‚</p>
            </div>
        </div>

        <!-- å‹•æ…‹å„€è¡¨æ¿ -->
        <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <h2 style="color: white; border-bottom-color: rgba(255,255,255,0.3);">ğŸ“Š å‹•æ…‹å„€è¡¨æ¿ - æ¨¡æ“¬æ¨¡å¼</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- å·¦å´ï¼šè¼¸å…¥å€åŸŸ -->
                <div style="background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“ è¼¸å…¥æŒå€‰èˆ‡æ“ä½œ</h3>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ·»åŠ è³‡é‡‘</label>
                        <input type="number" id="add-capital" placeholder="ä¾‹å¦‚: 1000" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button onclick="addCapital()" style="width: 100%; margin-top: 5px; padding: 8px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">ğŸ’° æ·»åŠ è³‡é‡‘</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">é¸æ“‡/æ–°å¢è‚¡ç¥¨</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <select id="stock-select" onchange="selectStock()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- é¸æ“‡è‚¡ç¥¨ --</option>
                            </select>
                            <input type="text" id="stock-symbol" placeholder="æ–°å¢è‚¡ç¥¨ä»£è™Ÿ" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addNewStock()" style="width: 100%; margin-top: 5px; padding: 8px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">â• æ–°å¢è‚¡ç¥¨</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">è²·å…¥è‚¡ç¥¨</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="number" id="buy-shares" placeholder="è‚¡æ•¸" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="buy-price" placeholder="åƒ¹æ ¼" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addBuyOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">â• æ·»åŠ è²·å…¥</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">è³£å‡ºè‚¡ç¥¨</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="number" id="sell-shares" placeholder="è‚¡æ•¸" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="sell-price" placeholder="åƒ¹æ ¼" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addSellOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">â– æ·»åŠ è³£å‡º</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">è³£å‡º Callï¼ˆé–‹å€‰ï¼‰</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="call-strike" placeholder="è¡Œæ¬Šåƒ¹" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="call-premium" placeholder="æ¬Šåˆ©é‡‘ï¼ˆæ¯è‚¡ï¼‰" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="call-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ğŸ’¡ æç¤ºï¼šæ¬Šåˆ©é‡‘ç‚ºæ¯è‚¡åƒ¹æ ¼ï¼Œä¾‹å¦‚$50æ¬Šåˆ©é‡‘è¼¸å…¥0.5</p>
                        <button onclick="addCallOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">â• æ·»åŠ è³£ Call</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">è²·å…¥ Callï¼ˆå¹³å€‰ï¼‰</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="buy-call-strike" placeholder="è¡Œæ¬Šåƒ¹" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="buy-call-premium" placeholder="è²·å›åƒ¹ï¼ˆæ¯è‚¡ï¼‰" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="buy-call-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ğŸ’¡ æç¤ºï¼šè²·å›åƒ¹ç‚ºæ¯è‚¡åƒ¹æ ¼ï¼Œä¾‹å¦‚$50è²·å›åƒ¹è¼¸å…¥0.5</p>
                        <button onclick="addBuyCallOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">â– è²·å› Call</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">è³£å‡º Putï¼ˆé–‹å€‰ï¼‰</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="put-strike" placeholder="è¡Œæ¬Šåƒ¹" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="put-premium" placeholder="æ¬Šåˆ©é‡‘ï¼ˆæ¯è‚¡ï¼‰" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="put-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ğŸ’¡ æç¤ºï¼šæ¬Šåˆ©é‡‘ç‚ºæ¯è‚¡åƒ¹æ ¼ï¼Œä¾‹å¦‚$50æ¬Šåˆ©é‡‘è¼¸å…¥0.5</p>
                        <button onclick="addPutOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">â• æ·»åŠ è³£ Put</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">è²·å…¥ Putï¼ˆå¹³å€‰ï¼‰</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="buy-put-strike" placeholder="è¡Œæ¬Šåƒ¹" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="buy-put-premium" placeholder="è²·å›åƒ¹ï¼ˆæ¯è‚¡ï¼‰" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="buy-put-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ğŸ’¡ æç¤ºï¼šè²·å›åƒ¹ç‚ºæ¯è‚¡åƒ¹æ ¼ï¼Œä¾‹å¦‚$50è²·å›åƒ¹è¼¸å…¥0.5</p>
                        <button onclick="addBuyPutOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">â– è²·å› Put</button>
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">âš¡ æœŸæ¬Šè¢«è¡Œä½¿</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <select id="exercise-call-select" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">é¸æ“‡è¢«è¡Œä½¿çš„Call</option>
                            </select>
                            <select id="exercise-put-select" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">é¸æ“‡è¢«è¡Œä½¿çš„Put</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="exerciseCall()" style="padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">ğŸ“ Callè¢«è¡Œä½¿</button>
                            <button onclick="exercisePut()" style="padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">ğŸ“‰ Putè¢«è¡Œä½¿</button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="undoLastOperation()" id="undo-btn" style="padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;" disabled>â†¶ ä¸Šä¸€æ­¥</button>
                        <button onclick="clearAll()" style="padding: 10px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
                    </div>
                </div>
                
                <!-- å³å´ï¼šç‹€æ…‹é¡¯ç¤º -->
                <div style="background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“ˆ ç•¶å‰ç‹€æ…‹</h3>
                    
                    <div id="current-status" style="margin-bottom: 20px;">
                        <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                            <strong>ç¸½æŒè‚¡æ•¸ï¼š</strong><span id="total-shares">0</span> è‚¡
                        </div>
                        <div style="padding: 15px; background: #fff3e0; border-radius: 8px; margin-bottom: 10px;">
                            <strong>å¹³å‡æˆæœ¬ï¼š</strong>$<span id="avg-cost">0.00</span>
                        </div>
                        <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 10px;">
                            <strong>ç•¶å‰éšæ®µï¼š</strong><span id="current-stage">æœªé–‹å§‹</span>
                        </div>
                        <div style="padding: 15px; background: #fce4ec; border-radius: 8px; margin-bottom: 10px;">
                            <strong>æ±ºç­–æ¨¹ç¯€é»ï¼š</strong><span id="decision-node">ç­‰å¾…è¼¸å…¥æ•¸æ“š</span>
                        </div>
                        <div style="padding: 15px; background: #fff9c4; border-radius: 8px; margin-bottom: 10px;">
                            <strong>å·²å¯¦ç¾æç›Šï¼š</strong><span id="realized-pnl" style="font-weight: bold;">$0.00</span>
                        </div>
                        <div style="padding: 15px; background: #e1f5ff; border-radius: 8px;">
                            <strong>æœªå¯¦ç¾æç›Šï¼š</strong><span id="unrealized-pnl" style="font-weight: bold;">$0.00</span>
                        </div>
                        <div style="padding: 15px; background: #f3e5f5; border-radius: 8px; margin-top: 10px;">
                            <strong>ç¸½è³‡ç”¢åƒ¹å€¼ï¼š</strong><span id="total-assets" style="font-weight: bold; color: #9c27b0;">$0.00</span>
                        </div>
                        <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-top: 10px;">
                            <strong>å¯ç”¨è³‡é‡‘ï¼š</strong><span id="available-cash" style="color: #4caf50; font-weight: bold;">$0.00</span>
                        </div>
                    </div>
                    
                    <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">ğŸ“Š æ‰€æœ‰æŒå€‰ç¸½è¦½ï¼ˆå¯åœ¨æ­¤è¼¸å…¥å³æ™‚åƒ¹æ ¼ï¼‰</h4>
                    <div id="all-positions-overview" style="max-height: 500px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #999; font-style: italic;">è«‹è¼¸å…¥æŒå€‰æ•¸æ“š</p>
                    </div>
                    
                    <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">ğŸ“‹ æ“ä½œå»ºè­°èˆ‡ä»»å‹™æ¸…å–®</h4>
                    <div id="task-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #999; font-style: italic;">è«‹è¼¸å…¥æŒå€‰æ•¸æ“šä»¥ç”Ÿæˆä»»å‹™</p>
                    </div>
                    <div style="margin-top: 10px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px; font-size: 0.85em; line-height: 1.6;">
                        <p style="margin: 0; color: #856404;"><strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>æ±ºç­–æ¨¹ç¯€é»ã€ç•¶å‰éšæ®µä»¥åŠæ“ä½œå»ºè­°ä»»å‹™æ¸…å–®ä¹‹æ¼”ç®—æ³•é‚„æœªå®Œå…¨å®Œæˆï¼Œæ¼”ç®—æ³•ä»¥åŠé©—è­‰æ­£ç¢ºæ€§ä»åœ¨é€²è¡Œä¸­ã€‚è«‹åƒè€ƒã€Œæ±ºç­–æ¨¹é é¢ã€çš„æ­¥é©ŸåŸ·è¡Œå¯¦éš›æ“ä½œã€‚</p>
                    </div>
                </div>
            </div>
            
            <!-- æ“ä½œæ­·å² -->
            <div style="margin-top: 20px; background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“œ æ“ä½œæ­·å²</h3>
                <div id="operation-history" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: #999; font-style: italic;">å°šç„¡æ“ä½œè¨˜éŒ„</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            },
            securityLevel: 'loose'
        });

        // å„€è¡¨æ¿æ•¸æ“šå­˜å„² - æ”¯æŒå¤šè‚¡ç¥¨å’Œå¤šç”¨æˆ¶
        let dashboardData = {
            userId: '',  // ç•¶å‰ç”¨æˆ¶ID
            capitalAdditions: [],  // [{amount: 1000, date: '2025/01/01'}]
            stocks: {}  // {symbol: {operations: [], calls: [], puts: [], buyCalls: [], buyPuts: []}}
        };
        
        let currentStock = '';  // ç•¶å‰é¸ä¸­çš„è‚¡ç¥¨
        
        let currentPrices = {
            stocks: {}  // {symbol: {stock: 0, calls: {}, puts: {}}}
        };
        
        // æ“ä½œæ­·å²æ£§ï¼ˆç”¨æ–¼æ’¤éŠ·åŠŸèƒ½ï¼‰
        let operationHistory = [];  // [{type: 'buy', data: {...}, snapshot: {...}}]
        let maxHistorySize = 50;  // æœ€å¤šä¿å­˜50æ­¥æ“ä½œ
        
        // æ‰€æœ‰ç”¨æˆ¶æ•¸æ“šï¼ˆç”¨æ–¼æ’è¡Œæ¦œï¼Œæœªä¾†æœƒå¾æ•¸æ“šåº«è®€å–ï¼‰
        let allUsersData = {};  // {userId: {totalProfit: 0, ...}}

        // ç”¨æˆ¶ç™»éŒ„/è¨»å†Š
        function loginOrRegister() {
            const userId = document.getElementById('user-id').value.trim();
            const password = document.getElementById('user-password').value;
            
            if (!userId) {
                alert('è«‹è¼¸å…¥ç”¨æˆ¶ID');
                return;
            }
            
            if (!password) {
                alert('è«‹è¼¸å…¥å¯†ç¢¼');
                return;
            }
            
            // å¾localStorageè¼‰å…¥è©²ç”¨æˆ¶çš„æ•¸æ“š
            const userKey = `trading_user_${userId}`;
            const userData = localStorage.getItem(userKey);
            
            if (userData) {
                // é©—è­‰å¯†ç¢¼ï¼ˆç°¡å–®é©—è­‰ï¼Œæœªä¾†æœƒé€£æ¥åˆ°æ•¸æ“šåº«ï¼‰
                const parsed = JSON.parse(userData);
                if (parsed.password !== password) {
                    alert('å¯†ç¢¼éŒ¯èª¤');
                    return;
                }
                // è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
                loadUserData(userId);
            } else {
                // æ–°ç”¨æˆ¶è¨»å†Š
                const newUserData = {
                    password: password,
                    dashboardData: {
                        userId: userId,
                        capitalAdditions: [],
                        stocks: {}
                    },
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem(userKey, JSON.stringify(newUserData));
                loadUserData(userId);
                alert(`æ­¡è¿ï¼ç”¨æˆ¶ ${userId} è¨»å†ŠæˆåŠŸï¼`);
            }
            
            // æ›´æ–°UI
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('user-info-section').style.display = 'block';
            document.getElementById('current-user-id').textContent = userId;
            
            // æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard();
        }
        
        // è¼‰å…¥ç”¨æˆ¶æ•¸æ“š
        function loadUserData(userId) {
            const userKey = `trading_user_${userId}`;
            const userData = localStorage.getItem(userKey);
            
            // é‡ç½®æ“ä½œæ­·å²
            operationHistory = [];
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = true;
            }
            
            if (userData) {
                try {
                    const parsed = JSON.parse(userData);
                    dashboardData = parsed.dashboardData || {
                        userId: userId,
                        capitalAdditions: [],
                        stocks: {}
                    };
                    dashboardData.userId = userId;
                    
                    if (!dashboardData.stocks) {
                        dashboardData.stocks = {};
                    }
                    if (!dashboardData.capitalAdditions) {
                        dashboardData.capitalAdditions = [];
                    }
                    
                    // æ•¸æ“šé·ç§»ï¼šå¦‚æœæœ‰èˆŠçš„initialCapitalï¼Œè½‰æ›ç‚ºcapitalAdditions
                    if (parsed.dashboardData && parsed.dashboardData.initialCapital && parsed.dashboardData.initialCapital > 0 && dashboardData.capitalAdditions.length === 0) {
                        dashboardData.capitalAdditions.push({
                            amount: parsed.dashboardData.initialCapital,
                            date: new Date().toLocaleDateString('zh-TW'),
                            id: Date.now()
                        });
                        delete dashboardData.initialCapital;
                        saveData();
                    }
                    
                    updateStockSelect();
                    if (Object.keys(dashboardData.stocks).length > 0) {
                        currentStock = Object.keys(dashboardData.stocks)[0];
                        document.getElementById('stock-select').value = currentStock;
                    }
                    updateDisplay();
                    updateAvailableCash();
                    loadPrices();
                } catch (e) {
                    console.error('è¼‰å…¥ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', e);
                    dashboardData = {
                        userId: userId,
                        capitalAdditions: [],
                        stocks: {}
                    };
                }
            }
        }
        
        // ç™»å‡º
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿæ•¸æ“šå·²è‡ªå‹•ä¿å­˜ã€‚')) {
                dashboardData = {
                    userId: '',
                    capitalAdditions: [],
                    stocks: {}
                };
                currentStock = '';
                operationHistory = [];
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('user-info-section').style.display = 'none';
                document.getElementById('user-id').value = '';
                document.getElementById('user-password').value = '';
                updateDisplay();
            }
        }
        
        // å¾localStorageè¼‰å…¥æ•¸æ“šï¼ˆå…¼å®¹èˆŠç‰ˆæœ¬ï¼‰
        function loadData() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»éŒ„
            const saved = localStorage.getItem('tradingDashboard');
            if (saved && !dashboardData.userId) {
                try {
                    const loaded = JSON.parse(saved);
                    // å¦‚æœæœ‰èˆŠæ•¸æ“šä½†æ²’æœ‰ç”¨æˆ¶IDï¼Œæç¤ºç™»éŒ„
                    if (loaded.stocks || loaded.capitalAdditions) {
                        console.log('æª¢æ¸¬åˆ°èˆŠæ•¸æ“šï¼Œè«‹å…ˆç™»éŒ„ä»¥è¼‰å…¥æ•¸æ“š');
                    }
                } catch (e) {
                    console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', e);
                }
            }
            
            // è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶æ•¸æ“šç”¨æ–¼æ’è¡Œæ¦œ
            loadAllUsersForLeaderboard();
        }
        
        // è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶æ•¸æ“šï¼ˆç”¨æ–¼æ’è¡Œæ¦œï¼‰
        function loadAllUsersForLeaderboard() {
            allUsersData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('trading_user_')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        const userId = key.replace('trading_user_', '');
                        const profit = calculateUserTotalProfit(userData.dashboardData);
                        allUsersData[userId] = {
                            totalProfit: profit,
                            userId: userId
                        };
                    } catch (e) {
                        console.error('è¼‰å…¥ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', key, e);
                    }
                }
            }
            updateLeaderboard();
        }
        
        // è¨ˆç®—ç”¨æˆ¶ç¸½ç›ˆåˆ©
        function calculateUserTotalProfit(userDashboardData) {
            if (!userDashboardData) return 0;
            
            let realizedPnL = 0;
            let unrealizedPnL = 0;
            
            if (!userDashboardData.stocks) return 0;
            
            Object.keys(userDashboardData.stocks).forEach(symbol => {
                const stock = userDashboardData.stocks[symbol];
                
                // è¨ˆç®—å·²å¯¦ç¾æç›Š
                let buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                realizedPnL += buyQueue[0].shares * (op.price - buyQueue[0].price);
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                realizedPnL += remaining * (op.price - buyQueue[0].price);
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });
                
                // æœŸæ¬Šå·²å¯¦ç¾æç›Š
                stock.calls.forEach(call => {
                    if (call.closed && call.closePrice !== undefined) {
                        realizedPnL += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (put.closed && put.closePrice !== undefined) {
                        realizedPnL += (put.premium - put.closePrice) * 100;
                    }
                });
            });
            
            return realizedPnL + unrealizedPnL;
        }
        
        // æ›´æ–°æ’è¡Œæ¦œ
        function updateLeaderboard() {
            loadAllUsersForLeaderboard();
            
            // æ’åºç²å–å‰ä¸‰å
            const sortedUsers = Object.values(allUsersData)
                .sort((a, b) => b.totalProfit - a.totalProfit)
                .slice(0, 3);
            
            // æ›´æ–°é¡¯ç¤º
            for (let i = 0; i < 3; i++) {
                const leaderId = `leader-${i + 1}`;
                const leaderAmountId = `leader-${i + 1}-amount`;
                
                if (sortedUsers[i]) {
                    document.getElementById(leaderId).textContent = sortedUsers[i].userId;
                    document.getElementById(leaderAmountId).textContent = `$${sortedUsers[i].totalProfit.toFixed(2)}`;
                } else {
                    document.getElementById(leaderId).textContent = '-';
                    document.getElementById(leaderAmountId).textContent = '$0.00';
                }
            }
            
            // æ›´æ–°ç•¶å‰ç”¨æˆ¶çš„ç¸½ç›ˆåˆ©
            if (dashboardData.userId) {
                const currentUserProfit = calculateUserTotalProfit(dashboardData);
                document.getElementById('user-total-profit').textContent = `$${currentUserProfit.toFixed(2)}`;
            }
        }
        
        // è¼‰å…¥åƒ¹æ ¼
        function loadPrices() {
            const saved = localStorage.getItem('tradingPrices');
            if (saved) {
                currentPrices = JSON.parse(saved);
            }
        }
        
        // æ›´æ–°è‚¡ç¥¨é¸æ“‡ä¸‹æ‹‰æ¡†
        function updateStockSelect() {
            const select = document.getElementById('stock-select');
            const callSelect = document.getElementById('exercise-call-select');
            const putSelect = document.getElementById('exercise-put-select');
            const currentValue = select.value;
            
            if (!select || !callSelect || !putSelect) return;
            
            select.innerHTML = '<option value="">-- é¸æ“‡è‚¡ç¥¨ --</option>';
            callSelect.innerHTML = '<option value="">é¸æ“‡è¢«è¡Œä½¿çš„Call</option>';
            putSelect.innerHTML = '<option value="">é¸æ“‡è¢«è¡Œä½¿çš„Put</option>';
            
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
                
                // æ›´æ–°Callé¸æ“‡æ¡†
                const stock = dashboardData.stocks[symbol];
                if (stock && stock.calls) {
                    const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                    openCalls.forEach(call => {
                        const callOption = document.createElement('option');
                        callOption.value = `${symbol}_${call.id}`;
                        callOption.textContent = `${symbol} $${call.strike} Call (${call.expiry})`;
                        callSelect.appendChild(callOption);
                    });
                }
                
                // æ›´æ–°Puté¸æ“‡æ¡†
                if (stock && stock.puts) {
                    const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                    openPuts.forEach(put => {
                        const putOption = document.createElement('option');
                        putOption.value = `${symbol}_${put.id}`;
                        putOption.textContent = `${symbol} $${put.strike} Put (${put.expiry})`;
                        putSelect.appendChild(putOption);
                    });
                }
            });
            
            if (currentValue && dashboardData.stocks[currentValue]) {
                select.value = currentValue;
            }
        }
        
        // æ·»åŠ è³‡é‡‘
        function addCapital() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const amount = parseFloat(document.getElementById('add-capital').value);
            if (amount > 0) {
                // ä¿å­˜å¿«ç…§
                saveOperationSnapshot('addCapital', {amount: amount});
                
                if (!dashboardData.capitalAdditions) {
                    dashboardData.capitalAdditions = [];
                }
                dashboardData.capitalAdditions.push({
                    amount: amount,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now()
                });
                document.getElementById('add-capital').value = '';
                updateAvailableCash();
                updateDisplay();
                saveData();
                alert(`å·²æˆåŠŸæ·»åŠ è³‡é‡‘ $${amount.toFixed(2)}ï¼`);
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
            }
        }
        
        // æ–°å¢è‚¡ç¥¨
        function addNewStock() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const symbol = document.getElementById('stock-symbol').value.trim().toUpperCase();
            if (!symbol) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }
            
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            if (!dashboardData.stocks[symbol]) {
                // ä¿å­˜å¿«ç…§
                saveOperationSnapshot('addStock', {symbol: symbol});
                
                dashboardData.stocks[symbol] = {
                    operations: [],
                    calls: [],
                    puts: [],
                    buyCalls: [],
                    buyPuts: []
                };
                currentStock = symbol;
                updateStockSelect();
                document.getElementById('stock-select').value = symbol;
                document.getElementById('stock-symbol').value = '';
                updateDisplay();
                saveData();
                alert(`è‚¡ç¥¨ ${symbol} å·²æˆåŠŸæ–°å¢ï¼`);
            } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥é¸æ“‡å®ƒ
                currentStock = symbol;
                document.getElementById('stock-select').value = symbol;
                updateDisplay();
                alert(`è‚¡ç¥¨ ${symbol} å·²å­˜åœ¨ï¼Œå·²åˆ‡æ›åˆ°è©²è‚¡ç¥¨`);
            }
        }
        
        // é¸æ“‡è‚¡ç¥¨
        function selectStock() {
            const symbol = document.getElementById('stock-select').value;
            if (symbol && dashboardData.stocks[symbol]) {
                currentStock = symbol;
                updateDisplay();
            }
        }
        
        // ç²å–ç•¶å‰è‚¡ç¥¨æ•¸æ“š
        function getCurrentStockData() {
            if (!currentStock || !dashboardData.stocks[currentStock]) {
                return null;
            }
            return dashboardData.stocks[currentStock];
        }

        // ä¿å­˜æ•¸æ“šåˆ°localStorageï¼ˆæŒ‰ç”¨æˆ¶ä¿å­˜ï¼‰
        function saveData() {
            if (!dashboardData.userId) {
                return; // æœªç™»éŒ„æ™‚ä¸ä¿å­˜
            }
            
            const userKey = `trading_user_${dashboardData.userId}`;
            const userData = localStorage.getItem(userKey);
            
            if (userData) {
                const parsed = JSON.parse(userData);
                parsed.dashboardData = dashboardData;
                parsed.updatedAt = new Date().toISOString();
                localStorage.setItem(userKey, JSON.stringify(parsed));
            } else {
                // å¦‚æœæ²’æœ‰ç”¨æˆ¶æ•¸æ“šï¼Œå‰µå»ºæ–°çš„
                const newUserData = {
                    password: '',  // å¯†ç¢¼ä¸æœƒåœ¨é€™è£¡æ›´æ–°
                    dashboardData: dashboardData,
                    updatedAt: new Date().toISOString()
                };
                localStorage.setItem(userKey, JSON.stringify(newUserData));
            }
            
            savePrices();
            updateLeaderboard();
            // æ•¸æ“šæœƒè‡ªå‹•ä¿å­˜ï¼Œä¸éœ€è¦æç¤º
        }
        
        // ä¿å­˜æ“ä½œå¿«ç…§ï¼ˆç”¨æ–¼æ’¤éŠ·ï¼‰
        function saveOperationSnapshot(operationType, operationData) {
            if (operationHistory.length >= maxHistorySize) {
                operationHistory.shift(); // ç§»é™¤æœ€èˆŠçš„æ“ä½œ
            }
            
            // å‰µå»ºç•¶å‰ç‹€æ…‹çš„æ·±æ‹·è²
            const snapshot = JSON.parse(JSON.stringify({
                dashboardData: JSON.parse(JSON.stringify(dashboardData)),
                currentStock: currentStock,
                currentPrices: JSON.parse(JSON.stringify(currentPrices))
            }));
            
            operationHistory.push({
                type: operationType,
                data: operationData,
                snapshot: snapshot,
                timestamp: Date.now()
            });
            
            // æ›´æ–°æ’¤éŠ·æŒ‰éˆ•ç‹€æ…‹
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = false;
            }
        }
        
        // æ’¤éŠ·ä¸Šä¸€æ­¥æ“ä½œ
        function undoLastOperation() {
            if (operationHistory.length === 0) {
                alert('æ²’æœ‰å¯æ’¤éŠ·çš„æ“ä½œ');
                return;
            }
            
            const lastOperation = operationHistory.pop();
            
            // æ¢å¾©å¿«ç…§
            dashboardData = JSON.parse(JSON.stringify(lastOperation.snapshot.dashboardData));
            currentStock = lastOperation.snapshot.currentStock;
            currentPrices = JSON.parse(JSON.stringify(lastOperation.snapshot.currentPrices));
            
            // æ›´æ–°é¡¯ç¤º
            updateStockSelect();
            if (currentStock) {
                document.getElementById('stock-select').value = currentStock;
            }
            updateDisplay();
            updateAvailableCash();
            // è‡ªå‹•ä¿å­˜ï¼ˆæ•¸æ“šæœƒè‡ªå‹•ä¿å­˜ï¼Œä¸éœ€è¦æ‰‹å‹•ä¿å­˜ï¼‰
            saveData();
            
            // æ›´æ–°æ’¤éŠ·æŒ‰éˆ•ç‹€æ…‹
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = operationHistory.length === 0;
            }
        }

        // æ·»åŠ è²·å…¥æ“ä½œ
        function addBuyOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const shares = parseInt(document.getElementById('buy-shares').value);
            const price = parseFloat(document.getElementById('buy-price').value);
            
            if (!shares || !price) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„è²·å…¥ä¿¡æ¯');
                return;
            }

            // æª¢æŸ¥å¯ç”¨è³‡é‡‘æ˜¯å¦è¶³å¤ 
            const requiredCash = shares * price;
            const availableCash = calculateAvailableCash();
            
            if (availableCash < requiredCash) {
                const shortage = requiredCash - availableCash;
                alert(`è¶…éå¯ç”¨è³‡é‡‘ä¸Šé™ï¼\néœ€è¦è³‡é‡‘ï¼š$${requiredCash.toFixed(2)}\nå¯ç”¨è³‡é‡‘ï¼š$${availableCash.toFixed(2)}\nä¸è¶³é‡‘é¡ï¼š$${shortage.toFixed(2)}\n\nè«‹æ·»åŠ è³‡é‡‘å¾Œå†é€²è¡Œè²·å…¥æ“ä½œã€‚`);
                return;
            }

            const operation = {
                type: 'buy',
                shares: shares,
                price: price,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: currentStock
            };

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('buy', operation);

            stockData.operations.push(operation);

            document.getElementById('buy-shares').value = '';
            document.getElementById('buy-price').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // æ·»åŠ è³£å‡ºæ“ä½œ
        function addSellOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const shares = parseInt(document.getElementById('sell-shares').value);
            const price = parseFloat(document.getElementById('sell-price').value);
            
            if (!shares || !price) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„è³£å‡ºä¿¡æ¯');
                return;
            }

            const operation = {
                type: 'sell',
                shares: shares,
                price: price,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: currentStock
            };

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('sell', operation);

            stockData.operations.push(operation);

            document.getElementById('sell-shares').value = '';
            document.getElementById('sell-price').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // æ·»åŠ è³£Callæ“ä½œ
        function addCallOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('call-strike').value);
            const premium = parseFloat(document.getElementById('call-premium').value);
            const expiry = document.getElementById('call-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„Callä¿¡æ¯');
                return;
            }

            const call = {
                strike: strike,
                premium: premium,
                expiry: expiry,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                closed: false,
                symbol: currentStock,
                exercised: false
            };

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('sellCall', call);

            stockData.calls.push(call);

            document.getElementById('call-strike').value = '';
            document.getElementById('call-premium').value = '';
            document.getElementById('call-expiry').value = '';
            updateStockSelect();
            updateAvailableCash();
            // ä¸ç«‹å³æ›´æ–°æŒå€‰ç¸½è¦½ï¼Œç­‰å¾…å…¶ä»–æ“ä½œè§¸ç™¼
            updatePnL();
            updateHistory();
            saveData();
        }

        // æ·»åŠ è²·å…¥Callæ“ä½œï¼ˆå¹³å€‰ï¼‰
        function addBuyCallOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('buy-call-strike').value);
            const premium = parseFloat(document.getElementById('buy-call-premium').value);
            const expiry = document.getElementById('buy-call-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„Callä¿¡æ¯');
                return;
            }

            // å°‹æ‰¾åŒ¹é…çš„è³£Callä¾†å¹³å€‰
            const matchingCall = stockData.calls.find(c => 
                !c.closed && 
                !c.exercised &&
                Math.abs(c.strike - strike) < 0.01 && 
                c.expiry === expiry
            );

            // å¦‚æœæ²’æœ‰åŒ¹é…çš„ï¼Œé€™æ˜¯æ–°çš„é–‹å€‰ï¼Œéœ€è¦æª¢æŸ¥è³‡é‡‘
            if (!matchingCall) {
                const requiredCash = premium * 100; // æ¯å£100è‚¡
                const availableCash = calculateAvailableCash();
                
                if (availableCash < requiredCash) {
                    const shortage = requiredCash - availableCash;
                    alert(`è¶…éå¯ç”¨è³‡é‡‘ä¸Šé™ï¼\néœ€è¦è³‡é‡‘ï¼š$${requiredCash.toFixed(2)}\nå¯ç”¨è³‡é‡‘ï¼š$${availableCash.toFixed(2)}\nä¸è¶³é‡‘é¡ï¼š$${shortage.toFixed(2)}\n\nè«‹æ·»åŠ è³‡é‡‘å¾Œå†é€²è¡Œè²·å…¥Callæ“ä½œã€‚`);
                    return;
                }
            }

            const operationData = {strike, premium, expiry, symbol: currentStock};

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('buyCall', operationData);

            if (matchingCall) {
                matchingCall.closed = true;
                matchingCall.closePrice = premium;
                matchingCall.closeDate = new Date().toLocaleDateString('zh-TW');
            } else {
                // å¦‚æœæ²’æœ‰åŒ¹é…çš„ï¼Œè¨˜éŒ„ç‚ºè²·å…¥Callï¼ˆå¯èƒ½æ˜¯æ–°çš„é–‹å€‰ï¼‰
                stockData.buyCalls.push({
                    strike: strike,
                    premium: premium,
                    expiry: expiry,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now(),
                    symbol: currentStock
                });
            }

            document.getElementById('buy-call-strike').value = '';
            document.getElementById('buy-call-premium').value = '';
            document.getElementById('buy-call-expiry').value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // æ·»åŠ è³£Putæ“ä½œ
        function addPutOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('put-strike').value);
            const premium = parseFloat(document.getElementById('put-premium').value);
            const expiry = document.getElementById('put-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„Putä¿¡æ¯');
                return;
            }

            const put = {
                strike: strike,
                premium: premium,
                expiry: expiry,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                closed: false,
                symbol: currentStock,
                exercised: false
            };

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('sellPut', put);

            stockData.puts.push(put);

            document.getElementById('put-strike').value = '';
            document.getElementById('put-premium').value = '';
            document.getElementById('put-expiry').value = '';
            updateAvailableCash();
            // ä¸ç«‹å³æ›´æ–°æŒå€‰ç¸½è¦½ï¼Œç­‰å¾…å…¶ä»–æ“ä½œè§¸ç™¼
            updatePnL();
            updateHistory();
            saveData();
        }

        // æ·»åŠ è²·å…¥Putæ“ä½œï¼ˆå¹³å€‰ï¼‰
        function addBuyPutOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('buy-put-strike').value);
            const premium = parseFloat(document.getElementById('buy-put-premium').value);
            const expiry = document.getElementById('buy-put-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„Putä¿¡æ¯');
                return;
            }

            // å°‹æ‰¾åŒ¹é…çš„è³£Putä¾†å¹³å€‰
            const matchingPut = stockData.puts.find(p => 
                !p.closed && 
                !p.exercised &&
                Math.abs(p.strike - strike) < 0.01 && 
                p.expiry === expiry
            );

            // å¦‚æœæ²’æœ‰åŒ¹é…çš„ï¼Œé€™æ˜¯æ–°çš„é–‹å€‰ï¼Œéœ€è¦æª¢æŸ¥è³‡é‡‘
            if (!matchingPut) {
                const requiredCash = premium * 100; // æ¯å£100è‚¡
                const availableCash = calculateAvailableCash();
                
                if (availableCash < requiredCash) {
                    const shortage = requiredCash - availableCash;
                    alert(`è¶…éå¯ç”¨è³‡é‡‘ä¸Šé™ï¼\néœ€è¦è³‡é‡‘ï¼š$${requiredCash.toFixed(2)}\nå¯ç”¨è³‡é‡‘ï¼š$${availableCash.toFixed(2)}\nä¸è¶³é‡‘é¡ï¼š$${shortage.toFixed(2)}\n\nè«‹æ·»åŠ è³‡é‡‘å¾Œå†é€²è¡Œè²·å…¥Putæ“ä½œã€‚`);
                    return;
                }
            }

            const operationData = {strike, premium, expiry, symbol: currentStock};

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('buyPut', operationData);

            if (matchingPut) {
                matchingPut.closed = true;
                matchingPut.closePrice = premium;
                matchingPut.closeDate = new Date().toLocaleDateString('zh-TW');
            } else {
                // å¦‚æœæ²’æœ‰åŒ¹é…çš„ï¼Œè¨˜éŒ„ç‚ºè²·å…¥Putï¼ˆå¯èƒ½æ˜¯æ–°çš„é–‹å€‰ï¼‰
                stockData.buyPuts.push({
                    strike: strike,
                    premium: premium,
                    expiry: expiry,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now(),
                    symbol: currentStock
                });
            }

            document.getElementById('buy-put-strike').value = '';
            document.getElementById('buy-put-premium').value = '';
            document.getElementById('buy-put-expiry').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        
        // Callè¢«è¡Œä½¿
        function exerciseCall() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const select = document.getElementById('exercise-call-select');
            
            if (!select.value) {
                alert('è«‹é¸æ“‡è¢«è¡Œä½¿çš„Call');
                return;
            }
            
            const [symbol, callId] = select.value.split('_');
            const stockData = dashboardData.stocks[symbol];
            if (!stockData) return;
            
            const call = stockData.calls.find(c => c.id == callId);
            if (!call || call.exercised || call.closed) {
                alert('è©²Callå·²è¢«è¡Œä½¿æˆ–å·²å¹³å€‰');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„è‚¡ç¥¨ï¼ˆ100è‚¡ï¼‰
            let currentShares = 0;
            let buyQueue = [];
            stockData.operations.forEach(op => {
                if (op.type === 'buy') {
                    buyQueue.push({shares: op.shares, price: op.price});
                    currentShares += op.shares;
                } else if (op.type === 'sell') {
                    let remaining = op.shares;
                    while (remaining > 0 && buyQueue.length > 0) {
                        if (buyQueue[0].shares <= remaining) {
                            currentShares -= buyQueue[0].shares;
                            remaining -= buyQueue[0].shares;
                            buyQueue.shift();
                        } else {
                            currentShares -= remaining;
                            buyQueue[0].shares -= remaining;
                            remaining = 0;
                        }
                    }
                }
            });
            
            if (currentShares < 100) {
                alert(`ç„¡æ³•è¡Œä½¿Callï¼\néœ€è¦è‡³å°‘100è‚¡æ‰èƒ½è¡Œä½¿Call\nç•¶å‰æŒè‚¡ï¼š${currentShares}è‚¡\n\nè«‹å…ˆè²·å…¥è¶³å¤ çš„è‚¡ç¥¨å¾Œå†è¡Œä½¿Callã€‚`);
                return;
            }
            
            // ä½¿ç”¨Callçš„strikeåƒ¹æ ¼ä½œç‚ºè¡Œä½¿åƒ¹æ ¼
            const exercisePrice = call.strike;
            
            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('exerciseCall', {symbol, callId, exercisePrice});
            
            // æ¨™è¨˜ç‚ºå·²è¡Œä½¿
            call.exercised = true;
            call.exercisePrice = exercisePrice;
            call.exerciseDate = new Date().toLocaleDateString('zh-TW');
            
            // è‡ªå‹•æ¸›å°‘è‚¡ç¥¨æŒå€‰ï¼ˆ100è‚¡ï¼Œå› ç‚º1å£Call = 100è‚¡ï¼‰
            // æ³¨æ„ï¼šé€™è£¡è³£å‡ºè‚¡ç¥¨æ”¶åˆ°çš„éŒ¢æœƒå¢åŠ å¯ç”¨è³‡é‡‘ï¼Œä½†é€™æ˜¯æ­£å¸¸çš„ç¾é‡‘æµ
            // è³‡ç”¢ç¸½å€¼æœƒé€šéupdatePnL()è‡ªå‹•è¨ˆç®—ï¼ˆç¾é‡‘ + è‚¡ç¥¨å¸‚å€¼ï¼‰
            stockData.operations.push({
                type: 'sell',
                shares: 100,
                price: call.strike,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: symbol,
                reason: `Callè¢«è¡Œä½¿ (${call.strike} Call)`
            });
            
            alert(`${symbol} $${call.strike} Callå·²è¢«è¡Œä½¿ï¼Œå·²è‡ªå‹•è³£å‡º100è‚¡ @ $${call.strike}`);
            select.value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        
        // Putè¢«è¡Œä½¿
        function exercisePut() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const select = document.getElementById('exercise-put-select');
            
            if (!select.value) {
                alert('è«‹é¸æ“‡è¢«è¡Œä½¿çš„Put');
                return;
            }
            
            const [symbol, putId] = select.value.split('_');
            const stockData = dashboardData.stocks[symbol];
            if (!stockData) return;
            
            const put = stockData.puts.find(p => p.id == putId);
            if (!put || put.exercised || put.closed) {
                alert('è©²Putå·²è¢«è¡Œä½¿æˆ–å·²å¹³å€‰');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„ç¾é‡‘ï¼ˆ100è‚¡ * strikeåƒ¹æ ¼ï¼‰
            const requiredCash = 100 * put.strike;
            const availableCash = calculateAvailableCash();
            
            if (availableCash < requiredCash) {
                const shortage = requiredCash - availableCash;
                alert(`ç„¡æ³•è¡Œä½¿Putï¼\néœ€è¦è³‡é‡‘ï¼š$${requiredCash.toFixed(2)}ï¼ˆ100è‚¡ Ã— $${put.strike}ï¼‰\nå¯ç”¨è³‡é‡‘ï¼š$${availableCash.toFixed(2)}\nä¸è¶³é‡‘é¡ï¼š$${shortage.toFixed(2)}\n\nè«‹æ·»åŠ è³‡é‡‘å¾Œå†è¡Œä½¿Putã€‚`);
                return;
            }
            
            // ä½¿ç”¨Putçš„strikeåƒ¹æ ¼ä½œç‚ºè¡Œä½¿åƒ¹æ ¼
            const exercisePrice = put.strike;
            
            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('exercisePut', {symbol, putId, exercisePrice});
            
            // æ¨™è¨˜ç‚ºå·²è¡Œä½¿
            put.exercised = true;
            put.exercisePrice = exercisePrice;
            put.exerciseDate = new Date().toLocaleDateString('zh-TW');
            
            // è‡ªå‹•å¢åŠ è‚¡ç¥¨æŒå€‰ï¼ˆ100è‚¡ï¼Œå› ç‚º1å£Put = 100è‚¡ï¼‰
            // æ³¨æ„ï¼šé€™è£¡è²·å…¥è‚¡ç¥¨æ”¯ä»˜çš„éŒ¢æœƒæ¸›å°‘å¯ç”¨è³‡é‡‘ï¼Œä½†é€™æ˜¯æ­£å¸¸çš„ç¾é‡‘æµ
            // è³‡ç”¢ç¸½å€¼æœƒé€šéupdatePnL()è‡ªå‹•è¨ˆç®—ï¼ˆç¾é‡‘ + è‚¡ç¥¨å¸‚å€¼ï¼‰
            stockData.operations.push({
                type: 'buy',
                shares: 100,
                price: put.strike,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: symbol,
                reason: `Putè¢«è¡Œä½¿ (${put.strike} Put)`
            });
            
            alert(`${symbol} $${put.strike} Putå·²è¢«è¡Œä½¿ï¼Œå·²è‡ªå‹•è²·å…¥100è‚¡ @ $${put.strike}`);
            select.value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        

        // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        function clearAll() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                // ä¿å­˜ç•¶å‰ç”¨æˆ¶ID
                const currentUserId = dashboardData.userId;
                
                // é‡ç½®æ•¸æ“šçµæ§‹ï¼Œä½†ä¿ç•™userId
                dashboardData = {
                    userId: currentUserId,
                    capitalAdditions: [],
                    stocks: {}
                };
                currentPrices = {
                    stocks: {}
                };
                currentStock = '';
                operationHistory = [];
                document.getElementById('stock-symbol').value = '';
                document.getElementById('add-capital').value = '';
                updateStockSelect();
                
                // æ¸…é™¤æŒå€‰ç¸½è¦½
                const overviewDiv = document.getElementById('all-positions-overview');
                if (overviewDiv) {
                    overviewDiv.innerHTML = '<p style="color: #999; font-style: italic;">è«‹è¼¸å…¥æŒå€‰æ•¸æ“š</p>';
                }
                
                // æ¸…é™¤ç”¨æˆ¶ç‰¹å®šçš„localStorageæ•¸æ“š
                const userKey = `trading_user_${currentUserId}`;
                const userData = localStorage.getItem(userKey);
                if (userData) {
                    try {
                        const parsed = JSON.parse(userData);
                        // ä¿ç•™ç”¨æˆ¶ä¿¡æ¯å’Œå¯†ç¢¼ï¼Œåªæ¸…é™¤äº¤æ˜“æ•¸æ“š
                        const clearedUserData = {
                            password: parsed.password,
                            dashboardData: {
                                userId: currentUserId,
                                capitalAdditions: [],
                                stocks: {}
                            },
                            createdAt: parsed.createdAt || new Date().toISOString()
                        };
                        localStorage.setItem(userKey, JSON.stringify(clearedUserData));
                    } catch (e) {
                        console.error('æ¸…é™¤ç”¨æˆ¶æ•¸æ“šæ™‚å‡ºéŒ¯:', e);
                    }
                }
                
                // é‡ç½®ä¸Šä¸€æ­¥æŒ‰éˆ•
                const undoBtn = document.getElementById('undo-btn');
                if (undoBtn) {
                    undoBtn.disabled = true;
                }
                
                updateDisplay();
                alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ï¼');
            }
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            if (!currentStock || !dashboardData.stocks[currentStock]) {
                // æ²’æœ‰é¸ä¸­è‚¡ç¥¨ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
                document.getElementById('total-shares').textContent = '0';
                document.getElementById('avg-cost').textContent = '0.00';
                document.getElementById('current-stage').textContent = 'æœªé¸æ“‡è‚¡ç¥¨';
                document.getElementById('decision-node').textContent = 'è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨';
                updateAvailableCash();
                updatePnL();
                generateTasks(0, 0, [], []);
                updateHistory();
                return;
            }

            const stockData = getCurrentStockData();
            
            // è¨ˆç®—ç¸½æŒè‚¡æ•¸å’Œå¹³å‡æˆæœ¬ï¼ˆä½¿ç”¨FIFOæ–¹æ³•ï¼‰
            let totalShares = 0;
            let totalCost = 0;
            let buyQueue = [];
            
            stockData.operations.forEach(op => {
                if (op.type === 'buy') {
                    buyQueue.push({shares: op.shares, price: op.price});
                    totalShares += op.shares;
                    totalCost += op.shares * op.price;
                } else if (op.type === 'sell') {
                    let remaining = op.shares;
                    while (remaining > 0 && buyQueue.length > 0) {
                        if (buyQueue[0].shares <= remaining) {
                            remaining -= buyQueue[0].shares;
                            totalCost -= buyQueue[0].shares * buyQueue[0].price;
                            totalShares -= buyQueue[0].shares;
                            buyQueue.shift();
                        } else {
                            totalCost -= remaining * buyQueue[0].price;
                            totalShares -= remaining;
                            buyQueue[0].shares -= remaining;
                            remaining = 0;
                        }
                    }
                }
            });

            const avgCost = totalShares > 0 ? (totalCost / totalShares).toFixed(2) : 0;

            // æ›´æ–°ç‹€æ…‹é¡¯ç¤ºï¼ˆæ”¯æŒé¡¯ç¤ºè² æ•¸ç©ºé ­ï¼‰
            document.getElementById('total-shares').textContent = totalShares;
            document.getElementById('avg-cost').textContent = avgCost;

            // åˆ¤æ–·ç•¶å‰éšæ®µå’Œæ±ºç­–æ¨¹ç¯€é»
            const openCalls = stockData.calls.filter(c => !c.closed && !c.exercised);
            const openPuts = stockData.puts.filter(p => !p.closed && !p.exercised);
            const stage = determineStage(totalShares, openCalls, openPuts);
            document.getElementById('current-stage').textContent = stage.stage;
            document.getElementById('decision-node').textContent = stage.node;

            // æ›´æ–°æ‰€æœ‰æŒå€‰ç¸½è¦½
            updateAllPositionsOverview();

            // æ›´æ–°å¯ç”¨è³‡é‡‘
            updateAvailableCash();

            // è¨ˆç®—æç›Š
            updatePnL();

            // ç”Ÿæˆä»»å‹™æ¸…å–®
            generateTasks(currentStock, totalShares, avgCost, openCalls, openPuts);

            // æ›´æ–°æ“ä½œæ­·å²
            updateHistory();
        }
        
        // æ›´æ–°æ‰€æœ‰æŒå€‰ç¸½è¦½ï¼ˆåŒ…å«å³æ™‚åƒ¹æ ¼è¼¸å…¥ï¼‰
        function updateAllPositionsOverview() {
            const overviewDiv = document.getElementById('all-positions-overview');
            if (!overviewDiv) return;
            
            const allPositions = [];
            
            // éæ­·æ‰€æœ‰è‚¡ç¥¨
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                // è¨ˆç®—è‚¡ç¥¨æŒå€‰
                let shares = 0;
                let cost = 0;
                let buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                        shares += op.shares;
                        cost += op.shares * op.price;
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                shares -= buyQueue[0].shares;
                                cost -= buyQueue[0].shares * buyQueue[0].price;
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                shares -= remaining;
                                cost -= remaining * buyQueue[0].price;
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });
                const avgCost = shares > 0 ? cost / shares : 0;
                const stockPrice = currentPrices.stocks[symbol]?.stock || 0;
                const stockValue = stockPrice > 0 ? stockPrice * shares : avgCost * shares;
                const stockPnL = stockPrice > 0 ? (stockPrice - avgCost) * shares : 0;
                
                if (shares > 0) {
                    allPositions.push({
                        type: 'stock',
                        symbol: symbol,
                        shares: shares,
                        avgCost: avgCost,
                        currentPrice: stockPrice,
                        value: stockValue,
                        pnl: stockPnL,
                        id: `stock_${symbol}`
                    });
                }
                
                // CallæŒå€‰ï¼ˆè³£å‡ºCallï¼Œæç›Šè¦åéä¾†ï¼‰
                const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                openCalls.forEach(call => {
                    const key = `${call.strike}_${call.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.calls?.[key] || call.premium;
                    // è³£å‡ºCallï¼šåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼Œåƒ¹æ ¼ä¸Šæ¼²æ˜¯è™§æï¼ˆæç›Šåéä¾†ï¼‰
                    const callPnL = (call.premium - currentPrice) * 100; // è³£å‡ºæ™‚ï¼špremium - currentPrice
                    
                    allPositions.push({
                        type: 'call',
                        symbol: symbol,
                        strike: call.strike,
                        expiry: call.expiry,
                        premium: call.premium,
                        currentPrice: currentPrice,
                        value: currentPrice * 100,
                        pnl: callPnL,
                        id: call.id
                    });
                });
                
                // PutæŒå€‰ï¼ˆè³£å‡ºPutï¼Œæç›Šè¦åéä¾†ï¼‰
                const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                openPuts.forEach(put => {
                    const key = `${put.strike}_${put.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.puts?.[key] || put.premium;
                    // è³£å‡ºPutï¼šåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼Œåƒ¹æ ¼ä¸Šæ¼²æ˜¯è™§æï¼ˆæç›Šåéä¾†ï¼‰
                    const putPnL = (put.premium - currentPrice) * 100; // è³£å‡ºæ™‚ï¼špremium - currentPrice
                    
                    allPositions.push({
                        type: 'put',
                        symbol: symbol,
                        strike: put.strike,
                        expiry: put.expiry,
                        premium: put.premium,
                        currentPrice: currentPrice,
                        value: currentPrice * 100,
                        pnl: putPnL,
                        id: put.id
                    });
                });
            });
            
            if (allPositions.length === 0) {
                overviewDiv.innerHTML = '<p style="color: #999; font-style: italic;">ç„¡æŒå€‰</p>';
            } else {
                overviewDiv.innerHTML = allPositions.map(pos => {
                    const pnlColor = pos.pnl >= 0 ? '#4caf50' : '#f44336';
                    if (pos.type === 'stock') {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} è‚¡ç¥¨</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">${pos.shares}è‚¡ @ $${pos.avgCost.toFixed(2)}</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="stock-price-${pos.symbol}" value="${pos.currentPrice > 0 ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="è¼¸å…¥å³æ™‚è‚¡åƒ¹" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updateStockPriceFromOverview('${pos.symbol}')" style="padding: 6px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">æ›´æ–°</button>
                                </div>
                                ${pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="font-size: 0.9em;">å¸‚å€¼: $${pos.value.toFixed(2)}</span> | 
                                        <span style="color: ${pnlColor}; font-weight: bold;">æœªå¯¦ç¾æç›Š: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">è«‹è¼¸å…¥å³æ™‚è‚¡åƒ¹æŸ¥çœ‹æç›Š</div>'}
                            </div>
                        `;
                    } else if (pos.type === 'call') {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} $${pos.strike} Call</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">è³£å‡º @ $${pos.premium.toFixed(2)}/è‚¡</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="call-price-${pos.id}" value="${pos.currentPrice !== pos.premium ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="è¼¸å…¥å³æ™‚åƒ¹ï¼ˆæ¯è‚¡ï¼‰" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updateCallPriceFromOverview('${pos.symbol}', ${pos.strike}, '${pos.expiry}', ${pos.id})" style="padding: 6px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">æ›´æ–°</button>
                                </div>
                                ${pos.currentPrice !== pos.premium || pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="color: ${pnlColor}; font-weight: bold;">æœªå¯¦ç¾æç›Š: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">è«‹è¼¸å…¥å³æ™‚åƒ¹æ ¼æŸ¥çœ‹æç›Š</div>'}
                                <div style="margin-top: 5px; font-size: 0.85em; color: #666;">åˆ°æœŸ: ${pos.expiry}</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} $${pos.strike} Put</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">è³£å‡º @ $${pos.premium.toFixed(2)}/è‚¡</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="put-price-${pos.id}" value="${pos.currentPrice !== pos.premium ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="è¼¸å…¥å³æ™‚åƒ¹ï¼ˆæ¯è‚¡ï¼‰" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updatePutPriceFromOverview('${pos.symbol}', ${pos.strike}, '${pos.expiry}', ${pos.id})" style="padding: 6px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">æ›´æ–°</button>
                                </div>
                                ${pos.currentPrice !== pos.premium || pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="color: ${pnlColor}; font-weight: bold;">æœªå¯¦ç¾æç›Š: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">è«‹è¼¸å…¥å³æ™‚åƒ¹æ ¼æŸ¥çœ‹æç›Š</div>'}
                                <div style="margin-top: 5px; font-size: 0.85em; color: #666;">åˆ°æœŸ: ${pos.expiry}</div>
                            </div>
                        `;
                    }
                }).join('');
            }
        }
        
        // å¾æŒå€‰ç¸½è¦½æ›´æ–°è‚¡ç¥¨åƒ¹æ ¼
        function updateStockPriceFromOverview(symbol) {
            const input = document.getElementById(`stock-price-${symbol}`);
            const price = parseFloat(input.value);
            if (price > 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                currentPrices.stocks[symbol].stock = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
            }
        }
        
        // å¾æŒå€‰ç¸½è¦½æ›´æ–°Callåƒ¹æ ¼
        function updateCallPriceFromOverview(symbol, strike, expiry, callId) {
            const input = document.getElementById(`call-price-${callId}`);
            const price = parseFloat(input.value);
            if (price >= 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                if (!currentPrices.stocks[symbol].calls) {
                    currentPrices.stocks[symbol].calls = {};
                }
                currentPrices.stocks[symbol].calls[`${strike}_${expiry}`] = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
            }
        }
        
        // å¾æŒå€‰ç¸½è¦½æ›´æ–°Putåƒ¹æ ¼
        function updatePutPriceFromOverview(symbol, strike, expiry, putId) {
            const input = document.getElementById(`put-price-${putId}`);
            const price = parseFloat(input.value);
            if (price >= 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                if (!currentPrices.stocks[symbol].puts) {
                    currentPrices.stocks[symbol].puts = {};
                }
                currentPrices.stocks[symbol].puts[`${strike}_${expiry}`] = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
            }
        }
        
        // è¨ˆç®—ç•¶å‰å¯ç”¨è³‡é‡‘ï¼ˆè¿”å›æ•¸å€¼ï¼Œç”¨æ–¼é©—è­‰ï¼‰
        function calculateAvailableCash() {
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            // è¨ˆç®—æ‰€æœ‰æ·»åŠ çš„è³‡é‡‘
            let totalCash = 0;
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                totalCash = dashboardData.capitalAdditions.reduce((sum, addition) => sum + addition.amount, 0);
            }
            
            // è¨ˆç®—æ‰€æœ‰è‚¡ç¥¨çš„ç¾é‡‘æµ
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                // è‚¡ç¥¨è²·è³£ç¾é‡‘æµ
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        totalCash -= op.shares * op.price;
                    } else if (op.type === 'sell') {
                        totalCash += op.shares * op.price;
                    }
                });
                
                // æœŸæ¬Šæ¬Šåˆ©é‡‘ï¼ˆè³£å‡ºæ™‚æ”¶åˆ°æ¬Šåˆ©é‡‘ï¼Œè²·å›æ™‚æ”¯ä»˜ï¼‰
                stock.calls.forEach(call => {
                    if (!call.closed && !call.exercised) {
                        // æœªå¹³å€‰çš„è³£Callï¼Œå·²æ”¶åˆ°æ¬Šåˆ©é‡‘
                        totalCash += call.premium * 100;
                    } else if (call.closed) {
                        // å·²å¹³å€‰ï¼Œè¨ˆç®—æ·¨æç›Š
                        totalCash += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (!put.closed && !put.exercised) {
                        // æœªå¹³å€‰çš„è³£Putï¼Œå·²æ”¶åˆ°æ¬Šåˆ©é‡‘
                        totalCash += put.premium * 100;
                    } else if (put.closed) {
                        // å·²å¹³å€‰ï¼Œè¨ˆç®—æ·¨æç›Š
                        totalCash += (put.premium - put.closePrice) * 100;
                    }
                });
                
                // è²·å…¥çš„Call/Putï¼ˆé–‹å€‰æ™‚æ”¯ä»˜æ¬Šåˆ©é‡‘ï¼‰
                stock.buyCalls.forEach(buyCall => {
                    totalCash -= buyCall.premium * 100;
                });
                
                stock.buyPuts.forEach(buyPut => {
                    totalCash -= buyPut.premium * 100;
                });
            });
            
            return totalCash;
        }
        
        // æ›´æ–°å¯ç”¨è³‡é‡‘
        function updateAvailableCash() {
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            // è¨ˆç®—æ‰€æœ‰æ·»åŠ çš„è³‡é‡‘
            let totalCash = 0;
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                totalCash = dashboardData.capitalAdditions.reduce((sum, addition) => sum + addition.amount, 0);
            }
            
            // è¨ˆç®—æ‰€æœ‰è‚¡ç¥¨çš„ç¾é‡‘æµ
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                // è‚¡ç¥¨è²·è³£ç¾é‡‘æµ
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        totalCash -= op.shares * op.price;
                    } else if (op.type === 'sell') {
                        totalCash += op.shares * op.price;
                    }
                });
                
                // æœŸæ¬Šæ¬Šåˆ©é‡‘ï¼ˆè³£å‡ºæ™‚æ”¶åˆ°æ¬Šåˆ©é‡‘ï¼Œè²·å›æ™‚æ”¯ä»˜ï¼‰
                stock.calls.forEach(call => {
                    if (!call.closed && !call.exercised) {
                        // æœªå¹³å€‰çš„è³£Callï¼Œå·²æ”¶åˆ°æ¬Šåˆ©é‡‘
                        totalCash += call.premium * 100;
                    } else if (call.closed) {
                        // å·²å¹³å€‰ï¼Œè¨ˆç®—æ·¨æç›Š
                        totalCash += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (!put.closed && !put.exercised) {
                        // æœªå¹³å€‰çš„è³£Putï¼Œå·²æ”¶åˆ°æ¬Šåˆ©é‡‘
                        totalCash += put.premium * 100;
                    } else if (put.closed) {
                        // å·²å¹³å€‰ï¼Œè¨ˆç®—æ·¨æç›Š
                        totalCash += (put.premium - put.closePrice) * 100;
                    }
                });
                
                // è²·å…¥çš„Call/Putï¼ˆé–‹å€‰æ™‚æ”¯ä»˜æ¬Šåˆ©é‡‘ï¼‰
                stock.buyCalls.forEach(buyCall => {
                    totalCash -= buyCall.premium * 100;
                });
                
                stock.buyPuts.forEach(buyPut => {
                    totalCash -= buyPut.premium * 100;
                });
            });
            
            const cashElement = document.getElementById('available-cash');
            if (cashElement) {
                cashElement.textContent = `$${totalCash.toFixed(2)}`;
            }
        }


        // æ›´æ–°Callåƒ¹æ ¼
        function updateCallPrice(symbol, strike, expiry, price) {
            if (!currentPrices.stocks[symbol]) {
                currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
            }
            if (!currentPrices.stocks[symbol].calls) {
                currentPrices.stocks[symbol].calls = {};
            }
            currentPrices.stocks[symbol].calls[`${strike}_${expiry}`] = parseFloat(price);
            savePrices();
            updatePnL();
            updateDisplay();
        }

        // æ›´æ–°Putåƒ¹æ ¼
        function updatePutPrice(symbol, strike, expiry, price) {
            if (!currentPrices.stocks[symbol]) {
                currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
            }
            if (!currentPrices.stocks[symbol].puts) {
                currentPrices.stocks[symbol].puts = {};
            }
            currentPrices.stocks[symbol].puts[`${strike}_${expiry}`] = parseFloat(price);
            savePrices();
            updatePnL();
            updateDisplay();
        }

        // è¨ˆç®—æç›Šï¼ˆæ”¯æŒå¤šè‚¡ç¥¨ï¼‰
        function updatePnL() {
            let totalRealizedPnL = 0;
            let totalUnrealizedPnL = 0;
            
            // è¨ˆç®—å¯ç”¨è³‡é‡‘ï¼ˆç¾é‡‘ï¼‰
            let availableCash = 0;
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                availableCash = dashboardData.capitalAdditions.reduce((sum, addition) => sum + addition.amount, 0);
            }
            
            // è¨ˆç®—æ‰€æœ‰è‚¡ç¥¨çš„ç¾é‡‘æµ
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        availableCash -= op.shares * op.price;
                    } else if (op.type === 'sell') {
                        availableCash += op.shares * op.price;
                    }
                });
                
                // æœŸæ¬Šæ¬Šåˆ©é‡‘ï¼ˆè³£å‡ºæ™‚æ”¶åˆ°ï¼Œè²·å›æ™‚æ”¯ä»˜ï¼‰
                stock.calls.forEach(call => {
                    if (!call.closed && !call.exercised) {
                        availableCash += call.premium * 100; // æ¯å£100è‚¡
                    } else if (call.closed) {
                        availableCash += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (!put.closed && !put.exercised) {
                        availableCash += put.premium * 100; // æ¯å£100è‚¡
                    } else if (put.closed) {
                        availableCash += (put.premium - put.closePrice) * 100;
                    }
                });
                
                // è²·å…¥çš„Call/Putï¼ˆé–‹å€‰æ™‚æ”¯ä»˜æ¬Šåˆ©é‡‘ï¼‰
                stock.buyCalls.forEach(buyCall => {
                    availableCash -= buyCall.premium * 100;
                });
                
                stock.buyPuts.forEach(buyPut => {
                    availableCash -= buyPut.premium * 100;
                });
            });

            // è¨ˆç®—ç¸½è³‡ç”¢åƒ¹å€¼ = å¯ç”¨è³‡é‡‘ + æ‰€æœ‰è‚¡ç¥¨å¸‚å€¼ + æ‰€æœ‰æœŸæ¬Šå¸‚å€¼
            let totalAssets = availableCash;

            // éæ­·æ‰€æœ‰è‚¡ç¥¨
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                let realizedPnL = 0;
                let unrealizedPnL = 0;
                
                // è‚¡ç¥¨å·²å¯¦ç¾æç›Š
                let buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                realizedPnL += buyQueue[0].shares * (op.price - buyQueue[0].price);
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                realizedPnL += remaining * (op.price - buyQueue[0].price);
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });

                // Callå·²å¯¦ç¾æç›Š
                stock.calls.forEach(call => {
                    if (call.closed && call.closePrice !== undefined) {
                        // è²·å›å¹³å€‰ï¼špremium - closePrice
                        realizedPnL += (call.premium - call.closePrice) * 100;
                    } else if (call.exercised) {
                        // è¢«è¡Œä½¿ï¼šè¦–ç‚ºä»¥0å…ƒè²·å›ï¼Œè³ºåˆ°å…¨éƒ¨æ¬Šåˆ©é‡‘
                        realizedPnL += call.premium * 100;
                    }
                });

                // Putå·²å¯¦ç¾æç›Š
                stock.puts.forEach(put => {
                    if (put.closed && put.closePrice !== undefined) {
                        // è²·å›å¹³å€‰ï¼špremium - closePrice
                        realizedPnL += (put.premium - put.closePrice) * 100;
                    } else if (put.exercised) {
                        // è¢«è¡Œä½¿ï¼šè¦–ç‚ºä»¥0å…ƒè²·å›ï¼Œè³ºåˆ°å…¨éƒ¨æ¬Šåˆ©é‡‘
                        realizedPnL += put.premium * 100;
                    }
                });

                // è¨ˆç®—ç•¶å‰è‚¡ç¥¨æŒå€‰å’Œæˆæœ¬
                let shares = 0;
                let cost = 0;
                buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                        shares += op.shares;
                        cost += op.shares * op.price;
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                shares -= buyQueue[0].shares;
                                cost -= buyQueue[0].shares * buyQueue[0].price;
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                shares -= remaining;
                                cost -= remaining * buyQueue[0].price;
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });
                const avgCost = shares > 0 ? cost / shares : 0;

                // è‚¡ç¥¨å¸‚å€¼ï¼ˆåŠ å…¥ç¸½è³‡ç”¢ï¼‰
                const stockPrice = currentPrices.stocks[symbol]?.stock || 0;
                if (stockPrice > 0 && shares > 0) {
                    totalAssets += stockPrice * shares;
                    unrealizedPnL += (stockPrice - avgCost) * shares;
                } else if (shares > 0) {
                    totalAssets += avgCost * shares; // å¦‚æœæ²’æœ‰å³æ™‚åƒ¹æ ¼ï¼Œä½¿ç”¨æˆæœ¬åƒ¹
                }

                // Callæœªå¯¦ç¾æç›Šå’Œå¸‚å€¼ï¼ˆè³£å‡ºCallï¼šåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼Œåƒ¹æ ¼ä¸Šæ¼²æ˜¯è™§æï¼‰
                const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                openCalls.forEach(call => {
                    const key = `${call.strike}_${call.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.calls?.[key] || call.premium;
                    const callValue = currentPrice * 100; // æ¯å£100è‚¡
                    totalAssets -= callValue; // è³£å‡ºCallæ˜¯è² å‚µï¼Œéœ€è¦æ¸›å»
                    // è³£å‡ºCallï¼špremium - currentPriceï¼ˆåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼‰
                    unrealizedPnL += (call.premium - currentPrice) * 100;
                });

                // Putæœªå¯¦ç¾æç›Šå’Œå¸‚å€¼ï¼ˆè³£å‡ºPutï¼šåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼Œåƒ¹æ ¼ä¸Šæ¼²æ˜¯è™§æï¼‰
                const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                openPuts.forEach(put => {
                    const key = `${put.strike}_${put.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.puts?.[key] || put.premium;
                    const putValue = currentPrice * 100; // æ¯å£100è‚¡
                    totalAssets -= putValue; // è³£å‡ºPutæ˜¯è² å‚µï¼Œéœ€è¦æ¸›å»
                    // è³£å‡ºPutï¼špremium - currentPriceï¼ˆåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼‰
                    unrealizedPnL += (put.premium - currentPrice) * 100;
                });

                totalRealizedPnL += realizedPnL;
                totalUnrealizedPnL += unrealizedPnL;
            });

            // æ›´æ–°é¡¯ç¤º
            const realizedColor = totalRealizedPnL >= 0 ? '#4caf50' : '#f44336';
            const unrealizedColor = totalUnrealizedPnL >= 0 ? '#4caf50' : '#f44336';
            
            document.getElementById('realized-pnl').textContent = `$${totalRealizedPnL.toFixed(2)}`;
            document.getElementById('realized-pnl').style.color = realizedColor;
            
            document.getElementById('unrealized-pnl').textContent = `$${totalUnrealizedPnL.toFixed(2)}`;
            document.getElementById('unrealized-pnl').style.color = unrealizedColor;
            
            document.getElementById('total-assets').textContent = `$${totalAssets.toFixed(2)}`;
        }

        // åˆ¤æ–·ç•¶å‰éšæ®µï¼ˆä½¿ç”¨æœªå¹³å€‰çš„callså’Œputsï¼‰
        function determineStage(shares, calls, puts) {
            if (shares === 0) {
                return { stage: 'æœªé–‹å§‹', node: 'ç­‰å¾…åˆå§‹å»ºå€‰' };
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰Strangle
            if (calls.length > 0 && puts.length > 0) {
                return { 
                    stage: 'éšæ®µå››ï¼šStrangleç®¡ç†', 
                    node: 'æƒ…å¢ƒD1ï¼šStrangleç®¡ç†åˆ†æ”¯' 
                };
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰Call
            if (calls.length > 0) {
                const latestCall = calls[calls.length - 1];
                const today = new Date();
                const expiry = new Date(latestCall.expiry);
                const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

                if (daysUntilExpiry > 3) {
                    return { 
                        stage: 'éšæ®µäºŒï¼šé€±ä¸­ç®¡ç†', 
                        node: 'ç›£æ§GTCè¨‚å–®ï¼ˆ$5è²·å›Callï¼‰' 
                    };
                } else {
                    return { 
                        stage: 'éšæ®µä¸‰ï¼šçµç®—å‰', 
                        node: `ç­‰å¾…é€±äº”çµç®—ï¼ˆå‰©é¤˜${daysUntilExpiry}å¤©ï¼‰` 
                    };
                }
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰Put
            if (puts.length > 0) {
                return { 
                    stage: 'éšæ®µå››ï¼šåªè³£Putéšæ®µ', 
                    node: 'ç­‰å¾…Putè¡Œæ¬Šæˆ–éæœŸ' 
                };
            }

            // åªæœ‰æŒè‚¡
            if (shares === 150) {
                return { 
                    stage: 'éšæ®µä¸€ï¼šåˆå§‹å»ºå€‰', 
                    node: 'éœ€è¦è³£å‡ºCovered Call' 
                };
            }

            return { 
                stage: 'éšæ®µå››ï¼šé‡å•Ÿéšæ®µ', 
                node: 'æ ¹æ“šæŒå€‰æ±ºå®šä¸‹ä¸€æ­¥' 
            };
        }

        // ç”Ÿæˆä»»å‹™æ¸…å–®ï¼ˆæ”¯æŒå¤šè‚¡ç¥¨ï¼‰
        function generateTasks(symbol, shares, avgCost, calls, puts) {
            const taskList = document.getElementById('task-list');
            const tasks = [];

            if (!symbol) {
                taskList.innerHTML = '<p style="color: #999; font-style: italic;">è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨</p>';
                return;
            }

            if (shares === 0) {
                tasks.push(`ğŸ“ ${symbol}: è¼¸å…¥åˆå§‹è²·å…¥æ“ä½œï¼ˆå»ºè­°ï¼š150è‚¡ @ $11.00ï¼‰`);
                tasks.push(`ğŸ“ ${symbol}: è¼¸å…¥è³£Callæ“ä½œï¼ˆå»ºè­°ï¼š$12 Callï¼‰`);
            } else if (shares > 0 && calls.length === 0) {
                tasks.push(`âš ï¸ ${symbol}: ç«‹å³è³£å‡ºCovered Callï¼ˆå»ºè­°ï¼š$12 Callï¼‰`);
                tasks.push(`ğŸ“ ${symbol}: æ›GTCè¨‚å–®ï¼šä»¥$5è²·å›Callï¼ˆé–å®š90%åˆ©æ½¤ï¼‰`);
            } else if (calls.length > 0) {
                calls.forEach(call => {
                    const today = new Date();
                    const expiry = new Date(call.expiry);
                    const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    
                    tasks.push(`ğŸ“Š ${symbol}: ç›£æ§$${call.strike} Callåƒ¹æ ¼ï¼Œç•¶è·Œè‡³$5æ™‚GTCè¨‚å–®æœƒè‡ªå‹•æˆäº¤`);
                    tasks.push(`â° ${symbol}: $${call.strike} Callè·é›¢åˆ°æœŸé‚„æœ‰ ${daysUntilExpiry} å¤©`);
                    
                    if (daysUntilExpiry <= 1) {
                        tasks.push(`âš ï¸ ${symbol}: æº–å‚™é€±äº”çµç®—ï¼šæª¢æŸ¥è‚¡åƒ¹æ˜¯å¦æœƒè¶…é$${call.strike}`);
                    }
                });

                if (calls.length > 0 && puts.length > 0) {
                    tasks.push(`ğŸ”„ ${symbol}: Strangleç®¡ç†ï¼šç›£æ§Callå’ŒPutçš„åƒ¹æ ¼è®ŠåŒ–`);
                    tasks.push(`ğŸ“ ${symbol}: æ›GTCè¨‚å–®åˆ†åˆ¥è²·å›Callå’ŒPutï¼ˆé–å®š80-90%åˆ©æ½¤ï¼‰`);
                }
            }

            if (puts.length > 0 && calls.length === 0) {
                puts.forEach(put => {
                    tasks.push(`ğŸ“Š ${symbol}: ç›£æ§$${put.strike} Putåƒ¹æ ¼ï¼Œæº–å‚™åœ¨$${put.strike}è¡Œæ¬Šæ™‚åŠ å€‰`);
                });
            }

            // æ·»åŠ æ‰€æœ‰è‚¡ç¥¨çš„ä»»å‹™
            Object.keys(dashboardData.stocks).forEach(stockSymbol => {
                if (stockSymbol !== symbol) {
                    const stock = dashboardData.stocks[stockSymbol];
                    const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                    const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                    
                    if (openCalls.length > 0) {
                        openCalls.forEach(call => {
                            tasks.push(`ğŸ“Š ${stockSymbol}: ç›£æ§$${call.strike} Call`);
                        });
                    }
                    if (openPuts.length > 0) {
                        openPuts.forEach(put => {
                            tasks.push(`ğŸ“Š ${stockSymbol}: ç›£æ§$${put.strike} Put`);
                        });
                    }
                }
            });

            if (tasks.length === 0) {
                taskList.innerHTML = '<p style="color: #999; font-style: italic;">è«‹è¼¸å…¥æŒå€‰æ•¸æ“šä»¥ç”Ÿæˆä»»å‹™</p>';
            } else {
                taskList.innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">' + 
                    tasks.map(task => `<li style="padding: 10px; margin: 4px 0; background: #f0f0f0; border-radius: 4px; min-height: 45px; display: flex; align-items: center;">${task}</li>`).join('') + 
                    '</ul>';
            }
        }
        

        // æ›´æ–°æ“ä½œæ­·å²ï¼ˆæ”¯æŒå¤šè‚¡ç¥¨ï¼‰
        function updateHistory() {
            const historyDiv = document.getElementById('operation-history');
            const allOps = [];

            // æ·»åŠ è³‡é‡‘è¨˜éŒ„
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                dashboardData.capitalAdditions.forEach(addition => {
                    allOps.push({
                        type: 'æ·»åŠ è³‡é‡‘',
                        desc: `$${addition.amount.toFixed(2)}`,
                        date: addition.date
                    });
                });
            }

            // éæ­·æ‰€æœ‰è‚¡ç¥¨çš„æ“ä½œ
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                stock.operations.forEach(op => {
                    allOps.push({
                        type: op.type === 'buy' ? 'è²·å…¥' : 'è³£å‡º',
                        desc: `${symbol}: ${op.shares}è‚¡ @ $${op.price.toFixed(2)}${op.reason ? ` (${op.reason})` : ''}`,
                        date: op.date
                    });
                });

                stock.calls.forEach(call => {
                    if (call.exercised) {
                        allOps.push({
                            type: 'Callè¢«è¡Œä½¿',
                            desc: `${symbol} $${call.strike.toFixed(2)} Callè¢«è¡Œä½¿ï¼Œè‡ªå‹•è³£å‡º100è‚¡ @ $${call.strike}`,
                            date: call.exerciseDate
                        });
                    } else if (call.closed) {
                        allOps.push({
                            type: 'è³£Callï¼ˆå·²å¹³å€‰ï¼‰',
                            desc: `${symbol} $${call.strike.toFixed(2)} Callï¼Œè³£å‡º $${call.premium.toFixed(2)}ï¼Œè²·å› $${call.closePrice.toFixed(2)}ï¼Œæç›Š $${((call.premium - call.closePrice) * 100).toFixed(2)}`,
                            date: call.closeDate
                        });
                    } else {
                        allOps.push({
                            type: 'è³£Call',
                            desc: `${symbol} $${call.strike.toFixed(2)} Callï¼Œæ¬Šåˆ©é‡‘ $${call.premium.toFixed(2)}`,
                            date: call.date
                        });
                    }
                });

                stock.puts.forEach(put => {
                    if (put.exercised) {
                        allOps.push({
                            type: 'Putè¢«è¡Œä½¿',
                            desc: `${symbol} $${put.strike.toFixed(2)} Putè¢«è¡Œä½¿ï¼Œè‡ªå‹•è²·å…¥100è‚¡ @ $${put.strike}`,
                            date: put.exerciseDate
                        });
                    } else if (put.closed) {
                        allOps.push({
                            type: 'è³£Putï¼ˆå·²å¹³å€‰ï¼‰',
                            desc: `${symbol} $${put.strike.toFixed(2)} Putï¼Œè³£å‡º $${put.premium.toFixed(2)}ï¼Œè²·å› $${put.closePrice.toFixed(2)}ï¼Œæç›Š $${((put.premium - put.closePrice) * 100).toFixed(2)}`,
                            date: put.closeDate
                        });
                    } else {
                        allOps.push({
                            type: 'è³£Put',
                            desc: `${symbol} $${put.strike.toFixed(2)} Putï¼Œæ¬Šåˆ©é‡‘ $${put.premium.toFixed(2)}`,
                            date: put.date
                        });
                    }
                });
            });

            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            allOps.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allOps.length === 0) {
                historyDiv.innerHTML = '<p style="color: #999; font-style: italic;">å°šç„¡æ“ä½œè¨˜éŒ„</p>';
            } else {
                historyDiv.innerHTML = '<ul style="list-style: none; padding: 0;">' + 
                    allOps.map(op => 
                        `<li style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-left: 3px solid #3498db; border-radius: 4px;">
                            <strong>${op.type}</strong> - ${op.desc} <span style="color: #999; font-size: 0.9em;">(${op.date})</span>
                        </li>`
                    ).join('') + 
                    '</ul>';
            }
        }

        // ç›£è½è‚¡ç¥¨ä»£è™Ÿè¼¸å…¥
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            const symbolInput = document.getElementById('stock-symbol');
            if (symbolInput) {
                symbolInput.value = dashboardData.stockSymbol;
                symbolInput.addEventListener('blur', function() {
                    dashboardData.stockSymbol = this.value;
                    saveData();
                });
            }

            // å®šæœŸæ›´æ–°é¡¯ç¤ºï¼ˆæ¯30ç§’ï¼‰
            setInterval(updateDisplay, 30000);
            
            // è¼‰å…¥ä¿å­˜çš„åƒ¹æ ¼
            const savedPrices = localStorage.getItem('tradingPrices');
            if (savedPrices) {
                currentPrices = JSON.parse(savedPrices);
            }
            
            // åˆå§‹åŒ–æ™‚æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard();
        });

        // ä¿å­˜åƒ¹æ ¼åˆ°localStorage
        function savePrices() {
            localStorage.setItem('tradingPrices', JSON.stringify(currentPrices));
        }
    </script>
</body>
</html>
