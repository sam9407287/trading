<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>防守型套利-細節決策樹 - 150股模型</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .section h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .section h3 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-size: 20px;
        }
        
        .mermaid {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .action-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .result-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .risk-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .param-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .param-item strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        
        ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 14px;
            }
            
            .section {
                padding: 20px;
                margin: 30px 0;
            }
            
            .section h2 {
                font-size: 20px;
            }
            
            .section h3 {
                font-size: 18px;
            }
            
            .mermaid {
                padding: 10px;
            }
            
            .parameters {
                grid-template-columns: 1fr;
            }
            
            /* 儀表板響應式 */
            .section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            .section input, .section button {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="交易策略_防守型策略.html" class="back-link">← 返回防守型策略</a>
        <h1>🌳 防守型套利-細節決策樹</h1>
        <p class="subtitle">150股模型 - 完整決策樹狀結構</p>

        <!-- 動態儀表板 -->
        <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <h2 style="color: white; border-bottom-color: rgba(255,255,255,0.3);">📊 動態儀表板 - 模擬模式</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- 左側：輸入區域 -->
                <div style="background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">📝 輸入持倉與操作</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">股票代號</label>
                        <input type="text" id="stock-symbol" placeholder="例如: CRML" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">買入操作</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="number" id="buy-shares" placeholder="股數" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="buy-price" placeholder="價格" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addBuyOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➕ 添加買入</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">賣出 Call 操作</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="call-strike" placeholder="行權價" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="call-premium" placeholder="權利金" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="call-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addCallOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➕ 添加賣 Call</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">賣出 Put 操作</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="put-strike" placeholder="行權價" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="put-premium" placeholder="權利金" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="put-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addPutOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➕ 添加賣 Put</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="clearAll()" style="padding: 10px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">🗑️ 清除所有</button>
                        <button onclick="saveData()" style="padding: 10px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">💾 保存數據</button>
                    </div>
                </div>
                
                <!-- 右側：狀態顯示 -->
                <div style="background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">📈 當前狀態</h3>
                    
                    <div id="current-status" style="margin-bottom: 20px;">
                        <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                            <strong>總持股數：</strong><span id="total-shares">0</span> 股
                        </div>
                        <div style="padding: 15px; background: #fff3e0; border-radius: 8px; margin-bottom: 10px;">
                            <strong>平均成本：</strong>$<span id="avg-cost">0.00</span>
                        </div>
                        <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 10px;">
                            <strong>當前階段：</strong><span id="current-stage">未開始</span>
                        </div>
                        <div style="padding: 15px; background: #fce4ec; border-radius: 8px;">
                            <strong>決策樹節點：</strong><span id="decision-node">等待輸入數據</span>
                        </div>
                    </div>
                    
                    <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">📋 本週任務清單</h4>
                    <div id="task-list" style="min-height: 100px;">
                        <p style="color: #999; font-style: italic;">請輸入持倉數據以生成任務</p>
                    </div>
                </div>
            </div>
            
            <!-- 操作歷史 -->
            <div style="margin-top: 20px; background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">📜 操作歷史</h3>
                <div id="operation-history" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: #999; font-style: italic;">尚無操作記錄</p>
                </div>
            </div>
        </div>

        <!-- 系統參數 -->
        <div class="section">
            <h2>系統參數範例</h2>
            <div class="parameters">
                <div class="param-item">
                    <strong>目標股票</strong>
                    CRML
                </div>
                <div class="param-item">
                    <strong>初始買入價</strong>
                    $11.00
                </div>
                <div class="param-item">
                    <strong>關鍵阻力 (Call Strike)</strong>
                    $12.00 (原始 POC)
                </div>
                <div class="param-item">
                    <strong>關鍵支撐 (Put Strike)</strong>
                    $9.00 (二次加倉目標價)
                </div>
                <div class="param-item">
                    <strong>系統模型</strong>
                    150 股模型
                </div>
                <div class="param-item">
                    <strong>預備現金</strong>
                    已預留足夠現金，準備在 $9.00 執行 Short Put
                </div>
            </div>
        </div>

        <!-- 階段一：樹幹 -->
        <div class="section">
            <h2>階段一：樹幹（The Trunk）- 初始建倉</h2>
            <div class="action-box">
                <h3>行動 1（買入）</h3>
                <p>買入 150 股股票 @ $11.00 (總成本 $1650)</p>
            </div>
            <div class="action-box">
                <h3>行動 2（賣 Call）</h3>
                <p>立即賣出 1 口本週到期的 $12.00 Covered Call (假設收到 $50)</p>
            </div>
            <div class="action-box">
                <h3>行動 3（掛單）</h3>
                <p>立即掛一張 GTC（長效單）訂單，以 $5 的價格「買回」您剛才賣出的 Call（鎖定 90% 利潤）</p>
            </div>
            <div class="info-box">
                <strong>初始狀態：</strong>您持有 150 股。100 股被 Call 覆蓋（有效成本 $10.50），50 股是您的「自由股」。您開始等待市場觸發您的 GTC 訂單或到期結算。
            </div>
        </div>

        <!-- 階段二：分岔 -->
        <div class="section">
            <h2>階段二：分岔（The Fork）- 週中管理</h2>
            <p>您只對 GTC 訂單成交（$5 買回）做出反應。</p>
            
            <div class="mermaid">
graph TD
    START[初始建倉<br/>150股 + $12 Call] --> GTC{GTC訂單成交?}
    
    GTC -->|否| SETTLE[等待結算]
    GTC -->|是| REASON{成交原因?}
    
    REASON -->|價格勝利| D1[情境D1:<br/>股價下跌至$10<br/>觸發Path B]
    REASON -->|時間勝利| D2[情境D2:<br/>Theta耗損<br/>時間價值耗盡]
    
    D1 --> D1ACTION[賣出25股@$10<br/>賣出Short Strangle<br/>$12 Call + $9 Put]
    D2 --> D2ACTION[賣出下週$12 Call<br/>重新收租]
    
    style START fill:#e3f2fd,stroke:#2196f3,stroke-width:3px
    style D1 fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D2 fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px;">
                <h3>🌳 情境 D1：「價格勝利」（因股價下跌）</h3>
                <div class="info-box">
                    <strong>狀況：</strong>週二或週三，股價下跌至 $10.00。您的 $12 Call 價值崩跌至 $5，訂單成交。
                </div>
                <div class="action-box">
                    <strong>分析：</strong>市場觸發了您的「Path B：二次加倉」訊號。這是樹狀圖的主要分枝。
                </div>
                <div class="action-box">
                    <strong>行動：</strong>
                    <ul>
                        <li>賣出 25 股股票 @ $10.00（實現 25 股 @ $1.00 的虧損）</li>
                        <li>您手上還剩 125 股（100 股 @ $11 + 25 股 @ $11）</li>
                        <li>動用「預備現金」+ 剛賣出的 $250 + 新權利金</li>
                        <li>立即賣出 1 口下週的 Short Strangle（勒式）：
                            <ul>
                                <li>賣 1 口下週 $12.00 Call（管理您的 $11 成本持股）</li>
                                <li>賣 1 口下週 $9.00 Put（您的加倉目標）</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="result-box">
                    <strong>新狀態：</strong>您持有 125 股 + Short 1 Call @ $12 + Short 1 Put @ $9。<br>
                    <strong>Whipsaw (V 轉) 風險對沖：</strong>您手上還有 25 股「自由股」，這 25 股在 V 轉暴漲時，利潤不會被 $12 Call 鎖死。
                </div>
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px;">
                <h3>🌳 情境 D2：「時間勝利」（因 Theta 耗損）</h3>
                <div class="info-box">
                    <strong>狀況：</strong>週四下午或週五早上。股價橫盤在 $11.50 附近。時間價值耗盡，訂單成交。
                </div>
                <div class="action-box">
                    <strong>分析：</strong>Path B 未觸發。這是一個「小分枝」。
                </div>
                <div class="action-box">
                    <strong>行動：</strong>立即賣出 1 口下週的 $12.00 Call。重新開始「收租」，並掛好新的 $5 GTC 買回單。
                </div>
            </div>
        </div>

        <!-- 階段三：結算 -->
        <div class="section">
            <h2>階段三：結算（The Outcome）- 週五收盤</h2>
            <p>假設您的 GTC 訂單從未成交，您持有倉位直到結算。</p>
            
            <div class="mermaid">
graph TD
    SETTLE[週五結算] --> PRICE{股價收盤價?}
    
    PRICE -->|> $12.00| A[情境A: 上漲<br/>行權]
    PRICE -->|< $12.00| BC[情境B/C: 橫盤或下跌<br/>Call過期作廢]
    
    A --> A_RESULT[100股@$12賣出<br/>獲利$150<br/>剩餘50股自由股]
    BC --> BC_RESULT[淨賺$50權利金<br/>仍持有150股]
    
    style A fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style BC fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style A_RESULT fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
    style BC_RESULT fill:#fff3e0,stroke:#ff9800,stroke-width:2px
            </div>

            <div class="result-box" style="margin-top: 20px;">
                <h3>🔴 情境 A：「上漲」（股價收盤 > $12.00）</h3>
                <p><strong>結果：</strong>行權。您的 100 股以 $12 的價格被自動賣出。</p>
                <p><strong>獲利（100 股）：</strong>($12.00 賣出價 - $11.00 買入價) + $0.50 權利金 = 每股 $1.50 (總獲利 $150)</p>
                <p><strong>新狀態：</strong>您手上有 50 股「自由股」 + 大量現金。</p>
                <p><strong>結論：</strong>完美實現 Path A。「不錯過不後悔」。</p>
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h3>🟡 情境 B/C：「橫盤或下跌」（股價收盤 < $12.00）</h3>
                <p><strong>結果：</strong>Call 過期作廢。您淨賺 $50 權利金。</p>
                <p><strong>新狀態：</strong>您手上依然是 150 股（但總成本已降低）。</p>
                <p><strong>結論：</strong>成功「收租」。</p>
            </div>
        </div>

        <!-- 階段四：枝葉 -->
        <div class="section">
            <h2>階段四：枝葉（The Twigs）- 下週一重啟</h2>
            <p>您將根據上週的結算結果，長出新的「枝葉」。</p>
            
            <div class="mermaid">
graph TD
    RESTART[下週一重啟] --> RESULT{上週結算結果?}
    
    RESULT -->|情境A| A_RESTART[剩餘50股+現金<br/>只賣Put階段]
    RESULT -->|情境B/C| BC_RESTART[剩餘150股<br/>返回階段一]
    RESULT -->|情境D1| D1_RESTART[剩餘125股+Strangle<br/>Strangle管理分支]
    
    A_RESTART --> A_ACTION[賣Put @ $11.50<br/>掛GTC買回<br/>目標: 買回100股]
    
    BC_RESTART --> BC_ACTION[賣下週Call @ $12<br/>掛GTC買回]
    
    D1_RESTART --> D1_SETTLE{Strangle結算?}
    D1_SETTLE -->|Call行權| D1_1[剩餘25股<br/>只賣Put階段]
    D1_SETTLE -->|Put行權| D1_2[剩餘225股<br/>高低配收租]
    D1_SETTLE -->|都未行權| D1_3[剩餘125股<br/>繼續Short Strangle]
    
    D1_2 --> D1_2_ACTION[賣Call @ $10<br/>賣Call @ $12<br/>管理不同成本層]
    
    style A_RESTART fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    style BC_RESTART fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D1_RESTART fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style D1_2 fill:#ffebee,stroke:#f44336,stroke-width:2px
            </div>

            <div class="action-box" style="margin-top: 20px;">
                <h3>A 之重啟（您剩下 50 股 + 現金）</h3>
                <p><strong>行動：</strong>「只賣 Put 階段」</p>
                <ul>
                    <li>賣出 Put (Cash-Secured Put)：動用您的現金，去賣一口下週的、價外的 Put（例如 $11.50 或 $11）</li>
                    <li>掛單：掛 GTC 訂單買回這口 Put（鎖定 80-90% 利潤）</li>
                    <li>目的：「賺 put 的權利金以此循環」。如果被行權，您以低價買回 100 股，倉位回到 150 股，重返「階段一」</li>
                </ul>
            </div>

            <div class="action-box" style="margin-top: 20px;">
                <h3>B / C 之重啟（您剩下 150 股）</h3>
                <p><strong>行動：</strong>返回「階段一」</p>
                <ul>
                    <li>賣出 1 口下週的 Call（行使價 $12 或下調）</li>
                    <li>掛 GTC 訂單買回</li>
                </ul>
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px; background: #f3e5f5;">
                <h3>D1 之重啟（您剩下 125 股 + Strangle）</h3>
                <p><strong>行動：</strong>您現在進入了樹狀圖最複雜的「Strangle 管理」分支。</p>
                <ul>
                    <li>GTC：掛 GTC 訂單分別買回 Call 和 Put（鎖定 80-90% 利潤）</li>
                    <li>等待結算：</li>
                </ul>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.1 (Strangle Call @ $12 行權)：</h4>
                    <p><strong>新持倉：</strong>您手上「只剩下 25 股」（100 股被賣出）</p>
                    <p><strong>行動：</strong>「只賣 Put 階段」。開始賣 Put，試圖把持股拉回 125 股。</p>
                </div>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.2 (Strangle Put @ $9 行權)：</h4>
                    <p><strong>新持倉：</strong>您被迫買入 100 股，手上「剩下 225 股」</p>
                    <p><strong>成本分層：</strong>(125 股 @ $11) + (100 股 @ $9)</p>
                    <p><strong>行動（您的「高低配」收租策略）：</strong></p>
                    <ul>
                        <li>賣 1 口 Call @ $10.00（「比成本高一元」，管理您 $9 的持股）</li>
                        <li>賣 1 口 Call @ $12.00（原始 POC，管理您 $11 的持股）</li>
                    </ul>
                    <p><strong>後續演化：</strong></p>
                    <ul>
                        <li>如果 $10 Call 被行權（股價 $10.50）：您回到 125 股 + 1 Call @ $12 的狀態，並準備「回到 Strangle」（賣 $9 Put）</li>
                        <li>如果 $10 和 $12 Call 都被行權（股價 > $12）：您回到 25 股狀態，進入「只賣 Put 階段」</li>
                    </ul>
                </div>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.3 (兩邊都未行權)：</h4>
                    <p><strong>新持倉：</strong>您手上依然是 125 股</p>
                    <p><strong>行動：</strong>「繼續 short strangle」。賣下週的 $9p / $12c，重複 D1 循環</p>
                </div>
            </div>
        </div>

        <!-- 終局 -->
        <div class="section">
            <h2>終局：樹的邊界（The End of the Line）</h2>
            
            <div class="result-box">
                <h3>終局 1：「大暴漲」（策略大獲全勝）</h3>
                <p><strong>狀況：</strong>您的 Call @ $12 被行權，但股價飆升到 $20</p>
                <p><strong>倉位：</strong>您的 25 股或 50 股「自由股」</p>
                <p><strong>行動：</strong>不再額外操作。您不會在 $20 去賣 Put 追高。獲利了結，帶著利潤離場尋找下一個目標。</p>
            </div>

            <div class="risk-box">
                <h3>終局 2：「大暴跌」（策略唯一失敗）</h3>
                <p><strong>狀況：</strong>您的 Put @ $9 被行權（總持倉 225 股），但股價崩盤至 $5</p>
                <p><strong>行動：</strong>停止所有期權操作</p>
                <ul>
                    <li>不賣 Put：避免持倉增加到 325 股</li>
                    <li>不賣 Call：避免在 $6 這種低價「鎖定」您的巨大虧損，也避免為了幾塊錢的權利金，賣掉 $10-$12 的「翻身」機會</li>
                </ul>
                <p><strong>結論：</strong>「滾輪套利」系統在此失敗。您轉為「被動投資者」，持有這 225 股，等待未來基本面反轉。</p>
            </div>
        </div>

        <!-- 完整決策樹總覽 -->
        <div class="section">
            <h2>完整決策樹總覽</h2>
            <div class="mermaid">
flowchart TD
    START[階段一: 初始建倉<br/>150股 + $12 Call + GTC] --> WEEK[週中管理]
    
    WEEK --> GTC_CHECK{GTC成交?}
    GTC_CHECK -->|否| FRIDAY[週五結算]
    GTC_CHECK -->|是| D1[情境D1: 價格勝利<br/>125股+Strangle]
    GTC_CHECK -->|是| D2[情境D2: 時間勝利<br/>重新賣Call]
    
    FRIDAY --> PRICE_CHECK{股價?}
    PRICE_CHECK -->|> $12| A[情境A: 上漲<br/>50股+現金]
    PRICE_CHECK -->|< $12| BC[情境B/C: 收租<br/>150股]
    
    A --> A_NEXT[只賣Put階段]
    BC --> BC_NEXT[返回階段一]
    D1 --> D1_NEXT[Strangle管理]
    D2 --> D2_NEXT[返回階段一]
    
    D1_NEXT --> D1_RESULT{Strangle結果?}
    D1_RESULT -->|Call行權| D1_1[25股]
    D1_RESULT -->|Put行權| D1_2[225股<br/>高低配]
    D1_RESULT -->|未行權| D1_3[125股<br/>繼續Strangle]
    
    D1_1 --> PUT_ONLY[只賣Put階段]
    D1_2 --> HIGH_LOW[高低配收租]
    D1_3 --> D1_NEXT
    
    A_NEXT --> PUT_ONLY
    PUT_ONLY --> RESTART[循環重啟]
    BC_NEXT --> RESTART
    HIGH_LOW --> RESTART
    
    RESTART --> END1[終局1: 大暴漲<br/>獲利了結]
    RESTART --> END2[終局2: 大暴跌<br/>被動持有]
    
    style START fill:#e3f2fd,stroke:#2196f3,stroke-width:3px
    style A fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style BC fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D1 fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style D1_2 fill:#ffebee,stroke:#f44336,stroke-width:2px
    style END1 fill:#c8e6c9,stroke:#4caf50,stroke-width:3px
    style END2 fill:#ffcdd2,stroke:#f44336,stroke-width:3px
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            },
            securityLevel: 'loose'
        });

        // 儀表板數據存儲
        let dashboardData = {
            stockSymbol: '',
            operations: [],
            calls: [],
            puts: []
        };

        // 從localStorage載入數據
        function loadData() {
            const saved = localStorage.getItem('tradingDashboard');
            if (saved) {
                dashboardData = JSON.parse(saved);
                updateDisplay();
            }
        }

        // 保存數據到localStorage
        function saveData() {
            localStorage.setItem('tradingDashboard', JSON.stringify(dashboardData));
            alert('數據已保存！');
        }

        // 添加買入操作
        function addBuyOperation() {
            const shares = parseInt(document.getElementById('buy-shares').value);
            const price = parseFloat(document.getElementById('buy-price').value);
            
            if (!shares || !price) {
                alert('請輸入完整的買入信息');
                return;
            }

            dashboardData.operations.push({
                type: 'buy',
                shares: shares,
                price: price,
                date: new Date().toLocaleDateString('zh-TW')
            });

            document.getElementById('buy-shares').value = '';
            document.getElementById('buy-price').value = '';
            updateDisplay();
        }

        // 添加賣Call操作
        function addCallOperation() {
            const strike = parseFloat(document.getElementById('call-strike').value);
            const premium = parseFloat(document.getElementById('call-premium').value);
            const expiry = document.getElementById('call-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('請輸入完整的Call信息');
                return;
            }

            dashboardData.calls.push({
                strike: strike,
                premium: premium,
                expiry: expiry,
                date: new Date().toLocaleDateString('zh-TW')
            });

            document.getElementById('call-strike').value = '';
            document.getElementById('call-premium').value = '';
            document.getElementById('call-expiry').value = '';
            updateDisplay();
        }

        // 添加賣Put操作
        function addPutOperation() {
            const strike = parseFloat(document.getElementById('put-strike').value);
            const premium = parseFloat(document.getElementById('put-premium').value);
            const expiry = document.getElementById('put-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('請輸入完整的Put信息');
                return;
            }

            dashboardData.puts.push({
                strike: strike,
                premium: premium,
                expiry: expiry,
                date: new Date().toLocaleDateString('zh-TW')
            });

            document.getElementById('put-strike').value = '';
            document.getElementById('put-premium').value = '';
            document.getElementById('put-expiry').value = '';
            updateDisplay();
        }

        // 清除所有數據
        function clearAll() {
            if (confirm('確定要清除所有數據嗎？')) {
                dashboardData = {
                    stockSymbol: '',
                    operations: [],
                    calls: [],
                    puts: []
                };
                document.getElementById('stock-symbol').value = '';
                localStorage.removeItem('tradingDashboard');
                updateDisplay();
            }
        }

        // 更新顯示
        function updateDisplay() {
            // 更新股票代號
            const symbol = document.getElementById('stock-symbol').value || dashboardData.stockSymbol;
            if (symbol) {
                dashboardData.stockSymbol = symbol;
            }

            // 計算總持股數和平均成本
            let totalShares = 0;
            let totalCost = 0;
            
            dashboardData.operations.forEach(op => {
                if (op.type === 'buy') {
                    totalShares += op.shares;
                    totalCost += op.shares * op.price;
                }
            });

            const avgCost = totalShares > 0 ? (totalCost / totalShares).toFixed(2) : 0;

            // 更新狀態顯示
            document.getElementById('total-shares').textContent = totalShares;
            document.getElementById('avg-cost').textContent = avgCost;

            // 判斷當前階段和決策樹節點
            const stage = determineStage(totalShares, dashboardData.calls, dashboardData.puts);
            document.getElementById('current-stage').textContent = stage.stage;
            document.getElementById('decision-node').textContent = stage.node;

            // 生成任務清單
            generateTasks(totalShares, avgCost, dashboardData.calls, dashboardData.puts);

            // 更新操作歷史
            updateHistory();
        }

        // 判斷當前階段
        function determineStage(shares, calls, puts) {
            if (shares === 0) {
                return { stage: '未開始', node: '等待初始建倉' };
            }

            // 檢查是否有Strangle
            if (calls.length > 0 && puts.length > 0) {
                return { 
                    stage: '階段四：Strangle管理', 
                    node: '情境D1：Strangle管理分支' 
                };
            }

            // 檢查是否有Call
            if (calls.length > 0) {
                const latestCall = calls[calls.length - 1];
                const today = new Date();
                const expiry = new Date(latestCall.expiry);
                const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

                if (daysUntilExpiry > 3) {
                    return { 
                        stage: '階段二：週中管理', 
                        node: '監控GTC訂單（$5買回Call）' 
                    };
                } else {
                    return { 
                        stage: '階段三：結算前', 
                        node: `等待週五結算（剩餘${daysUntilExpiry}天）` 
                    };
                }
            }

            // 檢查是否有Put
            if (puts.length > 0) {
                return { 
                    stage: '階段四：只賣Put階段', 
                    node: '等待Put行權或過期' 
                };
            }

            // 只有持股
            if (shares === 150) {
                return { 
                    stage: '階段一：初始建倉', 
                    node: '需要賣出Covered Call' 
                };
            }

            return { 
                stage: '階段四：重啟階段', 
                node: '根據持倉決定下一步' 
            };
        }

        // 生成任務清單
        function generateTasks(shares, avgCost, calls, puts) {
            const taskList = document.getElementById('task-list');
            const tasks = [];

            if (shares === 0) {
                tasks.push('📝 輸入初始買入操作（建議：150股 @ $11.00）');
                tasks.push('📝 輸入賣Call操作（建議：$12 Call）');
            } else if (shares > 0 && calls.length === 0) {
                tasks.push('⚠️ 立即賣出Covered Call（建議：$12 Call）');
                tasks.push('📝 掛GTC訂單：以$5買回Call（鎖定90%利潤）');
            } else if (calls.length > 0) {
                const latestCall = calls[calls.length - 1];
                const today = new Date();
                const expiry = new Date(latestCall.expiry);
                const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

                tasks.push(`📊 監控$12 Call價格，當跌至$5時GTC訂單會自動成交`);
                tasks.push(`⏰ 距離到期還有 ${daysUntilExpiry} 天`);
                
                if (daysUntilExpiry <= 1) {
                    tasks.push('⚠️ 準備週五結算：檢查股價是否會超過$12');
                }

                if (calls.length > 0 && puts.length > 0) {
                    tasks.push('🔄 Strangle管理：監控Call和Put的價格變化');
                    tasks.push('📝 掛GTC訂單分別買回Call和Put（鎖定80-90%利潤）');
                }
            }

            if (puts.length > 0 && calls.length === 0) {
                tasks.push('📊 監控Put價格，準備在$9行權時加倉');
            }

            if (tasks.length === 0) {
                taskList.innerHTML = '<p style="color: #999; font-style: italic;">請輸入持倉數據以生成任務</p>';
            } else {
                taskList.innerHTML = '<ul style="list-style: none; padding: 0;">' + 
                    tasks.map(task => `<li style="padding: 8px; margin: 5px 0; background: #f0f0f0; border-radius: 4px;">${task}</li>`).join('') + 
                    '</ul>';
            }
        }

        // 更新操作歷史
        function updateHistory() {
            const historyDiv = document.getElementById('operation-history');
            const allOps = [];

            dashboardData.operations.forEach(op => {
                allOps.push({
                    type: '買入',
                    desc: `${op.shares}股 @ $${op.price.toFixed(2)}`,
                    date: op.date
                });
            });

            dashboardData.calls.forEach(call => {
                allOps.push({
                    type: '賣Call',
                    desc: `$${call.strike.toFixed(2)} Call，權利金 $${call.premium.toFixed(2)}`,
                    date: call.date
                });
            });

            dashboardData.puts.forEach(put => {
                allOps.push({
                    type: '賣Put',
                    desc: `$${put.strike.toFixed(2)} Put，權利金 $${put.premium.toFixed(2)}`,
                    date: put.date
                });
            });

            if (allOps.length === 0) {
                historyDiv.innerHTML = '<p style="color: #999; font-style: italic;">尚無操作記錄</p>';
            } else {
                historyDiv.innerHTML = '<ul style="list-style: none; padding: 0;">' + 
                    allOps.map(op => 
                        `<li style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-left: 3px solid #3498db; border-radius: 4px;">
                            <strong>${op.type}</strong> - ${op.desc} <span style="color: #999; font-size: 0.9em;">(${op.date})</span>
                        </li>`
                    ).join('') + 
                    '</ul>';
            }
        }

        // 監聽股票代號輸入
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            const symbolInput = document.getElementById('stock-symbol');
            if (symbolInput) {
                symbolInput.value = dashboardData.stockSymbol;
                symbolInput.addEventListener('blur', function() {
                    dashboardData.stockSymbol = this.value;
                    saveData();
                });
            }

            // 定期更新顯示（每30秒）
            setInterval(updateDisplay, 30000);
        });
    </script>
</body>
</html>

