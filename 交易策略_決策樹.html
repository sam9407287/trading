<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>防守型套利-細節決策樹 - 150股模型</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .section h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .section h3 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-size: 20px;
        }
        
        .mermaid {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .action-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .result-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .risk-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .param-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .param-item strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        
        ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 14px;
            }
            
            .section {
                padding: 20px;
                margin: 30px 0;
            }
            
            .section h2 {
                font-size: 20px;
            }
            
            .section h3 {
                font-size: 18px;
            }
            
            .mermaid {
                padding: 10px;
            }
            
            .parameters {
                grid-template-columns: 1fr;
            }
            
            /* 儀表板響應式 */
            .section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            .section input, .section button {
                font-size: 14px;
            }
        }
        
        @media (max-width: 768px) {
            /* 未平倉持倉區域響應式 */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* 輸入區域響應式 */
            div[style*="grid-template-columns: 2fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* 按鈕響應式 */
            div[style*="grid-template-columns: 1fr 1fr"] button,
            div[style*="grid-template-columns: 1fr 1fr 1fr"] button {
                font-size: 12px;
                padding: 8px;
            }
            
            /* 排行榜響應式 */
            #leaderboard {
                grid-template-columns: 1fr !important;
            }
            
            /* 登錄區域響應式 */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] input,
            div[style*="grid-template-columns: 1fr 1fr 1fr"] button {
                font-size: 12px;
                padding: 8px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .section {
                padding: 15px;
            }
            
            input, button {
                font-size: 14px !important;
                padding: 8px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="交易策略_防守型策略.html" class="back-link">← 返回防守型策略</a>
        <h1>🌳 防守型套利-細節決策樹</h1>
        <p class="subtitle">150股模型 - 完整決策樹狀結構</p>

        <!-- 用戶登錄/註冊區域 -->
        <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; margin-bottom: 20px;">
            <div id="login-section" style="display: block;">
                <h3 style="color: white; margin-bottom: 15px;">👤 用戶登錄 / 註冊</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="user-id" placeholder="用戶ID" style="padding: 10px; border: none; border-radius: 4px;">
                    <input type="password" id="user-password" placeholder="密碼" style="padding: 10px; border: none; border-radius: 4px;">
                    <button onclick="loginOrRegister()" style="padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">🔐 登錄/註冊</button>
                </div>
                <p style="font-size: 0.9em; opacity: 0.9;">提示：首次使用會自動註冊，數據保存在您的設備上</p>
            </div>
            <div id="user-info-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="color: white; margin: 0;">👤 歡迎，<span id="current-user-id"></span></h3>
                        <p style="font-size: 0.9em; opacity: 0.9; margin: 5px 0 0 0;">總盈利：<span id="user-total-profit" style="font-weight: bold;">$0.00</span></p>
                    </div>
                    <button onclick="logout()" style="padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">登出</button>
                </div>
            </div>
        </div>
        
        <!-- 排行榜 -->
        <div class="section" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; margin-bottom: 20px;">
            <h3 style="color: white; margin-bottom: 15px;">🏆 盈利排行榜（前三名）</h3>
            <div id="leaderboard" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">🥇</div>
                    <div style="font-weight: bold; font-size: 1.1em;" id="leader-1">-</div>
                    <div style="font-size: 0.9em; opacity: 0.9;" id="leader-1-amount">$0.00</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">🥈</div>
                    <div style="font-weight: bold; font-size: 1.1em;" id="leader-2">-</div>
                    <div style="font-size: 0.9em; opacity: 0.9;" id="leader-2-amount">$0.00</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 5px;">🥉</div>
                    <div style="font-weight: bold; font-size: 1.1em;" id="leader-3">-</div>
                    <div style="font-size: 0.9em; opacity: 0.9;" id="leader-3-amount">$0.00</div>
                </div>
            </div>
        </div>

        <!-- 動態儀表板 -->
        <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <h2 style="color: white; border-bottom-color: rgba(255,255,255,0.3);">📊 動態儀表板 - 模擬模式</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- 左側：輸入區域 -->
                <div style="background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">📝 輸入持倉與操作</h3>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">添加資金</label>
                        <input type="number" id="add-capital" placeholder="例如: 1000" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button onclick="addCapital()" style="width: 100%; margin-top: 5px; padding: 8px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">💰 添加資金</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">選擇/新增股票</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <select id="stock-select" onchange="selectStock()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- 選擇股票 --</option>
                            </select>
                            <input type="text" id="stock-symbol" placeholder="新增股票代號" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addNewStock()" style="width: 100%; margin-top: 5px; padding: 8px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➕ 新增股票</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">買入股票</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="number" id="buy-shares" placeholder="股數" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="buy-price" placeholder="價格" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addBuyOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➕ 添加買入</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">賣出股票</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="number" id="sell-shares" placeholder="股數" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="sell-price" placeholder="價格" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="addSellOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➖ 添加賣出</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">賣出 Call（開倉）</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="call-strike" placeholder="行權價" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="call-premium" placeholder="權利金（每股）" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="call-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">💡 提示：權利金為每股價格，例如$50權利金輸入0.5</p>
                        <button onclick="addCallOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➕ 添加賣 Call</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">買入 Call（平倉）</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="buy-call-strike" placeholder="行權價" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="buy-call-premium" placeholder="買回價（每股）" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="buy-call-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">💡 提示：買回價為每股價格，例如$50買回價輸入0.5</p>
                        <button onclick="addBuyCallOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➖ 買回 Call</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">賣出 Put（開倉）</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="put-strike" placeholder="行權價" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="put-premium" placeholder="權利金（每股）" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="put-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">💡 提示：權利金為每股價格，例如$50權利金輸入0.5</p>
                        <button onclick="addPutOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➕ 添加賣 Put</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">買入 Put（平倉）</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <input type="number" id="buy-put-strike" placeholder="行權價" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="number" id="buy-put-premium" placeholder="買回價（每股）" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="date" id="buy-put-expiry" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">💡 提示：買回價為每股價格，例如$50買回價輸入0.5</p>
                        <button onclick="addBuyPutOperation()" style="width: 100%; margin-top: 10px; padding: 10px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">➖ 買回 Put</button>
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ff9800;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">⚡ 期權被行使</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <select id="exercise-call-select" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">選擇被行使的Call</option>
                            </select>
                            <input type="number" id="exercise-price" placeholder="行使價格" step="0.01" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="exerciseCall()" style="padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">📞 Call被行使</button>
                            <button onclick="exercisePut()" style="padding: 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">📉 Put被行使</button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <button onclick="undoLastOperation()" id="undo-btn" style="padding: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;" disabled>↶ 上一步</button>
                        <button onclick="clearAll()" style="padding: 10px; background: #757575; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">🗑️ 清除所有</button>
                        <button onclick="saveData()" style="padding: 10px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">💾 保存數據</button>
                    </div>
                </div>
                
                <!-- 右側：狀態顯示 -->
                <div style="background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">📈 當前狀態</h3>
                    
                    <div id="current-status" style="margin-bottom: 20px;">
                        <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px;">
                            <strong>總持股數：</strong><span id="total-shares">0</span> 股
                        </div>
                        <div style="padding: 15px; background: #fff3e0; border-radius: 8px; margin-bottom: 10px;">
                            <strong>平均成本：</strong>$<span id="avg-cost">0.00</span>
                        </div>
                        <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 10px;">
                            <strong>當前階段：</strong><span id="current-stage">未開始</span>
                        </div>
                        <div style="padding: 15px; background: #fce4ec; border-radius: 8px; margin-bottom: 10px;">
                            <strong>決策樹節點：</strong><span id="decision-node">等待輸入數據</span>
                        </div>
                        <div style="padding: 15px; background: #fff9c4; border-radius: 8px; margin-bottom: 10px;">
                            <strong>已實現損益：</strong><span id="realized-pnl" style="font-weight: bold;">$0.00</span>
                        </div>
                        <div style="padding: 15px; background: #e1f5ff; border-radius: 8px;">
                            <strong>未實現損益：</strong><span id="unrealized-pnl" style="font-weight: bold;">$0.00</span>
                        </div>
                        <div style="padding: 15px; background: #f3e5f5; border-radius: 8px; margin-top: 10px;">
                            <strong>總資產價值：</strong><span id="total-assets" style="font-weight: bold; color: #9c27b0;">$0.00</span>
                        </div>
                        <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-top: 10px;">
                            <strong>可用資金：</strong><span id="available-cash" style="color: #4caf50; font-weight: bold;">$0.00</span>
                        </div>
                    </div>
                    
                    <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">📊 所有持倉總覽（可在此輸入即時價格）</h4>
                    <div id="all-positions-overview" style="max-height: 500px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #999; font-style: italic;">請輸入持倉數據</p>
                    </div>
                    
                    <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">📋 操作建議與任務清單</h4>
                    <div id="task-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #999; font-style: italic;">請輸入持倉數據以生成任務</p>
                    </div>
                </div>
            </div>
            
            <!-- 未平倉持倉顯示 -->
            <div style="margin-top: 20px; background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">📊 未平倉持倉與即時價格</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <!-- 股票持倉 -->
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">股票持倉</h4>
                        <div id="stock-positions" style="min-height: 50px;">
                            <p style="color: #999; font-style: italic; font-size: 0.9em;">無股票持倉</p>
                        </div>
                        <div style="margin-top: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: 500;">即時股價</label>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px;">
                                <input type="number" id="current-stock-price" placeholder="輸入即時股價" step="0.01" onchange="updatePnL(); savePrices();" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <button onclick="updateStockPrice()" style="padding: 8px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">更新</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Call持倉 -->
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">Call持倉</h4>
                        <div id="call-positions" style="min-height: 50px;">
                            <p style="color: #999; font-style: italic; font-size: 0.9em;">無Call持倉</p>
                        </div>
                    </div>
                    
                    <!-- Put持倉 -->
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">Put持倉</h4>
                        <div id="put-positions" style="min-height: 50px;">
                            <p style="color: #999; font-style: italic; font-size: 0.9em;">無Put持倉</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 操作歷史 -->
            <div style="margin-top: 20px; background: rgba(255,255,255,0.95); color: #2c3e50; padding: 20px; border-radius: 8px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">📜 操作歷史</h3>
                <div id="operation-history" style="max-height: 200px; overflow-y: auto;">
                    <p style="color: #999; font-style: italic;">尚無操作記錄</p>
                </div>
            </div>
        </div>

        <!-- 系統參數 -->
        <div class="section">
            <h2>系統參數範例</h2>
            <div class="parameters">
                <div class="param-item">
                    <strong>目標股票</strong>
                    CRML
                </div>
                <div class="param-item">
                    <strong>初始買入價</strong>
                    $11.00
                </div>
                <div class="param-item">
                    <strong>關鍵阻力 (Call Strike)</strong>
                    $12.00 (原始 POC)
                </div>
                <div class="param-item">
                    <strong>關鍵支撐 (Put Strike)</strong>
                    $9.00 (二次加倉目標價)
                </div>
                <div class="param-item">
                    <strong>系統模型</strong>
                    150 股模型
                </div>
                <div class="param-item">
                    <strong>預備現金</strong>
                    已預留足夠現金，準備在 $9.00 執行 Short Put
                </div>
            </div>
        </div>

        <!-- 階段一：樹幹 -->
        <div class="section">
            <h2>階段一：樹幹（The Trunk）- 初始建倉</h2>
            <div class="action-box">
                <h3>行動 1（買入）</h3>
                <p>買入 150 股股票 @ $11.00 (總成本 $1650)</p>
            </div>
            <div class="action-box">
                <h3>行動 2（賣 Call）</h3>
                <p>立即賣出 1 口本週到期的 $12.00 Covered Call (假設收到 $50)</p>
            </div>
            <div class="action-box">
                <h3>行動 3（掛單）</h3>
                <p>立即掛一張 GTC（長效單）訂單，以 $5 的價格「買回」您剛才賣出的 Call（鎖定 90% 利潤）</p>
            </div>
            <div class="info-box">
                <strong>初始狀態：</strong>您持有 150 股。100 股被 Call 覆蓋（有效成本 $10.50），50 股是您的「自由股」。您開始等待市場觸發您的 GTC 訂單或到期結算。
            </div>
        </div>

        <!-- 階段二：分岔 -->
        <div class="section">
            <h2>階段二：分岔（The Fork）- 週中管理</h2>
            <p>您只對 GTC 訂單成交（$5 買回）做出反應。</p>
            
            <div class="mermaid">
graph TD
    START[初始建倉<br/>150股 + $12 Call] --> GTC{GTC訂單成交?}
    
    GTC -->|否| SETTLE[等待結算]
    GTC -->|是| REASON{成交原因?}
    
    REASON -->|價格勝利| D1[情境D1:<br/>股價下跌至$10<br/>觸發Path B]
    REASON -->|時間勝利| D2[情境D2:<br/>Theta耗損<br/>時間價值耗盡]
    
    D1 --> D1ACTION[賣出25股@$10<br/>賣出Short Strangle<br/>$12 Call + $9 Put]
    D2 --> D2ACTION[賣出下週$12 Call<br/>重新收租]
    
    style START fill:#e3f2fd,stroke:#2196f3,stroke-width:3px
    style D1 fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D2 fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px;">
                <h3>🌳 情境 D1：「價格勝利」（因股價下跌）</h3>
                <div class="info-box">
                    <strong>狀況：</strong>週二或週三，股價下跌至 $10.00。您的 $12 Call 價值崩跌至 $5，訂單成交。
                </div>
                <div class="action-box">
                    <strong>分析：</strong>市場觸發了您的「Path B：二次加倉」訊號。這是樹狀圖的主要分枝。
                </div>
                <div class="action-box">
                    <strong>行動：</strong>
                    <ul>
                        <li>賣出 25 股股票 @ $10.00（實現 25 股 @ $1.00 的虧損）</li>
                        <li>您手上還剩 125 股（100 股 @ $11 + 25 股 @ $11）</li>
                        <li>動用「預備現金」+ 剛賣出的 $250 + 新權利金</li>
                        <li>立即賣出 1 口下週的 Short Strangle（勒式）：
                            <ul>
                                <li>賣 1 口下週 $12.00 Call（管理您的 $11 成本持股）</li>
                                <li>賣 1 口下週 $9.00 Put（您的加倉目標）</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="result-box">
                    <strong>新狀態：</strong>您持有 125 股 + Short 1 Call @ $12 + Short 1 Put @ $9。<br>
                    <strong>Whipsaw (V 轉) 風險對沖：</strong>您手上還有 25 股「自由股」，這 25 股在 V 轉暴漲時，利潤不會被 $12 Call 鎖死。
                </div>
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px;">
                <h3>🌳 情境 D2：「時間勝利」（因 Theta 耗損）</h3>
                <div class="info-box">
                    <strong>狀況：</strong>週四下午或週五早上。股價橫盤在 $11.50 附近。時間價值耗盡，訂單成交。
                </div>
                <div class="action-box">
                    <strong>分析：</strong>Path B 未觸發。這是一個「小分枝」。
                </div>
                <div class="action-box">
                    <strong>行動：</strong>立即賣出 1 口下週的 $12.00 Call。重新開始「收租」，並掛好新的 $5 GTC 買回單。
                </div>
            </div>
        </div>

        <!-- 階段三：結算 -->
        <div class="section">
            <h2>階段三：結算（The Outcome）- 週五收盤</h2>
            <p>假設您的 GTC 訂單從未成交，您持有倉位直到結算。</p>
            
            <div class="mermaid">
graph TD
    SETTLE[週五結算] --> PRICE{股價收盤價?}
    
    PRICE -->|> $12.00| A[情境A: 上漲<br/>行權]
    PRICE -->|< $12.00| BC[情境B/C: 橫盤或下跌<br/>Call過期作廢]
    
    A --> A_RESULT[100股@$12賣出<br/>獲利$150<br/>剩餘50股自由股]
    BC --> BC_RESULT[淨賺$50權利金<br/>仍持有150股]
    
    style A fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style BC fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style A_RESULT fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
    style BC_RESULT fill:#fff3e0,stroke:#ff9800,stroke-width:2px
            </div>

            <div class="result-box" style="margin-top: 20px;">
                <h3>🔴 情境 A：「上漲」（股價收盤 > $12.00）</h3>
                <p><strong>結果：</strong>行權。您的 100 股以 $12 的價格被自動賣出。</p>
                <p><strong>獲利（100 股）：</strong>($12.00 賣出價 - $11.00 買入價) + $0.50 權利金 = 每股 $1.50 (總獲利 $150)</p>
                <p><strong>新狀態：</strong>您手上有 50 股「自由股」 + 大量現金。</p>
                <p><strong>結論：</strong>完美實現 Path A。「不錯過不後悔」。</p>
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h3>🟡 情境 B/C：「橫盤或下跌」（股價收盤 < $12.00）</h3>
                <p><strong>結果：</strong>Call 過期作廢。您淨賺 $50 權利金。</p>
                <p><strong>新狀態：</strong>您手上依然是 150 股（但總成本已降低）。</p>
                <p><strong>結論：</strong>成功「收租」。</p>
            </div>
        </div>

        <!-- 階段四：枝葉 -->
        <div class="section">
            <h2>階段四：枝葉（The Twigs）- 下週一重啟</h2>
            <p>您將根據上週的結算結果，長出新的「枝葉」。</p>
            
            <div class="mermaid">
graph TD
    RESTART[下週一重啟] --> RESULT{上週結算結果?}
    
    RESULT -->|情境A| A_RESTART[剩餘50股+現金<br/>只賣Put階段]
    RESULT -->|情境B/C| BC_RESTART[剩餘150股<br/>返回階段一]
    RESULT -->|情境D1| D1_RESTART[剩餘125股+Strangle<br/>Strangle管理分支]
    
    A_RESTART --> A_ACTION[賣Put @ $11.50<br/>掛GTC買回<br/>目標: 買回100股]
    
    BC_RESTART --> BC_ACTION[賣下週Call @ $12<br/>掛GTC買回]
    
    D1_RESTART --> D1_SETTLE{Strangle結算?}
    D1_SETTLE -->|Call行權| D1_1[剩餘25股<br/>只賣Put階段]
    D1_SETTLE -->|Put行權| D1_2[剩餘225股<br/>高低配收租]
    D1_SETTLE -->|都未行權| D1_3[剩餘125股<br/>繼續Short Strangle]
    
    D1_2 --> D1_2_ACTION[賣Call @ $10<br/>賣Call @ $12<br/>管理不同成本層]
    
    style A_RESTART fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    style BC_RESTART fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D1_RESTART fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style D1_2 fill:#ffebee,stroke:#f44336,stroke-width:2px
            </div>

            <div class="action-box" style="margin-top: 20px;">
                <h3>A 之重啟（您剩下 50 股 + 現金）</h3>
                <p><strong>行動：</strong>「只賣 Put 階段」</p>
                <ul>
                    <li>賣出 Put (Cash-Secured Put)：動用您的現金，去賣一口下週的、價外的 Put（例如 $11.50 或 $11）</li>
                    <li>掛單：掛 GTC 訂單買回這口 Put（鎖定 80-90% 利潤）</li>
                    <li>目的：「賺 put 的權利金以此循環」。如果被行權，您以低價買回 100 股，倉位回到 150 股，重返「階段一」</li>
                </ul>
            </div>

            <div class="action-box" style="margin-top: 20px;">
                <h3>B / C 之重啟（您剩下 150 股）</h3>
                <p><strong>行動：</strong>返回「階段一」</p>
                <ul>
                    <li>賣出 1 口下週的 Call（行使價 $12 或下調）</li>
                    <li>掛 GTC 訂單買回</li>
                </ul>
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px; background: #f3e5f5;">
                <h3>D1 之重啟（您剩下 125 股 + Strangle）</h3>
                <p><strong>行動：</strong>您現在進入了樹狀圖最複雜的「Strangle 管理」分支。</p>
                <ul>
                    <li>GTC：掛 GTC 訂單分別買回 Call 和 Put（鎖定 80-90% 利潤）</li>
                    <li>等待結算：</li>
                </ul>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.1 (Strangle Call @ $12 行權)：</h4>
                    <p><strong>新持倉：</strong>您手上「只剩下 25 股」（100 股被賣出）</p>
                    <p><strong>行動：</strong>「只賣 Put 階段」。開始賣 Put，試圖把持股拉回 125 股。</p>
                </div>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.2 (Strangle Put @ $9 行權)：</h4>
                    <p><strong>新持倉：</strong>您被迫買入 100 股，手上「剩下 225 股」</p>
                    <p><strong>成本分層：</strong>(125 股 @ $11) + (100 股 @ $9)</p>
                    <p><strong>行動（您的「高低配」收租策略）：</strong></p>
                    <ul>
                        <li>賣 1 口 Call @ $10.00（「比成本高一元」，管理您 $9 的持股）</li>
                        <li>賣 1 口 Call @ $12.00（原始 POC，管理您 $11 的持股）</li>
                    </ul>
                    <p><strong>後續演化：</strong></p>
                    <ul>
                        <li>如果 $10 Call 被行權（股價 $10.50）：您回到 125 股 + 1 Call @ $12 的狀態，並準備「回到 Strangle」（賣 $9 Put）</li>
                        <li>如果 $10 和 $12 Call 都被行權（股價 > $12）：您回到 25 股狀態，進入「只賣 Put 階段」</li>
                    </ul>
                </div>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.3 (兩邊都未行權)：</h4>
                    <p><strong>新持倉：</strong>您手上依然是 125 股</p>
                    <p><strong>行動：</strong>「繼續 short strangle」。賣下週的 $9p / $12c，重複 D1 循環</p>
                </div>
            </div>
        </div>

        <!-- 終局 -->
        <div class="section">
            <h2>終局：樹的邊界（The End of the Line）</h2>
            
            <div class="result-box">
                <h3>終局 1：「大暴漲」（策略大獲全勝）</h3>
                <p><strong>狀況：</strong>您的 Call @ $12 被行權，但股價飆升到 $20</p>
                <p><strong>倉位：</strong>您的 25 股或 50 股「自由股」</p>
                <p><strong>行動：</strong>不再額外操作。您不會在 $20 去賣 Put 追高。獲利了結，帶著利潤離場尋找下一個目標。</p>
            </div>

            <div class="risk-box">
                <h3>終局 2：「大暴跌」（策略唯一失敗）</h3>
                <p><strong>狀況：</strong>您的 Put @ $9 被行權（總持倉 225 股），但股價崩盤至 $5</p>
                <p><strong>行動：</strong>停止所有期權操作</p>
                <ul>
                    <li>不賣 Put：避免持倉增加到 325 股</li>
                    <li>不賣 Call：避免在 $6 這種低價「鎖定」您的巨大虧損，也避免為了幾塊錢的權利金，賣掉 $10-$12 的「翻身」機會</li>
                </ul>
                <p><strong>結論：</strong>「滾輪套利」系統在此失敗。您轉為「被動投資者」，持有這 225 股，等待未來基本面反轉。</p>
            </div>
        </div>

        <!-- 完整決策樹總覽 -->
        <div class="section">
            <h2>完整決策樹總覽</h2>
            <div class="mermaid">
flowchart TD
    START[階段一: 初始建倉<br/>150股 + $12 Call + GTC] --> WEEK[週中管理]
    
    WEEK --> GTC_CHECK{GTC成交?}
    GTC_CHECK -->|否| FRIDAY[週五結算]
    GTC_CHECK -->|是| D1[情境D1: 價格勝利<br/>125股+Strangle]
    GTC_CHECK -->|是| D2[情境D2: 時間勝利<br/>重新賣Call]
    
    FRIDAY --> PRICE_CHECK{股價?}
    PRICE_CHECK -->|> $12| A[情境A: 上漲<br/>50股+現金]
    PRICE_CHECK -->|< $12| BC[情境B/C: 收租<br/>150股]
    
    A --> A_NEXT[只賣Put階段]
    BC --> BC_NEXT[返回階段一]
    D1 --> D1_NEXT[Strangle管理]
    D2 --> D2_NEXT[返回階段一]
    
    D1_NEXT --> D1_RESULT{Strangle結果?}
    D1_RESULT -->|Call行權| D1_1[25股]
    D1_RESULT -->|Put行權| D1_2[225股<br/>高低配]
    D1_RESULT -->|未行權| D1_3[125股<br/>繼續Strangle]
    
    D1_1 --> PUT_ONLY[只賣Put階段]
    D1_2 --> HIGH_LOW[高低配收租]
    D1_3 --> D1_NEXT
    
    A_NEXT --> PUT_ONLY
    PUT_ONLY --> RESTART[循環重啟]
    BC_NEXT --> RESTART
    HIGH_LOW --> RESTART
    
    RESTART --> END1[終局1: 大暴漲<br/>獲利了結]
    RESTART --> END2[終局2: 大暴跌<br/>被動持有]
    
    style START fill:#e3f2fd,stroke:#2196f3,stroke-width:3px
    style A fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style BC fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D1 fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style D1_2 fill:#ffebee,stroke:#f44336,stroke-width:2px
    style END1 fill:#c8e6c9,stroke:#4caf50,stroke-width:3px
    style END2 fill:#ffcdd2,stroke:#f44336,stroke-width:3px
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            },
            securityLevel: 'loose'
        });

        // 儀表板數據存儲 - 支持多股票和多用戶
        let dashboardData = {
            userId: '',  // 當前用戶ID
            capitalAdditions: [],  // [{amount: 1000, date: '2025/01/01'}]
            stocks: {}  // {symbol: {operations: [], calls: [], puts: [], buyCalls: [], buyPuts: []}}
        };
        
        let currentStock = '';  // 當前選中的股票
        
        let currentPrices = {
            stocks: {}  // {symbol: {stock: 0, calls: {}, puts: {}}}
        };
        
        // 操作歷史棧（用於撤銷功能）
        let operationHistory = [];  // [{type: 'buy', data: {...}, snapshot: {...}}]
        let maxHistorySize = 50;  // 最多保存50步操作
        
        // 所有用戶數據（用於排行榜，未來會從數據庫讀取）
        let allUsersData = {};  // {userId: {totalProfit: 0, ...}}

        // 用戶登錄/註冊
        function loginOrRegister() {
            const userId = document.getElementById('user-id').value.trim();
            const password = document.getElementById('user-password').value;
            
            if (!userId) {
                alert('請輸入用戶ID');
                return;
            }
            
            if (!password) {
                alert('請輸入密碼');
                return;
            }
            
            // 從localStorage載入該用戶的數據
            const userKey = `trading_user_${userId}`;
            const userData = localStorage.getItem(userKey);
            
            if (userData) {
                // 驗證密碼（簡單驗證，未來會連接到數據庫）
                const parsed = JSON.parse(userData);
                if (parsed.password !== password) {
                    alert('密碼錯誤');
                    return;
                }
                // 載入用戶數據
                loadUserData(userId);
            } else {
                // 新用戶註冊
                const newUserData = {
                    password: password,
                    dashboardData: {
                        userId: userId,
                        capitalAdditions: [],
                        stocks: {}
                    },
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem(userKey, JSON.stringify(newUserData));
                loadUserData(userId);
                alert(`歡迎！用戶 ${userId} 註冊成功！`);
            }
            
            // 更新UI
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('user-info-section').style.display = 'block';
            document.getElementById('current-user-id').textContent = userId;
            
            // 更新排行榜
            updateLeaderboard();
        }
        
        // 載入用戶數據
        function loadUserData(userId) {
            const userKey = `trading_user_${userId}`;
            const userData = localStorage.getItem(userKey);
            
            // 重置操作歷史
            operationHistory = [];
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = true;
            }
            
            if (userData) {
                try {
                    const parsed = JSON.parse(userData);
                    dashboardData = parsed.dashboardData || {
                        userId: userId,
                        capitalAdditions: [],
                        stocks: {}
                    };
                    dashboardData.userId = userId;
                    
                    if (!dashboardData.stocks) {
                        dashboardData.stocks = {};
                    }
                    if (!dashboardData.capitalAdditions) {
                        dashboardData.capitalAdditions = [];
                    }
                    
                    // 數據遷移：如果有舊的initialCapital，轉換為capitalAdditions
                    if (parsed.dashboardData && parsed.dashboardData.initialCapital && parsed.dashboardData.initialCapital > 0 && dashboardData.capitalAdditions.length === 0) {
                        dashboardData.capitalAdditions.push({
                            amount: parsed.dashboardData.initialCapital,
                            date: new Date().toLocaleDateString('zh-TW'),
                            id: Date.now()
                        });
                        delete dashboardData.initialCapital;
                        saveData();
                    }
                    
                    updateStockSelect();
                    if (Object.keys(dashboardData.stocks).length > 0) {
                        currentStock = Object.keys(dashboardData.stocks)[0];
                        document.getElementById('stock-select').value = currentStock;
                    }
                    updateDisplay();
                    updateAvailableCash();
                    loadPrices();
                } catch (e) {
                    console.error('載入用戶數據失敗:', e);
                    dashboardData = {
                        userId: userId,
                        capitalAdditions: [],
                        stocks: {}
                    };
                }
            }
        }
        
        // 登出
        function logout() {
            if (confirm('確定要登出嗎？數據已自動保存。')) {
                dashboardData = {
                    userId: '',
                    capitalAdditions: [],
                    stocks: {}
                };
                currentStock = '';
                operationHistory = [];
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('user-info-section').style.display = 'none';
                document.getElementById('user-id').value = '';
                document.getElementById('user-password').value = '';
                updateDisplay();
            }
        }
        
        // 從localStorage載入數據（兼容舊版本）
        function loadData() {
            // 檢查是否已登錄
            const saved = localStorage.getItem('tradingDashboard');
            if (saved && !dashboardData.userId) {
                try {
                    const loaded = JSON.parse(saved);
                    // 如果有舊數據但沒有用戶ID，提示登錄
                    if (loaded.stocks || loaded.capitalAdditions) {
                        console.log('檢測到舊數據，請先登錄以載入數據');
                    }
                } catch (e) {
                    console.error('載入數據失敗:', e);
                }
            }
            
            // 載入所有用戶數據用於排行榜
            loadAllUsersForLeaderboard();
        }
        
        // 載入所有用戶數據（用於排行榜）
        function loadAllUsersForLeaderboard() {
            allUsersData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('trading_user_')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        const userId = key.replace('trading_user_', '');
                        const profit = calculateUserTotalProfit(userData.dashboardData);
                        allUsersData[userId] = {
                            totalProfit: profit,
                            userId: userId
                        };
                    } catch (e) {
                        console.error('載入用戶數據失敗:', key, e);
                    }
                }
            }
            updateLeaderboard();
        }
        
        // 計算用戶總盈利
        function calculateUserTotalProfit(userDashboardData) {
            if (!userDashboardData) return 0;
            
            let realizedPnL = 0;
            let unrealizedPnL = 0;
            
            if (!userDashboardData.stocks) return 0;
            
            Object.keys(userDashboardData.stocks).forEach(symbol => {
                const stock = userDashboardData.stocks[symbol];
                
                // 計算已實現損益
                let buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                realizedPnL += buyQueue[0].shares * (op.price - buyQueue[0].price);
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                realizedPnL += remaining * (op.price - buyQueue[0].price);
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });
                
                // 期權已實現損益
                stock.calls.forEach(call => {
                    if (call.closed && call.closePrice !== undefined) {
                        realizedPnL += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (put.closed && put.closePrice !== undefined) {
                        realizedPnL += (put.premium - put.closePrice) * 100;
                    }
                });
            });
            
            return realizedPnL + unrealizedPnL;
        }
        
        // 更新排行榜
        function updateLeaderboard() {
            loadAllUsersForLeaderboard();
            
            // 排序獲取前三名
            const sortedUsers = Object.values(allUsersData)
                .sort((a, b) => b.totalProfit - a.totalProfit)
                .slice(0, 3);
            
            // 更新顯示
            for (let i = 0; i < 3; i++) {
                const leaderId = `leader-${i + 1}`;
                const leaderAmountId = `leader-${i + 1}-amount`;
                
                if (sortedUsers[i]) {
                    document.getElementById(leaderId).textContent = sortedUsers[i].userId;
                    document.getElementById(leaderAmountId).textContent = `$${sortedUsers[i].totalProfit.toFixed(2)}`;
                } else {
                    document.getElementById(leaderId).textContent = '-';
                    document.getElementById(leaderAmountId).textContent = '$0.00';
                }
            }
            
            // 更新當前用戶的總盈利
            if (dashboardData.userId) {
                const currentUserProfit = calculateUserTotalProfit(dashboardData);
                document.getElementById('user-total-profit').textContent = `$${currentUserProfit.toFixed(2)}`;
            }
        }
        
        // 載入價格
        function loadPrices() {
            const saved = localStorage.getItem('tradingPrices');
            if (saved) {
                currentPrices = JSON.parse(saved);
            }
        }
        
        // 更新股票選擇下拉框
        function updateStockSelect() {
            const select = document.getElementById('stock-select');
            const callSelect = document.getElementById('exercise-call-select');
            const currentValue = select.value;
            
            if (!select || !callSelect) return;
            
            select.innerHTML = '<option value="">-- 選擇股票 --</option>';
            callSelect.innerHTML = '<option value="">選擇被行使的Call</option>';
            
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
                
                // 更新Call選擇框
                const stock = dashboardData.stocks[symbol];
                if (stock && stock.calls) {
                    const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                    openCalls.forEach(call => {
                        const callOption = document.createElement('option');
                        callOption.value = `${symbol}_${call.id}`;
                        callOption.textContent = `${symbol} $${call.strike} Call (${call.expiry})`;
                        callSelect.appendChild(callOption);
                    });
                }
            });
            
            if (currentValue && dashboardData.stocks[currentValue]) {
                select.value = currentValue;
            }
        }
        
        // 添加資金
        function addCapital() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            const amount = parseFloat(document.getElementById('add-capital').value);
            if (amount > 0) {
                // 保存快照
                saveOperationSnapshot('addCapital', {amount: amount});
                
                if (!dashboardData.capitalAdditions) {
                    dashboardData.capitalAdditions = [];
                }
                dashboardData.capitalAdditions.push({
                    amount: amount,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now()
                });
                document.getElementById('add-capital').value = '';
                updateAvailableCash();
                updateDisplay();
                saveData();
                alert(`已成功添加資金 $${amount.toFixed(2)}！`);
            } else {
                alert('請輸入有效的金額');
            }
        }
        
        // 新增股票
        function addNewStock() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            const symbol = document.getElementById('stock-symbol').value.trim().toUpperCase();
            if (!symbol) {
                alert('請輸入股票代號');
                return;
            }
            
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            if (!dashboardData.stocks[symbol]) {
                // 保存快照
                saveOperationSnapshot('addStock', {symbol: symbol});
                
                dashboardData.stocks[symbol] = {
                    operations: [],
                    calls: [],
                    puts: [],
                    buyCalls: [],
                    buyPuts: []
                };
                currentStock = symbol;
                updateStockSelect();
                document.getElementById('stock-select').value = symbol;
                document.getElementById('stock-symbol').value = '';
                updateDisplay();
                saveData();
                alert(`股票 ${symbol} 已成功新增！`);
            } else {
                // 如果已存在，直接選擇它
                currentStock = symbol;
                document.getElementById('stock-select').value = symbol;
                updateDisplay();
                alert(`股票 ${symbol} 已存在，已切換到該股票`);
            }
        }
        
        // 選擇股票
        function selectStock() {
            const symbol = document.getElementById('stock-select').value;
            if (symbol && dashboardData.stocks[symbol]) {
                currentStock = symbol;
                updateDisplay();
            }
        }
        
        // 獲取當前股票數據
        function getCurrentStockData() {
            if (!currentStock || !dashboardData.stocks[currentStock]) {
                return null;
            }
            return dashboardData.stocks[currentStock];
        }

        // 保存數據到localStorage（按用戶保存）
        function saveData() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            const userKey = `trading_user_${dashboardData.userId}`;
            const userData = localStorage.getItem(userKey);
            
            if (userData) {
                const parsed = JSON.parse(userData);
                parsed.dashboardData = dashboardData;
                parsed.updatedAt = new Date().toISOString();
                localStorage.setItem(userKey, JSON.stringify(parsed));
            } else {
                // 如果沒有用戶數據，創建新的
                const newUserData = {
                    password: '',  // 密碼不會在這裡更新
                    dashboardData: dashboardData,
                    updatedAt: new Date().toISOString()
                };
                localStorage.setItem(userKey, JSON.stringify(newUserData));
            }
            
            savePrices();
            updateLeaderboard();
            alert('數據已保存！');
        }
        
        // 保存操作快照（用於撤銷）
        function saveOperationSnapshot(operationType, operationData) {
            if (operationHistory.length >= maxHistorySize) {
                operationHistory.shift(); // 移除最舊的操作
            }
            
            // 創建當前狀態的深拷貝
            const snapshot = JSON.parse(JSON.stringify({
                dashboardData: JSON.parse(JSON.stringify(dashboardData)),
                currentStock: currentStock,
                currentPrices: JSON.parse(JSON.stringify(currentPrices))
            }));
            
            operationHistory.push({
                type: operationType,
                data: operationData,
                snapshot: snapshot,
                timestamp: Date.now()
            });
            
            // 更新撤銷按鈕狀態
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = false;
            }
        }
        
        // 撤銷上一步操作
        function undoLastOperation() {
            if (operationHistory.length === 0) {
                alert('沒有可撤銷的操作');
                return;
            }
            
            const lastOperation = operationHistory.pop();
            
            // 恢復快照
            dashboardData = JSON.parse(JSON.stringify(lastOperation.snapshot.dashboardData));
            currentStock = lastOperation.snapshot.currentStock;
            currentPrices = JSON.parse(JSON.stringify(lastOperation.snapshot.currentPrices));
            
            // 更新顯示
            updateStockSelect();
            if (currentStock) {
                document.getElementById('stock-select').value = currentStock;
            }
            updateDisplay();
            updateAvailableCash();
            saveData();
            
            // 更新撤銷按鈕狀態
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = operationHistory.length === 0;
            }
            
            alert(`已撤銷：${lastOperation.type}`);
        }

        // 添加買入操作
        function addBuyOperation() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            if (!currentStock) {
                alert('請先選擇或新增股票');
                return;
            }
            
            const stockData = getCurrentStockData();
            const shares = parseInt(document.getElementById('buy-shares').value);
            const price = parseFloat(document.getElementById('buy-price').value);
            
            if (!shares || !price) {
                alert('請輸入完整的買入信息');
                return;
            }

            const operation = {
                type: 'buy',
                shares: shares,
                price: price,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: currentStock
            };

            // 保存快照
            saveOperationSnapshot('buy', operation);

            stockData.operations.push(operation);

            document.getElementById('buy-shares').value = '';
            document.getElementById('buy-price').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // 添加賣出操作
        function addSellOperation() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            if (!currentStock) {
                alert('請先選擇或新增股票');
                return;
            }
            
            const stockData = getCurrentStockData();
            const shares = parseInt(document.getElementById('sell-shares').value);
            const price = parseFloat(document.getElementById('sell-price').value);
            
            if (!shares || !price) {
                alert('請輸入完整的賣出信息');
                return;
            }

            const operation = {
                type: 'sell',
                shares: shares,
                price: price,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: currentStock
            };

            // 保存快照
            saveOperationSnapshot('sell', operation);

            stockData.operations.push(operation);

            document.getElementById('sell-shares').value = '';
            document.getElementById('sell-price').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // 添加賣Call操作
        function addCallOperation() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            if (!currentStock) {
                alert('請先選擇或新增股票');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('call-strike').value);
            const premium = parseFloat(document.getElementById('call-premium').value);
            const expiry = document.getElementById('call-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('請輸入完整的Call信息');
                return;
            }

            const call = {
                strike: strike,
                premium: premium,
                expiry: expiry,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                closed: false,
                symbol: currentStock,
                exercised: false
            };

            // 保存快照
            saveOperationSnapshot('sellCall', call);

            stockData.calls.push(call);

            document.getElementById('call-strike').value = '';
            document.getElementById('call-premium').value = '';
            document.getElementById('call-expiry').value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // 添加買入Call操作（平倉）
        function addBuyCallOperation() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            if (!currentStock) {
                alert('請先選擇或新增股票');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('buy-call-strike').value);
            const premium = parseFloat(document.getElementById('buy-call-premium').value);
            const expiry = document.getElementById('buy-call-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('請輸入完整的Call信息');
                return;
            }

            const operationData = {strike, premium, expiry, symbol: currentStock};

            // 保存快照
            saveOperationSnapshot('buyCall', operationData);

            // 尋找匹配的賣Call來平倉
            const matchingCall = stockData.calls.find(c => 
                !c.closed && 
                !c.exercised &&
                Math.abs(c.strike - strike) < 0.01 && 
                c.expiry === expiry
            );

            if (matchingCall) {
                matchingCall.closed = true;
                matchingCall.closePrice = premium;
                matchingCall.closeDate = new Date().toLocaleDateString('zh-TW');
            } else {
                // 如果沒有匹配的，記錄為買入Call（可能是新的開倉）
                stockData.buyCalls.push({
                    strike: strike,
                    premium: premium,
                    expiry: expiry,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now(),
                    symbol: currentStock
                });
            }

            document.getElementById('buy-call-strike').value = '';
            document.getElementById('buy-call-premium').value = '';
            document.getElementById('buy-call-expiry').value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // 添加賣Put操作
        function addPutOperation() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            if (!currentStock) {
                alert('請先選擇或新增股票');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('put-strike').value);
            const premium = parseFloat(document.getElementById('put-premium').value);
            const expiry = document.getElementById('put-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('請輸入完整的Put信息');
                return;
            }

            const put = {
                strike: strike,
                premium: premium,
                expiry: expiry,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                closed: false,
                symbol: currentStock,
                exercised: false
            };

            // 保存快照
            saveOperationSnapshot('sellPut', put);

            stockData.puts.push(put);

            document.getElementById('put-strike').value = '';
            document.getElementById('put-premium').value = '';
            document.getElementById('put-expiry').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // 添加買入Put操作（平倉）
        function addBuyPutOperation() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            if (!currentStock) {
                alert('請先選擇或新增股票');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('buy-put-strike').value);
            const premium = parseFloat(document.getElementById('buy-put-premium').value);
            const expiry = document.getElementById('buy-put-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('請輸入完整的Put信息');
                return;
            }

            const operationData = {strike, premium, expiry, symbol: currentStock};

            // 保存快照
            saveOperationSnapshot('buyPut', operationData);

            // 尋找匹配的賣Put來平倉
            const matchingPut = stockData.puts.find(p => 
                !p.closed && 
                !p.exercised &&
                Math.abs(p.strike - strike) < 0.01 && 
                p.expiry === expiry
            );

            if (matchingPut) {
                matchingPut.closed = true;
                matchingPut.closePrice = premium;
                matchingPut.closeDate = new Date().toLocaleDateString('zh-TW');
            } else {
                // 如果沒有匹配的，記錄為買入Put（可能是新的開倉）
                stockData.buyPuts.push({
                    strike: strike,
                    premium: premium,
                    expiry: expiry,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now(),
                    symbol: currentStock
                });
            }

            document.getElementById('buy-put-strike').value = '';
            document.getElementById('buy-put-premium').value = '';
            document.getElementById('buy-put-expiry').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        
        // Call被行使
        function exerciseCall() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            if (!currentStock) {
                alert('請先選擇股票');
                return;
            }
            
            const select = document.getElementById('exercise-call-select');
            const exercisePrice = parseFloat(document.getElementById('exercise-price').value);
            
            if (!select.value || !exercisePrice) {
                alert('請選擇Call並輸入行使價格');
                return;
            }
            
            const [symbol, callId] = select.value.split('_');
            const stockData = dashboardData.stocks[symbol];
            if (!stockData) return;
            
            const call = stockData.calls.find(c => c.id == callId);
            if (!call || call.exercised || call.closed) {
                alert('該Call已被行使或已平倉');
                return;
            }
            
            // 保存快照
            saveOperationSnapshot('exerciseCall', {symbol, callId, exercisePrice});
            
            // 標記為已行使
            call.exercised = true;
            call.exercisePrice = exercisePrice;
            call.exerciseDate = new Date().toLocaleDateString('zh-TW');
            
            // 自動減少股票持倉（100股，因為1口Call = 100股）
            stockData.operations.push({
                type: 'sell',
                shares: 100,
                price: call.strike,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: symbol,
                reason: `Call被行使 (${call.strike} Call)`
            });
            
            alert(`${symbol} $${call.strike} Call已被行使，已自動賣出100股 @ $${call.strike}`);
            document.getElementById('exercise-price').value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        
        // Put被行使
        function exercisePut() {
            if (!dashboardData.userId) {
                alert('請先登錄');
                return;
            }
            
            if (!currentStock) {
                alert('請先選擇股票');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(prompt('請輸入被行使的Put行權價：'));
            const exercisePrice = parseFloat(prompt('請輸入行使價格（通常等於行權價）：'));
            
            if (!strike || !exercisePrice) {
                return;
            }
            
            const put = stockData.puts.find(p => 
                !p.exercised && 
                !p.closed && 
                Math.abs(p.strike - strike) < 0.01
            );
            
            if (!put) {
                alert('找不到匹配的Put');
                return;
            }
            
            // 保存快照
            saveOperationSnapshot('exercisePut', {strike, exercisePrice, symbol: currentStock});
            
            // 標記為已行使
            put.exercised = true;
            put.exercisePrice = exercisePrice;
            put.exerciseDate = new Date().toLocaleDateString('zh-TW');
            
            // 自動增加股票持倉（100股，因為1口Put = 100股）
            stockData.operations.push({
                type: 'buy',
                shares: 100,
                price: put.strike,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: currentStock,
                reason: `Put被行使 (${put.strike} Put)`
            });
            
            alert(`${currentStock} $${put.strike} Put已被行使，已自動買入100股 @ $${put.strike}`);
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        
        // 更新股價
        function updateStockPrice() {
            const price = parseFloat(document.getElementById('current-stock-price').value);
            if (price > 0 && currentStock) {
                if (!currentPrices.stocks[currentStock]) {
                    currentPrices.stocks[currentStock] = {stock: 0, calls: {}, puts: {}};
                }
                currentPrices.stocks[currentStock].stock = price;
                savePrices();
                updatePnL();
                updateDisplay();
            }
        }

        // 清除所有數據
        function clearAll() {
            if (confirm('確定要清除所有數據嗎？')) {
                dashboardData = {
                    capitalAdditions: [],
                    stocks: {}
                };
                currentPrices = {
                    stocks: {}
                };
                currentStock = '';
                operationHistory = [];
                document.getElementById('stock-symbol').value = '';
                document.getElementById('current-stock-price').value = '';
                document.getElementById('add-capital').value = '';
                updateStockSelect();
                
                // 清除持倉總覽
                const overviewDiv = document.getElementById('all-positions-overview');
                if (overviewDiv) {
                    overviewDiv.innerHTML = '<p style="color: #999; font-style: italic;">請輸入持倉數據</p>';
                }
                
                localStorage.removeItem('tradingDashboard');
                localStorage.removeItem('tradingPrices');
                updateDisplay();
            }
        }

        // 更新顯示
        function updateDisplay() {
            if (!currentStock || !dashboardData.stocks[currentStock]) {
                // 沒有選中股票，顯示空狀態
                document.getElementById('total-shares').textContent = '0';
                document.getElementById('avg-cost').textContent = '0.00';
                document.getElementById('current-stage').textContent = '未選擇股票';
                document.getElementById('decision-node').textContent = '請先選擇或新增股票';
                document.getElementById('stock-positions').innerHTML = '<p style="color: #999; font-style: italic; font-size: 0.9em;">無股票持倉</p>';
                document.getElementById('call-positions').innerHTML = '<p style="color: #999; font-style: italic; font-size: 0.9em;">無Call持倉</p>';
                document.getElementById('put-positions').innerHTML = '<p style="color: #999; font-style: italic; font-size: 0.9em;">無Put持倉</p>';
                updateAvailableCash();
                updatePnL();
                generateTasks(0, 0, [], []);
                updateHistory();
                return;
            }

            const stockData = getCurrentStockData();
            
            // 計算總持股數和平均成本（使用FIFO方法）
            let totalShares = 0;
            let totalCost = 0;
            let buyQueue = [];
            
            stockData.operations.forEach(op => {
                if (op.type === 'buy') {
                    buyQueue.push({shares: op.shares, price: op.price});
                    totalShares += op.shares;
                    totalCost += op.shares * op.price;
                } else if (op.type === 'sell') {
                    let remaining = op.shares;
                    while (remaining > 0 && buyQueue.length > 0) {
                        if (buyQueue[0].shares <= remaining) {
                            remaining -= buyQueue[0].shares;
                            totalCost -= buyQueue[0].shares * buyQueue[0].price;
                            totalShares -= buyQueue[0].shares;
                            buyQueue.shift();
                        } else {
                            totalCost -= remaining * buyQueue[0].price;
                            totalShares -= remaining;
                            buyQueue[0].shares -= remaining;
                            remaining = 0;
                        }
                    }
                }
            });

            const avgCost = totalShares > 0 ? (totalCost / totalShares).toFixed(2) : 0;

            // 更新狀態顯示
            document.getElementById('total-shares').textContent = totalShares;
            document.getElementById('avg-cost').textContent = avgCost;

            // 判斷當前階段和決策樹節點
            const openCalls = stockData.calls.filter(c => !c.closed && !c.exercised);
            const openPuts = stockData.puts.filter(p => !p.closed && !p.exercised);
            const stage = determineStage(totalShares, openCalls, openPuts);
            document.getElementById('current-stage').textContent = stage.stage;
            document.getElementById('decision-node').textContent = stage.node;

            // 更新未平倉持倉顯示
            updatePositions(currentStock, totalShares, avgCost, openCalls, openPuts);

            // 更新所有持倉總覽
            updateAllPositionsOverview();

            // 更新可用資金
            updateAvailableCash();

            // 計算損益
            updatePnL();

            // 生成任務清單
            generateTasks(currentStock, totalShares, avgCost, openCalls, openPuts);

            // 更新操作歷史
            updateHistory();
        }
        
        // 更新所有持倉總覽（包含即時價格輸入）
        function updateAllPositionsOverview() {
            const overviewDiv = document.getElementById('all-positions-overview');
            if (!overviewDiv) return;
            
            const allPositions = [];
            
            // 遍歷所有股票
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                // 計算股票持倉
                let shares = 0;
                let cost = 0;
                let buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                        shares += op.shares;
                        cost += op.shares * op.price;
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                shares -= buyQueue[0].shares;
                                cost -= buyQueue[0].shares * buyQueue[0].price;
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                shares -= remaining;
                                cost -= remaining * buyQueue[0].price;
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });
                const avgCost = shares > 0 ? cost / shares : 0;
                const stockPrice = currentPrices.stocks[symbol]?.stock || 0;
                const stockValue = stockPrice > 0 ? stockPrice * shares : avgCost * shares;
                const stockPnL = stockPrice > 0 ? (stockPrice - avgCost) * shares : 0;
                
                if (shares > 0) {
                    allPositions.push({
                        type: 'stock',
                        symbol: symbol,
                        shares: shares,
                        avgCost: avgCost,
                        currentPrice: stockPrice,
                        value: stockValue,
                        pnl: stockPnL,
                        id: `stock_${symbol}`
                    });
                }
                
                // Call持倉（賣出Call，損益要反過來）
                const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                openCalls.forEach(call => {
                    const key = `${call.strike}_${call.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.calls?.[key] || call.premium;
                    // 賣出Call：價格下跌是盈利，價格上漲是虧損（損益反過來）
                    const callPnL = (call.premium - currentPrice) * 100; // 賣出時：premium - currentPrice
                    
                    allPositions.push({
                        type: 'call',
                        symbol: symbol,
                        strike: call.strike,
                        expiry: call.expiry,
                        premium: call.premium,
                        currentPrice: currentPrice,
                        value: currentPrice * 100,
                        pnl: callPnL,
                        id: call.id
                    });
                });
                
                // Put持倉（賣出Put，損益要反過來）
                const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                openPuts.forEach(put => {
                    const key = `${put.strike}_${put.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.puts?.[key] || put.premium;
                    // 賣出Put：價格下跌是盈利，價格上漲是虧損（損益反過來）
                    const putPnL = (put.premium - currentPrice) * 100; // 賣出時：premium - currentPrice
                    
                    allPositions.push({
                        type: 'put',
                        symbol: symbol,
                        strike: put.strike,
                        expiry: put.expiry,
                        premium: put.premium,
                        currentPrice: currentPrice,
                        value: currentPrice * 100,
                        pnl: putPnL,
                        id: put.id
                    });
                });
            });
            
            if (allPositions.length === 0) {
                overviewDiv.innerHTML = '<p style="color: #999; font-style: italic;">無持倉</p>';
            } else {
                overviewDiv.innerHTML = allPositions.map(pos => {
                    const pnlColor = pos.pnl >= 0 ? '#4caf50' : '#f44336';
                    if (pos.type === 'stock') {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} 股票</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">${pos.shares}股 @ $${pos.avgCost.toFixed(2)}</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="stock-price-${pos.symbol}" value="${pos.currentPrice > 0 ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="輸入即時股價" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updateStockPriceFromOverview('${pos.symbol}')" style="padding: 6px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">更新</button>
                                </div>
                                ${pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="font-size: 0.9em;">市值: $${pos.value.toFixed(2)}</span> | 
                                        <span style="color: ${pnlColor}; font-weight: bold;">未實現損益: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">請輸入即時股價查看損益</div>'}
                            </div>
                        `;
                    } else if (pos.type === 'call') {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} $${pos.strike} Call</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">賣出 @ $${pos.premium.toFixed(2)}/股</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="call-price-${pos.id}" value="${pos.currentPrice !== pos.premium ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="輸入即時價（每股）" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updateCallPriceFromOverview('${pos.symbol}', ${pos.strike}, '${pos.expiry}', ${pos.id})" style="padding: 6px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">更新</button>
                                </div>
                                ${pos.currentPrice !== pos.premium || pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="color: ${pnlColor}; font-weight: bold;">未實現損益: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">請輸入即時價格查看損益</div>'}
                                <div style="margin-top: 5px; font-size: 0.85em; color: #666;">到期: ${pos.expiry}</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} $${pos.strike} Put</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">賣出 @ $${pos.premium.toFixed(2)}/股</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="put-price-${pos.id}" value="${pos.currentPrice !== pos.premium ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="輸入即時價（每股）" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updatePutPriceFromOverview('${pos.symbol}', ${pos.strike}, '${pos.expiry}', ${pos.id})" style="padding: 6px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">更新</button>
                                </div>
                                ${pos.currentPrice !== pos.premium || pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="color: ${pnlColor}; font-weight: bold;">未實現損益: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">請輸入即時價格查看損益</div>'}
                                <div style="margin-top: 5px; font-size: 0.85em; color: #666;">到期: ${pos.expiry}</div>
                            </div>
                        `;
                    }
                }).join('');
            }
        }
        
        // 從持倉總覽更新股票價格
        function updateStockPriceFromOverview(symbol) {
            const input = document.getElementById(`stock-price-${symbol}`);
            const price = parseFloat(input.value);
            if (price > 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                currentPrices.stocks[symbol].stock = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('請輸入有效的價格');
            }
        }
        
        // 從持倉總覽更新Call價格
        function updateCallPriceFromOverview(symbol, strike, expiry, callId) {
            const input = document.getElementById(`call-price-${callId}`);
            const price = parseFloat(input.value);
            if (price >= 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                if (!currentPrices.stocks[symbol].calls) {
                    currentPrices.stocks[symbol].calls = {};
                }
                currentPrices.stocks[symbol].calls[`${strike}_${expiry}`] = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('請輸入有效的價格');
            }
        }
        
        // 從持倉總覽更新Put價格
        function updatePutPriceFromOverview(symbol, strike, expiry, putId) {
            const input = document.getElementById(`put-price-${putId}`);
            const price = parseFloat(input.value);
            if (price >= 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                if (!currentPrices.stocks[symbol].puts) {
                    currentPrices.stocks[symbol].puts = {};
                }
                currentPrices.stocks[symbol].puts[`${strike}_${expiry}`] = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('請輸入有效的價格');
            }
        }
        
        // 更新可用資金
        function updateAvailableCash() {
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            // 計算所有添加的資金
            let totalCash = 0;
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                totalCash = dashboardData.capitalAdditions.reduce((sum, addition) => sum + addition.amount, 0);
            }
            
            // 計算所有股票的現金流
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                // 股票買賣現金流
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        totalCash -= op.shares * op.price;
                    } else if (op.type === 'sell') {
                        totalCash += op.shares * op.price;
                    }
                });
                
                // 期權權利金（賣出時收到權利金，買回時支付）
                stock.calls.forEach(call => {
                    if (!call.closed && !call.exercised) {
                        // 未平倉的賣Call，已收到權利金
                        totalCash += call.premium * 100;
                    } else if (call.closed) {
                        // 已平倉，計算淨損益
                        totalCash += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (!put.closed && !put.exercised) {
                        // 未平倉的賣Put，已收到權利金
                        totalCash += put.premium * 100;
                    } else if (put.closed) {
                        // 已平倉，計算淨損益
                        totalCash += (put.premium - put.closePrice) * 100;
                    }
                });
                
                // 買入的Call/Put（開倉時支付權利金）
                stock.buyCalls.forEach(buyCall => {
                    totalCash -= buyCall.premium * 100;
                });
                
                stock.buyPuts.forEach(buyPut => {
                    totalCash -= buyPut.premium * 100;
                });
            });
            
            const cashElement = document.getElementById('available-cash');
            if (cashElement) {
                cashElement.textContent = `$${totalCash.toFixed(2)}`;
            }
        }

        // 更新未平倉持倉顯示
        function updatePositions(symbol, shares, avgCost, openCalls, openPuts) {
            // 股票持倉
            const stockDiv = document.getElementById('stock-positions');
            if (shares > 0) {
                const stockPrice = currentPrices.stocks[symbol]?.stock || 0;
                stockDiv.innerHTML = `
                    <div style="padding: 10px; background: #e3f2fd; border-radius: 6px; margin-bottom: 5px;">
                        <strong>${symbol}: ${shares} 股</strong><br>
                        <span style="font-size: 0.9em; color: #666;">平均成本: $${avgCost}</span>
                        ${stockPrice > 0 ? `<br><span style="font-size: 0.9em; color: #666;">即時價格: $${stockPrice.toFixed(2)}</span>` : ''}
                    </div>
                `;
            } else {
                stockDiv.innerHTML = '<p style="color: #999; font-style: italic; font-size: 0.9em;">無股票持倉</p>';
            }

            // Call持倉
            const callDiv = document.getElementById('call-positions');
            if (openCalls.length > 0) {
                callDiv.innerHTML = openCalls.map(call => {
                    const key = `${symbol}_${call.strike}_${call.expiry}`;
                    const stockPriceData = currentPrices.stocks[symbol];
                    const currentPrice = stockPriceData?.calls?.[`${call.strike}_${call.expiry}`] || call.premium;
                    const pnl = (call.premium - currentPrice).toFixed(2);
                    const pnlColor = pnl >= 0 ? '#4caf50' : '#f44336';
                    return `
                        <div style="padding: 10px; background: #fff3e0; border-radius: 6px; margin-bottom: 5px;">
                            <strong>${symbol} $${call.strike} Call</strong><br>
                            <span style="font-size: 0.85em;">賣出: $${call.premium.toFixed(2)}/股</span><br>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 5px;">
                                <input type="number" id="call-price-${call.id}" value="${currentPrice}" step="0.01" placeholder="即時價（每股）" style="padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.85em;">
                                <button onclick="updateCallPrice('${symbol}', '${call.strike}', '${call.expiry}', document.getElementById('call-price-${call.id}').value)" style="padding: 4px; background: #2196f3; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;">更新</button>
                            </div>
                            <span style="font-size: 0.85em; color: ${pnlColor}; font-weight: bold;">損益: $${pnl}/股</span><br>
                            <span style="font-size: 0.8em; color: #999;">到期: ${call.expiry}</span>
                        </div>
                    `;
                }).join('');
            } else {
                callDiv.innerHTML = '<p style="color: #999; font-style: italic; font-size: 0.9em;">無Call持倉</p>';
            }

            // Put持倉
            const putDiv = document.getElementById('put-positions');
            if (openPuts.length > 0) {
                putDiv.innerHTML = openPuts.map(put => {
                    const key = `${symbol}_${put.strike}_${put.expiry}`;
                    const stockPriceData = currentPrices.stocks[symbol];
                    const currentPrice = stockPriceData?.puts?.[`${put.strike}_${put.expiry}`] || put.premium;
                    const pnl = (put.premium - currentPrice).toFixed(2);
                    const pnlColor = pnl >= 0 ? '#4caf50' : '#f44336';
                    return `
                        <div style="padding: 10px; background: #ffebee; border-radius: 6px; margin-bottom: 5px;">
                            <strong>${symbol} $${put.strike} Put</strong><br>
                            <span style="font-size: 0.85em;">賣出: $${put.premium.toFixed(2)}/股</span><br>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 5px;">
                                <input type="number" id="put-price-${put.id}" value="${currentPrice}" step="0.01" placeholder="即時價（每股）" style="padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.85em;">
                                <button onclick="updatePutPrice('${symbol}', '${put.strike}', '${put.expiry}', document.getElementById('put-price-${put.id}').value)" style="padding: 4px; background: #2196f3; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;">更新</button>
                            </div>
                            <span style="font-size: 0.85em; color: ${pnlColor}; font-weight: bold;">損益: $${pnl}/股</span><br>
                            <span style="font-size: 0.8em; color: #999;">到期: ${put.expiry}</span>
                        </div>
                    `;
                }).join('');
            } else {
                putDiv.innerHTML = '<p style="color: #999; font-style: italic; font-size: 0.9em;">無Put持倉</p>';
            }
        }

        // 更新Call價格
        function updateCallPrice(symbol, strike, expiry, price) {
            if (!currentPrices.stocks[symbol]) {
                currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
            }
            if (!currentPrices.stocks[symbol].calls) {
                currentPrices.stocks[symbol].calls = {};
            }
            currentPrices.stocks[symbol].calls[`${strike}_${expiry}`] = parseFloat(price);
            savePrices();
            updatePnL();
            updateDisplay();
        }

        // 更新Put價格
        function updatePutPrice(symbol, strike, expiry, price) {
            if (!currentPrices.stocks[symbol]) {
                currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
            }
            if (!currentPrices.stocks[symbol].puts) {
                currentPrices.stocks[symbol].puts = {};
            }
            currentPrices.stocks[symbol].puts[`${strike}_${expiry}`] = parseFloat(price);
            savePrices();
            updatePnL();
            updateDisplay();
        }

        // 計算損益（支持多股票）
        function updatePnL() {
            let totalRealizedPnL = 0;
            let totalUnrealizedPnL = 0;
            
            // 計算可用資金（現金）
            let availableCash = 0;
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                availableCash = dashboardData.capitalAdditions.reduce((sum, addition) => sum + addition.amount, 0);
            }
            
            // 計算所有股票的現金流
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        availableCash -= op.shares * op.price;
                    } else if (op.type === 'sell') {
                        availableCash += op.shares * op.price;
                    }
                });
                
                // 期權權利金（賣出時收到，買回時支付）
                stock.calls.forEach(call => {
                    if (!call.closed && !call.exercised) {
                        availableCash += call.premium * 100; // 每口100股
                    } else if (call.closed) {
                        availableCash += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (!put.closed && !put.exercised) {
                        availableCash += put.premium * 100; // 每口100股
                    } else if (put.closed) {
                        availableCash += (put.premium - put.closePrice) * 100;
                    }
                });
                
                // 買入的Call/Put（開倉時支付權利金）
                stock.buyCalls.forEach(buyCall => {
                    availableCash -= buyCall.premium * 100;
                });
                
                stock.buyPuts.forEach(buyPut => {
                    availableCash -= buyPut.premium * 100;
                });
            });

            // 計算總資產價值 = 可用資金 + 所有股票市值 + 所有期權市值
            let totalAssets = availableCash;

            // 遍歷所有股票
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                let realizedPnL = 0;
                let unrealizedPnL = 0;
                
                // 股票已實現損益
                let buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                realizedPnL += buyQueue[0].shares * (op.price - buyQueue[0].price);
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                realizedPnL += remaining * (op.price - buyQueue[0].price);
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });

                // Call已實現損益
                stock.calls.forEach(call => {
                    if (call.closed && call.closePrice !== undefined) {
                        realizedPnL += (call.premium - call.closePrice) * 100;
                    }
                });

                // Put已實現損益
                stock.puts.forEach(put => {
                    if (put.closed && put.closePrice !== undefined) {
                        realizedPnL += (put.premium - put.closePrice) * 100;
                    }
                });

                // 計算當前股票持倉和成本
                let shares = 0;
                let cost = 0;
                buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                        shares += op.shares;
                        cost += op.shares * op.price;
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                shares -= buyQueue[0].shares;
                                cost -= buyQueue[0].shares * buyQueue[0].price;
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                shares -= remaining;
                                cost -= remaining * buyQueue[0].price;
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });
                const avgCost = shares > 0 ? cost / shares : 0;

                // 股票市值（加入總資產）
                const stockPrice = currentPrices.stocks[symbol]?.stock || 0;
                if (stockPrice > 0 && shares > 0) {
                    totalAssets += stockPrice * shares;
                    unrealizedPnL += (stockPrice - avgCost) * shares;
                } else if (shares > 0) {
                    totalAssets += avgCost * shares; // 如果沒有即時價格，使用成本價
                }

                // Call未實現損益和市值（賣出Call：價格下跌是盈利，價格上漲是虧損）
                const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                openCalls.forEach(call => {
                    const key = `${call.strike}_${call.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.calls?.[key] || call.premium;
                    const callValue = currentPrice * 100; // 每口100股
                    totalAssets -= callValue; // 賣出Call是負債，需要減去
                    // 賣出Call：premium - currentPrice（價格下跌是盈利）
                    unrealizedPnL += (call.premium - currentPrice) * 100;
                });

                // Put未實現損益和市值（賣出Put：價格下跌是盈利，價格上漲是虧損）
                const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                openPuts.forEach(put => {
                    const key = `${put.strike}_${put.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.puts?.[key] || put.premium;
                    const putValue = currentPrice * 100; // 每口100股
                    totalAssets -= putValue; // 賣出Put是負債，需要減去
                    // 賣出Put：premium - currentPrice（價格下跌是盈利）
                    unrealizedPnL += (put.premium - currentPrice) * 100;
                });

                totalRealizedPnL += realizedPnL;
                totalUnrealizedPnL += unrealizedPnL;
            });

            // 更新顯示
            const realizedColor = totalRealizedPnL >= 0 ? '#4caf50' : '#f44336';
            const unrealizedColor = totalUnrealizedPnL >= 0 ? '#4caf50' : '#f44336';
            
            document.getElementById('realized-pnl').textContent = `$${totalRealizedPnL.toFixed(2)}`;
            document.getElementById('realized-pnl').style.color = realizedColor;
            
            document.getElementById('unrealized-pnl').textContent = `$${totalUnrealizedPnL.toFixed(2)}`;
            document.getElementById('unrealized-pnl').style.color = unrealizedColor;
            
            document.getElementById('total-assets').textContent = `$${totalAssets.toFixed(2)}`;
        }

        // 判斷當前階段（使用未平倉的calls和puts）
        function determineStage(shares, calls, puts) {
            if (shares === 0) {
                return { stage: '未開始', node: '等待初始建倉' };
            }

            // 檢查是否有Strangle
            if (calls.length > 0 && puts.length > 0) {
                return { 
                    stage: '階段四：Strangle管理', 
                    node: '情境D1：Strangle管理分支' 
                };
            }

            // 檢查是否有Call
            if (calls.length > 0) {
                const latestCall = calls[calls.length - 1];
                const today = new Date();
                const expiry = new Date(latestCall.expiry);
                const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

                if (daysUntilExpiry > 3) {
                    return { 
                        stage: '階段二：週中管理', 
                        node: '監控GTC訂單（$5買回Call）' 
                    };
                } else {
                    return { 
                        stage: '階段三：結算前', 
                        node: `等待週五結算（剩餘${daysUntilExpiry}天）` 
                    };
                }
            }

            // 檢查是否有Put
            if (puts.length > 0) {
                return { 
                    stage: '階段四：只賣Put階段', 
                    node: '等待Put行權或過期' 
                };
            }

            // 只有持股
            if (shares === 150) {
                return { 
                    stage: '階段一：初始建倉', 
                    node: '需要賣出Covered Call' 
                };
            }

            return { 
                stage: '階段四：重啟階段', 
                node: '根據持倉決定下一步' 
            };
        }

        // 生成任務清單（支持多股票）
        function generateTasks(symbol, shares, avgCost, calls, puts) {
            const taskList = document.getElementById('task-list');
            const tasks = [];

            if (!symbol) {
                taskList.innerHTML = '<p style="color: #999; font-style: italic;">請先選擇或新增股票</p>';
                return;
            }

            if (shares === 0) {
                tasks.push(`📝 ${symbol}: 輸入初始買入操作（建議：150股 @ $11.00）`);
                tasks.push(`📝 ${symbol}: 輸入賣Call操作（建議：$12 Call）`);
            } else if (shares > 0 && calls.length === 0) {
                tasks.push(`⚠️ ${symbol}: 立即賣出Covered Call（建議：$12 Call）`);
                tasks.push(`📝 ${symbol}: 掛GTC訂單：以$5買回Call（鎖定90%利潤）`);
            } else if (calls.length > 0) {
                calls.forEach(call => {
                    const today = new Date();
                    const expiry = new Date(call.expiry);
                    const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    
                    tasks.push(`📊 ${symbol}: 監控$${call.strike} Call價格，當跌至$5時GTC訂單會自動成交`);
                    tasks.push(`⏰ ${symbol}: $${call.strike} Call距離到期還有 ${daysUntilExpiry} 天`);
                    
                    if (daysUntilExpiry <= 1) {
                        tasks.push(`⚠️ ${symbol}: 準備週五結算：檢查股價是否會超過$${call.strike}`);
                    }
                });

                if (calls.length > 0 && puts.length > 0) {
                    tasks.push(`🔄 ${symbol}: Strangle管理：監控Call和Put的價格變化`);
                    tasks.push(`📝 ${symbol}: 掛GTC訂單分別買回Call和Put（鎖定80-90%利潤）`);
                }
            }

            if (puts.length > 0 && calls.length === 0) {
                puts.forEach(put => {
                    tasks.push(`📊 ${symbol}: 監控$${put.strike} Put價格，準備在$${put.strike}行權時加倉`);
                });
            }

            // 添加所有股票的任務
            Object.keys(dashboardData.stocks).forEach(stockSymbol => {
                if (stockSymbol !== symbol) {
                    const stock = dashboardData.stocks[stockSymbol];
                    const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                    const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                    
                    if (openCalls.length > 0) {
                        openCalls.forEach(call => {
                            tasks.push(`📊 ${stockSymbol}: 監控$${call.strike} Call`);
                        });
                    }
                    if (openPuts.length > 0) {
                        openPuts.forEach(put => {
                            tasks.push(`📊 ${stockSymbol}: 監控$${put.strike} Put`);
                        });
                    }
                }
            });

            if (tasks.length === 0) {
                taskList.innerHTML = '<p style="color: #999; font-style: italic;">請輸入持倉數據以生成任務</p>';
            } else {
                taskList.innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">' + 
                    tasks.map(task => `<li style="padding: 10px; margin: 4px 0; background: #f0f0f0; border-radius: 4px; min-height: 45px; display: flex; align-items: center;">${task}</li>`).join('') + 
                    '</ul>';
            }
        }
        

        // 更新操作歷史（支持多股票）
        function updateHistory() {
            const historyDiv = document.getElementById('operation-history');
            const allOps = [];

            // 添加資金記錄
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                dashboardData.capitalAdditions.forEach(addition => {
                    allOps.push({
                        type: '添加資金',
                        desc: `$${addition.amount.toFixed(2)}`,
                        date: addition.date
                    });
                });
            }

            // 遍歷所有股票的操作
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                stock.operations.forEach(op => {
                    allOps.push({
                        type: op.type === 'buy' ? '買入' : '賣出',
                        desc: `${symbol}: ${op.shares}股 @ $${op.price.toFixed(2)}${op.reason ? ` (${op.reason})` : ''}`,
                        date: op.date
                    });
                });

                stock.calls.forEach(call => {
                    if (call.exercised) {
                        allOps.push({
                            type: 'Call被行使',
                            desc: `${symbol} $${call.strike.toFixed(2)} Call被行使，自動賣出100股 @ $${call.strike}`,
                            date: call.exerciseDate
                        });
                    } else if (call.closed) {
                        allOps.push({
                            type: '賣Call（已平倉）',
                            desc: `${symbol} $${call.strike.toFixed(2)} Call，賣出 $${call.premium.toFixed(2)}，買回 $${call.closePrice.toFixed(2)}，損益 $${((call.premium - call.closePrice) * 100).toFixed(2)}`,
                            date: call.closeDate
                        });
                    } else {
                        allOps.push({
                            type: '賣Call',
                            desc: `${symbol} $${call.strike.toFixed(2)} Call，權利金 $${call.premium.toFixed(2)}`,
                            date: call.date
                        });
                    }
                });

                stock.puts.forEach(put => {
                    if (put.exercised) {
                        allOps.push({
                            type: 'Put被行使',
                            desc: `${symbol} $${put.strike.toFixed(2)} Put被行使，自動買入100股 @ $${put.strike}`,
                            date: put.exerciseDate
                        });
                    } else if (put.closed) {
                        allOps.push({
                            type: '賣Put（已平倉）',
                            desc: `${symbol} $${put.strike.toFixed(2)} Put，賣出 $${put.premium.toFixed(2)}，買回 $${put.closePrice.toFixed(2)}，損益 $${((put.premium - put.closePrice) * 100).toFixed(2)}`,
                            date: put.closeDate
                        });
                    } else {
                        allOps.push({
                            type: '賣Put',
                            desc: `${symbol} $${put.strike.toFixed(2)} Put，權利金 $${put.premium.toFixed(2)}`,
                            date: put.date
                        });
                    }
                });
            });

            // 按日期排序（最新的在前）
            allOps.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allOps.length === 0) {
                historyDiv.innerHTML = '<p style="color: #999; font-style: italic;">尚無操作記錄</p>';
            } else {
                historyDiv.innerHTML = '<ul style="list-style: none; padding: 0;">' + 
                    allOps.map(op => 
                        `<li style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-left: 3px solid #3498db; border-radius: 4px;">
                            <strong>${op.type}</strong> - ${op.desc} <span style="color: #999; font-size: 0.9em;">(${op.date})</span>
                        </li>`
                    ).join('') + 
                    '</ul>';
            }
        }

        // 監聽股票代號輸入
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            const symbolInput = document.getElementById('stock-symbol');
            if (symbolInput) {
                symbolInput.value = dashboardData.stockSymbol;
                symbolInput.addEventListener('blur', function() {
                    dashboardData.stockSymbol = this.value;
                    saveData();
                });
            }

            // 定期更新顯示（每30秒）
            setInterval(updateDisplay, 30000);
            
            // 載入保存的價格
            const savedPrices = localStorage.getItem('tradingPrices');
            if (savedPrices) {
                currentPrices = JSON.parse(savedPrices);
                if (currentStock && currentPrices.stocks[currentStock]?.stock) {
                    document.getElementById('current-stock-price').value = currentPrices.stocks[currentStock].stock;
                }
            }
            
            // 初始化時更新排行榜
            updateLeaderboard();
        });

        // 保存價格到localStorage
        function savePrices() {
            if (currentStock) {
                const stockPrice = parseFloat(document.getElementById('current-stock-price').value) || 0;
                if (stockPrice > 0) {
                    if (!currentPrices.stocks[currentStock]) {
                        currentPrices.stocks[currentStock] = {stock: 0, calls: {}, puts: {}};
                    }
                    currentPrices.stocks[currentStock].stock = stockPrice;
                }
            }
            localStorage.setItem('tradingPrices', JSON.stringify(currentPrices));
        }

        // 當股價改變時保存
        document.addEventListener('DOMContentLoaded', function() {
            const stockPriceInput = document.getElementById('current-stock-price');
            if (stockPriceInput) {
                stockPriceInput.addEventListener('blur', function() {
                    savePrices();
                    updatePnL();
                });
            }
        });
    </script>
</body>
</html>

