<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜²å®ˆå‹å¥—åˆ©-ç´°ç¯€æ±ºç­–æ¨¹ - 150è‚¡æ¨¡å‹</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .section h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .section h3 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-size: 20px;
        }
        
        .mermaid {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .action-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .result-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .risk-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .param-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .param-item strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
        }
        
        ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 14px;
            }
            
            .section {
                padding: 20px;
                margin: 30px 0;
            }
            
            .section h2 {
                font-size: 20px;
            }
            
            .section h3 {
                font-size: 18px;
            }
            
            .mermaid {
                padding: 10px;
            }
            
            .parameters {
                grid-template-columns: 1fr;
            }
            
            /* å„€è¡¨æ¿éŸ¿æ‡‰å¼ */
            .section > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            .section input, .section button {
                font-size: 14px;
            }
        }
        
        @media (max-width: 768px) {
            /* æœªå¹³å€‰æŒå€‰å€åŸŸéŸ¿æ‡‰å¼ */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* è¼¸å…¥å€åŸŸéŸ¿æ‡‰å¼ */
            div[style*="grid-template-columns: 2fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            div[style*="grid-template-columns: 1fr 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* æŒ‰éˆ•éŸ¿æ‡‰å¼ */
            div[style*="grid-template-columns: 1fr 1fr"] button,
            div[style*="grid-template-columns: 1fr 1fr 1fr"] button {
                font-size: 12px;
                padding: 8px;
            }
            
            /* æ’è¡Œæ¦œéŸ¿æ‡‰å¼ */
            #leaderboard {
                grid-template-columns: 1fr !important;
            }
            
            /* ç™»éŒ„å€åŸŸéŸ¿æ‡‰å¼ */
            div[style*="grid-template-columns: 1fr 1fr 1fr"] input,
            div[style*="grid-template-columns: 1fr 1fr 1fr"] button {
                font-size: 12px;
                padding: 8px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .section {
                padding: 15px;
            }
            
            input, button {
                font-size: 14px !important;
                padding: 8px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="äº¤æ˜“ç­–ç•¥_é˜²å®ˆå‹ç­–ç•¥.html" class="back-link">â† è¿”å›é˜²å®ˆå‹ç­–ç•¥</a>
        <h1>ğŸŒ³ é˜²å®ˆå‹å¥—åˆ©-ç´°ç¯€æ±ºç­–æ¨¹</h1>
        <p class="subtitle">150è‚¡æ¨¡å‹ - å®Œæ•´æ±ºç­–æ¨¹ç‹€çµæ§‹</p>

        <!-- ç³»çµ±åƒæ•¸ -->
        <div class="section">
            <h2>ç³»çµ±åƒæ•¸ç¯„ä¾‹</h2>
            <div class="parameters">
                <div class="param-item">
                    <strong>ç›®æ¨™è‚¡ç¥¨</strong>
                    CRML
                </div>
                <div class="param-item">
                    <strong>åˆå§‹è²·å…¥åƒ¹</strong>
                    $11.00
                </div>
                <div class="param-item">
                    <strong>é—œéµé˜»åŠ› (Call Strike)</strong>
                    $12.00 (åŸå§‹ POC)
                </div>
                <div class="param-item">
                    <strong>é—œéµæ”¯æ’ (Put Strike)</strong>
                    $9.00 (äºŒæ¬¡åŠ å€‰ç›®æ¨™åƒ¹)
                </div>
                <div class="param-item">
                    <strong>ç³»çµ±æ¨¡å‹</strong>
                    150 è‚¡æ¨¡å‹
                </div>
                <div class="param-item">
                    <strong>é å‚™ç¾é‡‘</strong>
                    å·²é ç•™è¶³å¤ ç¾é‡‘ï¼Œæº–å‚™åœ¨ $9.00 åŸ·è¡Œ Short Put
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="äº¤æ˜“ç­–ç•¥_æ¨¡æ“¬å™¨.html" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); transition: transform 0.2s;">
                    âœ¨ é€²å…¥æ¨¡æ“¬äº¤æ˜“
                </a>
                <a href="äº¤æ˜“ç­–ç•¥_æ¨¡æ“¬äº¤æ˜“2.0.html" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: transform 0.2s;">
                    ğŸ® é€²å…¥æ¨¡æ“¬äº¤æ˜“ï¼ˆå®Œæ•´ç‰ˆï¼‰
                </a>
            </div>
        </div>

        <!-- éšæ®µä¸€ï¼šæ¨¹å¹¹ -->
        <div class="section">
            <h2>éšæ®µä¸€ï¼šæ¨¹å¹¹ï¼ˆThe Trunkï¼‰- åˆå§‹å»ºå€‰</h2>
            <div class="action-box">
                <h3>è¡Œå‹• 1ï¼ˆè²·å…¥ï¼‰</h3>
                <p>è²·å…¥ 150 è‚¡è‚¡ç¥¨ @ $11.00 (ç¸½æˆæœ¬ $1650)</p>
            </div>
            <div class="action-box">
                <h3>è¡Œå‹• 2ï¼ˆè³£ Callï¼‰</h3>
                <p>ç«‹å³è³£å‡º 1 å£æœ¬é€±åˆ°æœŸçš„ $12.00 Covered Call (å‡è¨­æ”¶åˆ° $50)</p>
            </div>
            <div class="action-box">
                <h3>è¡Œå‹• 3ï¼ˆæ›å–®ï¼‰</h3>
                <p>ç«‹å³æ›ä¸€å¼µ GTCï¼ˆé•·æ•ˆå–®ï¼‰è¨‚å–®ï¼Œä»¥ $5 çš„åƒ¹æ ¼ã€Œè²·å›ã€æ‚¨å‰›æ‰è³£å‡ºçš„ Callï¼ˆé–å®š 90% åˆ©æ½¤ï¼‰</p>
            </div>
            <div class="info-box">
                <strong>åˆå§‹ç‹€æ…‹ï¼š</strong>æ‚¨æŒæœ‰ 150 è‚¡ã€‚100 è‚¡è¢« Call è¦†è“‹ï¼ˆæœ‰æ•ˆæˆæœ¬ $10.50ï¼‰ï¼Œ50 è‚¡æ˜¯æ‚¨çš„ã€Œè‡ªç”±è‚¡ã€ã€‚æ‚¨é–‹å§‹ç­‰å¾…å¸‚å ´è§¸ç™¼æ‚¨çš„ GTC è¨‚å–®æˆ–åˆ°æœŸçµç®—ã€‚
            </div>
        </div>

        <!-- éšæ®µäºŒï¼šåˆ†å²” -->
        <div class="section">
            <h2>éšæ®µäºŒï¼šåˆ†å²”ï¼ˆThe Forkï¼‰- é€±ä¸­ç®¡ç†</h2>
            <p>æ‚¨åªå° GTC è¨‚å–®æˆäº¤ï¼ˆ$5 è²·å›ï¼‰åšå‡ºåæ‡‰ã€‚</p>
            
            <div class="mermaid">
graph TD
    START[åˆå§‹å»ºå€‰<br/>150è‚¡ + $12 Call] --> GTC{GTCè¨‚å–®æˆäº¤?}
    
    GTC -->|å¦| SETTLE[ç­‰å¾…çµç®—]
    GTC -->|æ˜¯| REASON{æˆäº¤åŸå› ?}
    
    REASON -->|åƒ¹æ ¼å‹åˆ©| D1[æƒ…å¢ƒD1:<br/>è‚¡åƒ¹ä¸‹è·Œè‡³$10<br/>è§¸ç™¼Path B]
    REASON -->|æ™‚é–“å‹åˆ©| D2[æƒ…å¢ƒD2:<br/>Thetaè€—æ<br/>æ™‚é–“åƒ¹å€¼è€—ç›¡]
    
    D1 --> D1ACTION[è³£å‡º25è‚¡@$10<br/>è³£å‡ºShort Strangle<br/>$12 Call + $9 Put]
    D2 --> D2ACTION[è³£å‡ºä¸‹é€±$12 Call<br/>é‡æ–°æ”¶ç§Ÿ]
    
    style START fill:#e3f2fd,stroke:#2196f3,stroke-width:3px
    style D1 fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D2 fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px;">
                <h3>ğŸŒ³ æƒ…å¢ƒ D1ï¼šã€Œåƒ¹æ ¼å‹åˆ©ã€ï¼ˆå› è‚¡åƒ¹ä¸‹è·Œï¼‰</h3>
                <div class="info-box">
                    <strong>ç‹€æ³ï¼š</strong>é€±äºŒæˆ–é€±ä¸‰ï¼Œè‚¡åƒ¹ä¸‹è·Œè‡³ $10.00ã€‚æ‚¨çš„ $12 Call åƒ¹å€¼å´©è·Œè‡³ $5ï¼Œè¨‚å–®æˆäº¤ã€‚
                </div>
                <div class="action-box">
                    <strong>åˆ†æï¼š</strong>å¸‚å ´è§¸ç™¼äº†æ‚¨çš„ã€ŒPath Bï¼šäºŒæ¬¡åŠ å€‰ã€è¨Šè™Ÿã€‚é€™æ˜¯æ¨¹ç‹€åœ–çš„ä¸»è¦åˆ†æã€‚
                </div>
                <div class="action-box">
                    <strong>è¡Œå‹•ï¼š</strong>
                    <ul>
                        <li>è³£å‡º 25 è‚¡è‚¡ç¥¨ @ $10.00ï¼ˆå¯¦ç¾ 25 è‚¡ @ $1.00 çš„è™§æï¼‰</li>
                        <li>æ‚¨æ‰‹ä¸Šé‚„å‰© 125 è‚¡ï¼ˆ100 è‚¡ @ $11 + 25 è‚¡ @ $11ï¼‰</li>
                        <li>å‹•ç”¨ã€Œé å‚™ç¾é‡‘ã€+ å‰›è³£å‡ºçš„ $250 + æ–°æ¬Šåˆ©é‡‘</li>
                        <li>ç«‹å³è³£å‡º 1 å£ä¸‹é€±çš„ Short Strangleï¼ˆå‹’å¼ï¼‰ï¼š
                            <ul>
                                <li>è³£ 1 å£ä¸‹é€± $12.00 Callï¼ˆç®¡ç†æ‚¨çš„ $11 æˆæœ¬æŒè‚¡ï¼‰</li>
                                <li>è³£ 1 å£ä¸‹é€± $9.00 Putï¼ˆæ‚¨çš„åŠ å€‰ç›®æ¨™ï¼‰</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="result-box">
                    <strong>æ–°ç‹€æ…‹ï¼š</strong>æ‚¨æŒæœ‰ 125 è‚¡ + Short 1 Call @ $12 + Short 1 Put @ $9ã€‚<br>
                    <strong>Whipsaw (V è½‰) é¢¨éšªå°æ²–ï¼š</strong>æ‚¨æ‰‹ä¸Šé‚„æœ‰ 25 è‚¡ã€Œè‡ªç”±è‚¡ã€ï¼Œé€™ 25 è‚¡åœ¨ V è½‰æš´æ¼²æ™‚ï¼Œåˆ©æ½¤ä¸æœƒè¢« $12 Call é–æ­»ã€‚
                </div>
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px;">
                <h3>ğŸŒ³ æƒ…å¢ƒ D2ï¼šã€Œæ™‚é–“å‹åˆ©ã€ï¼ˆå›  Theta è€—æï¼‰</h3>
                <div class="info-box">
                    <strong>ç‹€æ³ï¼š</strong>é€±å››ä¸‹åˆæˆ–é€±äº”æ—©ä¸Šã€‚è‚¡åƒ¹æ©«ç›¤åœ¨ $11.50 é™„è¿‘ã€‚æ™‚é–“åƒ¹å€¼è€—ç›¡ï¼Œè¨‚å–®æˆäº¤ã€‚
                </div>
                <div class="action-box">
                    <strong>åˆ†æï¼š</strong>Path B æœªè§¸ç™¼ã€‚é€™æ˜¯ä¸€å€‹ã€Œå°åˆ†æã€ã€‚
                </div>
                <div class="action-box">
                    <strong>è¡Œå‹•ï¼š</strong>ç«‹å³è³£å‡º 1 å£ä¸‹é€±çš„ $12.00 Callã€‚é‡æ–°é–‹å§‹ã€Œæ”¶ç§Ÿã€ï¼Œä¸¦æ›å¥½æ–°çš„ $5 GTC è²·å›å–®ã€‚
                </div>
            </div>
        </div>

        <!-- éšæ®µä¸‰ï¼šçµç®— -->
        <div class="section">
            <h2>éšæ®µä¸‰ï¼šçµç®—ï¼ˆThe Outcomeï¼‰- é€±äº”æ”¶ç›¤</h2>
            <p>å‡è¨­æ‚¨çš„ GTC è¨‚å–®å¾æœªæˆäº¤ï¼Œæ‚¨æŒæœ‰å€‰ä½ç›´åˆ°çµç®—ã€‚</p>
            
            <div class="mermaid">
graph TD
    SETTLE[é€±äº”çµç®—] --> PRICE{è‚¡åƒ¹æ”¶ç›¤åƒ¹?}
    
    PRICE -->|> $12.00| A[æƒ…å¢ƒA: ä¸Šæ¼²<br/>è¡Œæ¬Š]
    PRICE -->|< $12.00| BC[æƒ…å¢ƒB/C: æ©«ç›¤æˆ–ä¸‹è·Œ<br/>CalléæœŸä½œå»¢]
    
    A --> A_RESULT[100è‚¡@$12è³£å‡º<br/>ç²åˆ©$150<br/>å‰©é¤˜50è‚¡è‡ªç”±è‚¡]
    BC --> BC_RESULT[æ·¨è³º$50æ¬Šåˆ©é‡‘<br/>ä»æŒæœ‰150è‚¡]
    
    style A fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style BC fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style A_RESULT fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
    style BC_RESULT fill:#fff3e0,stroke:#ff9800,stroke-width:2px
            </div>

            <div class="result-box" style="margin-top: 20px;">
                <h3>ğŸ”´ æƒ…å¢ƒ Aï¼šã€Œä¸Šæ¼²ã€ï¼ˆè‚¡åƒ¹æ”¶ç›¤ > $12.00ï¼‰</h3>
                <p><strong>çµæœï¼š</strong>è¡Œæ¬Šã€‚æ‚¨çš„ 100 è‚¡ä»¥ $12 çš„åƒ¹æ ¼è¢«è‡ªå‹•è³£å‡ºã€‚</p>
                <p><strong>ç²åˆ©ï¼ˆ100 è‚¡ï¼‰ï¼š</strong>($12.00 è³£å‡ºåƒ¹ - $11.00 è²·å…¥åƒ¹) + $0.50 æ¬Šåˆ©é‡‘ = æ¯è‚¡ $1.50 (ç¸½ç²åˆ© $150)</p>
                <p><strong>æ–°ç‹€æ…‹ï¼š</strong>æ‚¨æ‰‹ä¸Šæœ‰ 50 è‚¡ã€Œè‡ªç”±è‚¡ã€ + å¤§é‡ç¾é‡‘ã€‚</p>
                <p><strong>çµè«–ï¼š</strong>å®Œç¾å¯¦ç¾ Path Aã€‚ã€Œä¸éŒ¯éä¸å¾Œæ‚”ã€ã€‚</p>
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h3>ğŸŸ¡ æƒ…å¢ƒ B/Cï¼šã€Œæ©«ç›¤æˆ–ä¸‹è·Œã€ï¼ˆè‚¡åƒ¹æ”¶ç›¤ < $12.00ï¼‰</h3>
                <p><strong>çµæœï¼š</strong>Call éæœŸä½œå»¢ã€‚æ‚¨æ·¨è³º $50 æ¬Šåˆ©é‡‘ã€‚</p>
                <p><strong>æ–°ç‹€æ…‹ï¼š</strong>æ‚¨æ‰‹ä¸Šä¾ç„¶æ˜¯ 150 è‚¡ï¼ˆä½†ç¸½æˆæœ¬å·²é™ä½ï¼‰ã€‚</p>
                <p><strong>çµè«–ï¼š</strong>æˆåŠŸã€Œæ”¶ç§Ÿã€ã€‚</p>
            </div>
        </div>

        <!-- éšæ®µå››ï¼šæè‘‰ -->
        <div class="section">
            <h2>éšæ®µå››ï¼šæè‘‰ï¼ˆThe Twigsï¼‰- ä¸‹é€±ä¸€é‡å•Ÿ</h2>
            <p>æ‚¨å°‡æ ¹æ“šä¸Šé€±çš„çµç®—çµæœï¼Œé•·å‡ºæ–°çš„ã€Œæè‘‰ã€ã€‚</p>
            
            <div class="mermaid">
graph TD
    RESTART[ä¸‹é€±ä¸€é‡å•Ÿ] --> RESULT{ä¸Šé€±çµç®—çµæœ?}
    
    RESULT -->|æƒ…å¢ƒA| A_RESTART[å‰©é¤˜50è‚¡+ç¾é‡‘<br/>åªè³£Putéšæ®µ]
    RESULT -->|æƒ…å¢ƒB/C| BC_RESTART[å‰©é¤˜150è‚¡<br/>è¿”å›éšæ®µä¸€]
    RESULT -->|æƒ…å¢ƒD1| D1_RESTART[å‰©é¤˜125è‚¡+Strangle<br/>Strangleç®¡ç†åˆ†æ”¯]
    
    A_RESTART --> A_ACTION[è³£Put @ $11.50<br/>æ›GTCè²·å›<br/>ç›®æ¨™: è²·å›100è‚¡]
    
    BC_RESTART --> BC_ACTION[è³£ä¸‹é€±Call @ $12<br/>æ›GTCè²·å›]
    
    D1_RESTART --> D1_SETTLE{Strangleçµç®—?}
    D1_SETTLE -->|Callè¡Œæ¬Š| D1_1[å‰©é¤˜25è‚¡<br/>åªè³£Putéšæ®µ]
    D1_SETTLE -->|Putè¡Œæ¬Š| D1_2[å‰©é¤˜225è‚¡<br/>é«˜ä½é…æ”¶ç§Ÿ]
    D1_SETTLE -->|éƒ½æœªè¡Œæ¬Š| D1_3[å‰©é¤˜125è‚¡<br/>ç¹¼çºŒShort Strangle]
    
    D1_2 --> D1_2_ACTION[è³£Call @ $10<br/>è³£Call @ $12<br/>ç®¡ç†ä¸åŒæˆæœ¬å±¤]
    
    style A_RESTART fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    style BC_RESTART fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D1_RESTART fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style D1_2 fill:#ffebee,stroke:#f44336,stroke-width:2px
            </div>

            <div class="action-box" style="margin-top: 20px;">
                <h3>A ä¹‹é‡å•Ÿï¼ˆæ‚¨å‰©ä¸‹ 50 è‚¡ + ç¾é‡‘ï¼‰</h3>
                <p><strong>è¡Œå‹•ï¼š</strong>ã€Œåªè³£ Put éšæ®µã€</p>
                <ul>
                    <li>è³£å‡º Put (Cash-Secured Put)ï¼šå‹•ç”¨æ‚¨çš„ç¾é‡‘ï¼Œå»è³£ä¸€å£ä¸‹é€±çš„ã€åƒ¹å¤–çš„ Putï¼ˆä¾‹å¦‚ $11.50 æˆ– $11ï¼‰</li>
                    <li>æ›å–®ï¼šæ› GTC è¨‚å–®è²·å›é€™å£ Putï¼ˆé–å®š 80-90% åˆ©æ½¤ï¼‰</li>
                    <li>ç›®çš„ï¼šã€Œè³º put çš„æ¬Šåˆ©é‡‘ä»¥æ­¤å¾ªç’°ã€ã€‚å¦‚æœè¢«è¡Œæ¬Šï¼Œæ‚¨ä»¥ä½åƒ¹è²·å› 100 è‚¡ï¼Œå€‰ä½å›åˆ° 150 è‚¡ï¼Œé‡è¿”ã€Œéšæ®µä¸€ã€</li>
                </ul>
            </div>

            <div class="action-box" style="margin-top: 20px;">
                <h3>B / C ä¹‹é‡å•Ÿï¼ˆæ‚¨å‰©ä¸‹ 150 è‚¡ï¼‰</h3>
                <p><strong>è¡Œå‹•ï¼š</strong>è¿”å›ã€Œéšæ®µä¸€ã€</p>
                <ul>
                    <li>è³£å‡º 1 å£ä¸‹é€±çš„ Callï¼ˆè¡Œä½¿åƒ¹ $12 æˆ–ä¸‹èª¿ï¼‰</li>
                    <li>æ› GTC è¨‚å–®è²·å›</li>
                </ul>
            </div>

            <div class="section" style="margin-top: 20px; padding: 20px; background: #f3e5f5;">
                <h3>D1 ä¹‹é‡å•Ÿï¼ˆæ‚¨å‰©ä¸‹ 125 è‚¡ + Strangleï¼‰</h3>
                <p><strong>è¡Œå‹•ï¼š</strong>æ‚¨ç¾åœ¨é€²å…¥äº†æ¨¹ç‹€åœ–æœ€è¤‡é›œçš„ã€ŒStrangle ç®¡ç†ã€åˆ†æ”¯ã€‚</p>
                <ul>
                    <li>GTCï¼šæ› GTC è¨‚å–®åˆ†åˆ¥è²·å› Call å’Œ Putï¼ˆé–å®š 80-90% åˆ©æ½¤ï¼‰</li>
                    <li>ç­‰å¾…çµç®—ï¼š</li>
                </ul>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.1 (Strangle Call @ $12 è¡Œæ¬Š)ï¼š</h4>
                    <p><strong>æ–°æŒå€‰ï¼š</strong>æ‚¨æ‰‹ä¸Šã€Œåªå‰©ä¸‹ 25 è‚¡ã€ï¼ˆ100 è‚¡è¢«è³£å‡ºï¼‰</p>
                    <p><strong>è¡Œå‹•ï¼š</strong>ã€Œåªè³£ Put éšæ®µã€ã€‚é–‹å§‹è³£ Putï¼Œè©¦åœ–æŠŠæŒè‚¡æ‹‰å› 125 è‚¡ã€‚</p>
                </div>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.2 (Strangle Put @ $9 è¡Œæ¬Š)ï¼š</h4>
                    <p><strong>æ–°æŒå€‰ï¼š</strong>æ‚¨è¢«è¿«è²·å…¥ 100 è‚¡ï¼Œæ‰‹ä¸Šã€Œå‰©ä¸‹ 225 è‚¡ã€</p>
                    <p><strong>æˆæœ¬åˆ†å±¤ï¼š</strong>(125 è‚¡ @ $11) + (100 è‚¡ @ $9)</p>
                    <p><strong>è¡Œå‹•ï¼ˆæ‚¨çš„ã€Œé«˜ä½é…ã€æ”¶ç§Ÿç­–ç•¥ï¼‰ï¼š</strong></p>
                    <ul>
                        <li>è³£ 1 å£ Call @ $10.00ï¼ˆã€Œæ¯”æˆæœ¬é«˜ä¸€å…ƒã€ï¼Œç®¡ç†æ‚¨ $9 çš„æŒè‚¡ï¼‰</li>
                        <li>è³£ 1 å£ Call @ $12.00ï¼ˆåŸå§‹ POCï¼Œç®¡ç†æ‚¨ $11 çš„æŒè‚¡ï¼‰</li>
                    </ul>
                    <p><strong>å¾ŒçºŒæ¼”åŒ–ï¼š</strong></p>
                    <ul>
                        <li>å¦‚æœ $10 Call è¢«è¡Œæ¬Šï¼ˆè‚¡åƒ¹ $10.50ï¼‰ï¼šæ‚¨å›åˆ° 125 è‚¡ + 1 Call @ $12 çš„ç‹€æ…‹ï¼Œä¸¦æº–å‚™ã€Œå›åˆ° Strangleã€ï¼ˆè³£ $9 Putï¼‰</li>
                        <li>å¦‚æœ $10 å’Œ $12 Call éƒ½è¢«è¡Œæ¬Šï¼ˆè‚¡åƒ¹ > $12ï¼‰ï¼šæ‚¨å›åˆ° 25 è‚¡ç‹€æ…‹ï¼Œé€²å…¥ã€Œåªè³£ Put éšæ®µã€</li>
                    </ul>
                </div>

                <div class="action-box" style="margin-top: 15px;">
                    <h4>D1.3 (å…©é‚Šéƒ½æœªè¡Œæ¬Š)ï¼š</h4>
                    <p><strong>æ–°æŒå€‰ï¼š</strong>æ‚¨æ‰‹ä¸Šä¾ç„¶æ˜¯ 125 è‚¡</p>
                    <p><strong>è¡Œå‹•ï¼š</strong>ã€Œç¹¼çºŒ short strangleã€ã€‚è³£ä¸‹é€±çš„ $9p / $12cï¼Œé‡è¤‡ D1 å¾ªç’°</p>
                </div>
            </div>
        </div>

        <!-- çµ‚å±€ -->
        <div class="section">
            <h2>çµ‚å±€ï¼šæ¨¹çš„é‚Šç•Œï¼ˆThe End of the Lineï¼‰</h2>
            
            <div class="result-box">
                <h3>çµ‚å±€ 1ï¼šã€Œå¤§æš´æ¼²ã€ï¼ˆç­–ç•¥å¤§ç²å…¨å‹ï¼‰</h3>
                <p><strong>ç‹€æ³ï¼š</strong>æ‚¨çš„ Call @ $12 è¢«è¡Œæ¬Šï¼Œä½†è‚¡åƒ¹é£†å‡åˆ° $20</p>
                <p><strong>å€‰ä½ï¼š</strong>æ‚¨çš„ 25 è‚¡æˆ– 50 è‚¡ã€Œè‡ªç”±è‚¡ã€</p>
                <p><strong>è¡Œå‹•ï¼š</strong>ä¸å†é¡å¤–æ“ä½œã€‚æ‚¨ä¸æœƒåœ¨ $20 å»è³£ Put è¿½é«˜ã€‚ç²åˆ©äº†çµï¼Œå¸¶è‘—åˆ©æ½¤é›¢å ´å°‹æ‰¾ä¸‹ä¸€å€‹ç›®æ¨™ã€‚</p>
            </div>

            <div class="risk-box">
                <h3>çµ‚å±€ 2ï¼šã€Œå¤§æš´è·Œã€ï¼ˆç­–ç•¥å”¯ä¸€å¤±æ•—ï¼‰</h3>
                <p><strong>ç‹€æ³ï¼š</strong>æ‚¨çš„ Put @ $9 è¢«è¡Œæ¬Šï¼ˆç¸½æŒå€‰ 225 è‚¡ï¼‰ï¼Œä½†è‚¡åƒ¹å´©ç›¤è‡³ $5</p>
                <p><strong>è¡Œå‹•ï¼š</strong>åœæ­¢æ‰€æœ‰æœŸæ¬Šæ“ä½œ</p>
                <ul>
                    <li>ä¸è³£ Putï¼šé¿å…æŒå€‰å¢åŠ åˆ° 325 è‚¡</li>
                    <li>ä¸è³£ Callï¼šé¿å…åœ¨ $6 é€™ç¨®ä½åƒ¹ã€Œé–å®šã€æ‚¨çš„å·¨å¤§è™§æï¼Œä¹Ÿé¿å…ç‚ºäº†å¹¾å¡ŠéŒ¢çš„æ¬Šåˆ©é‡‘ï¼Œè³£æ‰ $10-$12 çš„ã€Œç¿»èº«ã€æ©Ÿæœƒ</li>
                </ul>
                <p><strong>çµè«–ï¼š</strong>ã€Œæ»¾è¼ªå¥—åˆ©ã€ç³»çµ±åœ¨æ­¤å¤±æ•—ã€‚æ‚¨è½‰ç‚ºã€Œè¢«å‹•æŠ•è³‡è€…ã€ï¼ŒæŒæœ‰é€™ 225 è‚¡ï¼Œç­‰å¾…æœªä¾†åŸºæœ¬é¢åè½‰ã€‚</p>
            </div>
        </div>

        <!-- å®Œæ•´æ±ºç­–æ¨¹ç¸½è¦½ -->
        <div class="section">
            <h2>å®Œæ•´æ±ºç­–æ¨¹ç¸½è¦½</h2>
            <div class="mermaid">
flowchart TD
    START[éšæ®µä¸€: åˆå§‹å»ºå€‰<br/>150è‚¡ + $12 Call + GTC] --> WEEK[é€±ä¸­ç®¡ç†]
    
    WEEK --> GTC_CHECK{GTCæˆäº¤?}
    GTC_CHECK -->|å¦| FRIDAY[é€±äº”çµç®—]
    GTC_CHECK -->|æ˜¯| D1[æƒ…å¢ƒD1: åƒ¹æ ¼å‹åˆ©<br/>125è‚¡+Strangle]
    GTC_CHECK -->|æ˜¯| D2[æƒ…å¢ƒD2: æ™‚é–“å‹åˆ©<br/>é‡æ–°è³£Call]
    
    FRIDAY --> PRICE_CHECK{è‚¡åƒ¹?}
    PRICE_CHECK -->|> $12| A[æƒ…å¢ƒA: ä¸Šæ¼²<br/>50è‚¡+ç¾é‡‘]
    PRICE_CHECK -->|< $12| BC[æƒ…å¢ƒB/C: æ”¶ç§Ÿ<br/>150è‚¡]
    
    A --> A_NEXT[åªè³£Putéšæ®µ]
    BC --> BC_NEXT[è¿”å›éšæ®µä¸€]
    D1 --> D1_NEXT[Strangleç®¡ç†]
    D2 --> D2_NEXT[è¿”å›éšæ®µä¸€]
    
    D1_NEXT --> D1_RESULT{Strangleçµæœ?}
    D1_RESULT -->|Callè¡Œæ¬Š| D1_1[25è‚¡]
    D1_RESULT -->|Putè¡Œæ¬Š| D1_2[225è‚¡<br/>é«˜ä½é…]
    D1_RESULT -->|æœªè¡Œæ¬Š| D1_3[125è‚¡<br/>ç¹¼çºŒStrangle]
    
    D1_1 --> PUT_ONLY[åªè³£Putéšæ®µ]
    D1_2 --> HIGH_LOW[é«˜ä½é…æ”¶ç§Ÿ]
    D1_3 --> D1_NEXT
    
    A_NEXT --> PUT_ONLY
    PUT_ONLY --> RESTART[å¾ªç’°é‡å•Ÿ]
    BC_NEXT --> RESTART
    HIGH_LOW --> RESTART
    
    RESTART --> END1[çµ‚å±€1: å¤§æš´æ¼²<br/>ç²åˆ©äº†çµ]
    RESTART --> END2[çµ‚å±€2: å¤§æš´è·Œ<br/>è¢«å‹•æŒæœ‰]
    
    style START fill:#e3f2fd,stroke:#2196f3,stroke-width:3px
    style A fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style BC fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style D1 fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style D1_2 fill:#ffebee,stroke:#f44336,stroke-width:2px
    style END1 fill:#c8e6c9,stroke:#4caf50,stroke-width:3px
    style END2 fill:#ffcdd2,stroke:#f44336,stroke-width:3px
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20
            },
            securityLevel: 'loose'
        });

        // å„€è¡¨æ¿æ•¸æ“šå­˜å„² - æ”¯æŒå¤šè‚¡ç¥¨å’Œå¤šç”¨æˆ¶
        let dashboardData = {
            userId: '',  // ç•¶å‰ç”¨æˆ¶ID
            capitalAdditions: [],  // [{amount: 1000, date: '2025/01/01'}]
            stocks: {}  // {symbol: {operations: [], calls: [], puts: [], buyCalls: [], buyPuts: []}}
        };
        
        let currentStock = '';  // ç•¶å‰é¸ä¸­çš„è‚¡ç¥¨
        
        let currentPrices = {
            stocks: {}  // {symbol: {stock: 0, calls: {}, puts: {}}}
        };
        
        // æ“ä½œæ­·å²æ£§ï¼ˆç”¨æ–¼æ’¤éŠ·åŠŸèƒ½ï¼‰
        let operationHistory = [];  // [{type: 'buy', data: {...}, snapshot: {...}}]
        let maxHistorySize = 50;  // æœ€å¤šä¿å­˜50æ­¥æ“ä½œ
        
        // å¾localStorageè¼‰å…¥æ•¸æ“šï¼ˆå…¼å®¹èˆŠç‰ˆæœ¬ï¼‰
        function loadData() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»éŒ„
            const saved = localStorage.getItem('tradingDashboard');
            if (saved && !dashboardData.userId) {
                try {
                    const loaded = JSON.parse(saved);
                    // å¦‚æœæœ‰èˆŠæ•¸æ“šä½†æ²’æœ‰ç”¨æˆ¶IDï¼Œæç¤ºç™»éŒ„
                    if (loaded.stocks || loaded.capitalAdditions) {
                        console.log('æª¢æ¸¬åˆ°èˆŠæ•¸æ“šï¼Œè«‹å…ˆç™»éŒ„ä»¥è¼‰å…¥æ•¸æ“š');
                    }
                } catch (e) {
                    console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', e);
                }
            }
        }
        
        // è¼‰å…¥åƒ¹æ ¼
        function loadPrices() {
            const saved = localStorage.getItem('tradingPrices');
            if (saved) {
                currentPrices = JSON.parse(saved);
            }
        }
        
        // æ›´æ–°è‚¡ç¥¨é¸æ“‡ä¸‹æ‹‰æ¡†
        function updateStockSelect() {
            const select = document.getElementById('stock-select');
            const callSelect = document.getElementById('exercise-call-select');
            const putSelect = document.getElementById('exercise-put-select');
            const currentValue = select.value;
            
            if (!select || !callSelect || !putSelect) return;
            
            select.innerHTML = '<option value="">-- é¸æ“‡è‚¡ç¥¨ --</option>';
            callSelect.innerHTML = '<option value="">é¸æ“‡è¢«è¡Œä½¿çš„Call</option>';
            putSelect.innerHTML = '<option value="">é¸æ“‡è¢«è¡Œä½¿çš„Put</option>';
            
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
                
                // æ›´æ–°Callé¸æ“‡æ¡†
                const stock = dashboardData.stocks[symbol];
                if (stock && stock.calls) {
                    const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                    openCalls.forEach(call => {
                        const callOption = document.createElement('option');
                        callOption.value = `${symbol}_${call.id}`;
                        callOption.textContent = `${symbol} $${call.strike} Call (${call.expiry})`;
                        callSelect.appendChild(callOption);
                    });
                }
                
                // æ›´æ–°Puté¸æ“‡æ¡†
                if (stock && stock.puts) {
                    const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                    openPuts.forEach(put => {
                        const putOption = document.createElement('option');
                        putOption.value = `${symbol}_${put.id}`;
                        putOption.textContent = `${symbol} $${put.strike} Put (${put.expiry})`;
                        putSelect.appendChild(putOption);
                    });
                }
            });
            
            if (currentValue && dashboardData.stocks[currentValue]) {
                select.value = currentValue;
            }
        }
        
        // æ·»åŠ è³‡é‡‘
        function addCapital() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const amount = parseFloat(document.getElementById('add-capital').value);
            if (amount > 0) {
                // ä¿å­˜å¿«ç…§
                saveOperationSnapshot('addCapital', {amount: amount});
                
                if (!dashboardData.capitalAdditions) {
                    dashboardData.capitalAdditions = [];
                }
                dashboardData.capitalAdditions.push({
                    amount: amount,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now()
                });
                document.getElementById('add-capital').value = '';
                updateAvailableCash();
                updateDisplay();
                saveData();
                alert(`å·²æˆåŠŸæ·»åŠ è³‡é‡‘ $${amount.toFixed(2)}ï¼`);
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
            }
        }
        
        // æ–°å¢è‚¡ç¥¨
        function addNewStock() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const symbol = document.getElementById('stock-symbol').value.trim().toUpperCase();
            if (!symbol) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }
            
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            if (!dashboardData.stocks[symbol]) {
                // ä¿å­˜å¿«ç…§
                saveOperationSnapshot('addStock', {symbol: symbol});
                
                dashboardData.stocks[symbol] = {
                    operations: [],
                    calls: [],
                    puts: [],
                    buyCalls: [],
                    buyPuts: []
                };
                currentStock = symbol;
                updateStockSelect();
                document.getElementById('stock-select').value = symbol;
                document.getElementById('stock-symbol').value = '';
                updateDisplay();
                saveData();
                alert(`è‚¡ç¥¨ ${symbol} å·²æˆåŠŸæ–°å¢ï¼`);
            } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥é¸æ“‡å®ƒ
                currentStock = symbol;
                document.getElementById('stock-select').value = symbol;
                updateDisplay();
                alert(`è‚¡ç¥¨ ${symbol} å·²å­˜åœ¨ï¼Œå·²åˆ‡æ›åˆ°è©²è‚¡ç¥¨`);
            }
        }
        
        // é¸æ“‡è‚¡ç¥¨
        function selectStock() {
            const symbol = document.getElementById('stock-select').value;
            if (symbol && dashboardData.stocks[symbol]) {
                currentStock = symbol;
                updateDisplay();
            }
        }
        
        // ç²å–ç•¶å‰è‚¡ç¥¨æ•¸æ“š
        function getCurrentStockData() {
            if (!currentStock || !dashboardData.stocks[currentStock]) {
                return null;
            }
            return dashboardData.stocks[currentStock];
        }

        // ä¿å­˜æ•¸æ“šåˆ°localStorageï¼ˆæŒ‰ç”¨æˆ¶ä¿å­˜ï¼‰
        function saveData() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const userKey = `trading_user_${dashboardData.userId}`;
            const userData = localStorage.getItem(userKey);
            
            if (userData) {
                const parsed = JSON.parse(userData);
                parsed.dashboardData = dashboardData;
                parsed.updatedAt = new Date().toISOString();
                localStorage.setItem(userKey, JSON.stringify(parsed));
            } else {
                // å¦‚æœæ²’æœ‰ç”¨æˆ¶æ•¸æ“šï¼Œå‰µå»ºæ–°çš„
                const newUserData = {
                    password: '',  // å¯†ç¢¼ä¸æœƒåœ¨é€™è£¡æ›´æ–°
                    dashboardData: dashboardData,
                    updatedAt: new Date().toISOString()
                };
                localStorage.setItem(userKey, JSON.stringify(newUserData));
            }
            
            savePrices();
            updateLeaderboard();
            // æ•¸æ“šæœƒè‡ªå‹•ä¿å­˜ï¼Œä¸éœ€è¦æç¤º
        }
        
        // ä¿å­˜æ“ä½œå¿«ç…§ï¼ˆç”¨æ–¼æ’¤éŠ·ï¼‰
        function saveOperationSnapshot(operationType, operationData) {
            if (operationHistory.length >= maxHistorySize) {
                operationHistory.shift(); // ç§»é™¤æœ€èˆŠçš„æ“ä½œ
            }
            
            // å‰µå»ºç•¶å‰ç‹€æ…‹çš„æ·±æ‹·è²
            const snapshot = JSON.parse(JSON.stringify({
                dashboardData: JSON.parse(JSON.stringify(dashboardData)),
                currentStock: currentStock,
                currentPrices: JSON.parse(JSON.stringify(currentPrices))
            }));
            
            operationHistory.push({
                type: operationType,
                data: operationData,
                snapshot: snapshot,
                timestamp: Date.now()
            });
            
            // æ›´æ–°æ’¤éŠ·æŒ‰éˆ•ç‹€æ…‹
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = false;
            }
        }
        
        // æ’¤éŠ·ä¸Šä¸€æ­¥æ“ä½œ
        function undoLastOperation() {
            if (operationHistory.length === 0) {
                alert('æ²’æœ‰å¯æ’¤éŠ·çš„æ“ä½œ');
                return;
            }
            
            const lastOperation = operationHistory.pop();
            
            // æ¢å¾©å¿«ç…§
            dashboardData = JSON.parse(JSON.stringify(lastOperation.snapshot.dashboardData));
            currentStock = lastOperation.snapshot.currentStock;
            currentPrices = JSON.parse(JSON.stringify(lastOperation.snapshot.currentPrices));
            
            // æ›´æ–°é¡¯ç¤º
            updateStockSelect();
            if (currentStock) {
                document.getElementById('stock-select').value = currentStock;
            }
            updateDisplay();
            updateAvailableCash();
            // è‡ªå‹•ä¿å­˜ï¼ˆæ•¸æ“šæœƒè‡ªå‹•ä¿å­˜ï¼Œä¸éœ€è¦æ‰‹å‹•ä¿å­˜ï¼‰
            saveData();
            
            // æ›´æ–°æ’¤éŠ·æŒ‰éˆ•ç‹€æ…‹
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = operationHistory.length === 0;
            }
        }

        // æ·»åŠ è²·å…¥æ“ä½œ
        function addBuyOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const shares = parseInt(document.getElementById('buy-shares').value);
            const price = parseFloat(document.getElementById('buy-price').value);
            
            if (!shares || !price) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„è²·å…¥ä¿¡æ¯');
                return;
            }

            const operation = {
                type: 'buy',
                shares: shares,
                price: price,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: currentStock
            };

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('buy', operation);

            stockData.operations.push(operation);

            document.getElementById('buy-shares').value = '';
            document.getElementById('buy-price').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // æ·»åŠ è³£å‡ºæ“ä½œ
        function addSellOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const shares = parseInt(document.getElementById('sell-shares').value);
            const price = parseFloat(document.getElementById('sell-price').value);
            
            if (!shares || !price) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„è³£å‡ºä¿¡æ¯');
                return;
            }

            const operation = {
                type: 'sell',
                shares: shares,
                price: price,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: currentStock
            };

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('sell', operation);

            stockData.operations.push(operation);

            document.getElementById('sell-shares').value = '';
            document.getElementById('sell-price').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // æ·»åŠ è³£Callæ“ä½œ
        function addCallOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('call-strike').value);
            const premium = parseFloat(document.getElementById('call-premium').value);
            const expiry = document.getElementById('call-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„Callä¿¡æ¯');
                return;
            }

            const call = {
                strike: strike,
                premium: premium,
                expiry: expiry,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                closed: false,
                symbol: currentStock,
                exercised: false
            };

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('sellCall', call);

            stockData.calls.push(call);

            document.getElementById('call-strike').value = '';
            document.getElementById('call-premium').value = '';
            document.getElementById('call-expiry').value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // æ·»åŠ è²·å…¥Callæ“ä½œï¼ˆå¹³å€‰ï¼‰
        function addBuyCallOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('buy-call-strike').value);
            const premium = parseFloat(document.getElementById('buy-call-premium').value);
            const expiry = document.getElementById('buy-call-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„Callä¿¡æ¯');
                return;
            }

            const operationData = {strike, premium, expiry, symbol: currentStock};

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('buyCall', operationData);

            // å°‹æ‰¾åŒ¹é…çš„è³£Callä¾†å¹³å€‰
            const matchingCall = stockData.calls.find(c => 
                !c.closed && 
                !c.exercised &&
                Math.abs(c.strike - strike) < 0.01 && 
                c.expiry === expiry
            );

            if (matchingCall) {
                matchingCall.closed = true;
                matchingCall.closePrice = premium;
                matchingCall.closeDate = new Date().toLocaleDateString('zh-TW');
            } else {
                // å¦‚æœæ²’æœ‰åŒ¹é…çš„ï¼Œè¨˜éŒ„ç‚ºè²·å…¥Callï¼ˆå¯èƒ½æ˜¯æ–°çš„é–‹å€‰ï¼‰
                stockData.buyCalls.push({
                    strike: strike,
                    premium: premium,
                    expiry: expiry,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now(),
                    symbol: currentStock
                });
            }

            document.getElementById('buy-call-strike').value = '';
            document.getElementById('buy-call-premium').value = '';
            document.getElementById('buy-call-expiry').value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // æ·»åŠ è³£Putæ“ä½œ
        function addPutOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('put-strike').value);
            const premium = parseFloat(document.getElementById('put-premium').value);
            const expiry = document.getElementById('put-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„Putä¿¡æ¯');
                return;
            }

            const put = {
                strike: strike,
                premium: premium,
                expiry: expiry,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                closed: false,
                symbol: currentStock,
                exercised: false
            };

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('sellPut', put);

            stockData.puts.push(put);

            document.getElementById('put-strike').value = '';
            document.getElementById('put-premium').value = '';
            document.getElementById('put-expiry').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }

        // æ·»åŠ è²·å…¥Putæ“ä½œï¼ˆå¹³å€‰ï¼‰
        function addBuyPutOperation() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (!currentStock) {
                alert('è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨');
                return;
            }
            
            const stockData = getCurrentStockData();
            const strike = parseFloat(document.getElementById('buy-put-strike').value);
            const premium = parseFloat(document.getElementById('buy-put-premium').value);
            const expiry = document.getElementById('buy-put-expiry').value;
            
            if (!strike || !premium || !expiry) {
                alert('è«‹è¼¸å…¥å®Œæ•´çš„Putä¿¡æ¯');
                return;
            }

            const operationData = {strike, premium, expiry, symbol: currentStock};

            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('buyPut', operationData);

            // å°‹æ‰¾åŒ¹é…çš„è³£Putä¾†å¹³å€‰
            const matchingPut = stockData.puts.find(p => 
                !p.closed && 
                !p.exercised &&
                Math.abs(p.strike - strike) < 0.01 && 
                p.expiry === expiry
            );

            if (matchingPut) {
                matchingPut.closed = true;
                matchingPut.closePrice = premium;
                matchingPut.closeDate = new Date().toLocaleDateString('zh-TW');
            } else {
                // å¦‚æœæ²’æœ‰åŒ¹é…çš„ï¼Œè¨˜éŒ„ç‚ºè²·å…¥Putï¼ˆå¯èƒ½æ˜¯æ–°çš„é–‹å€‰ï¼‰
                stockData.buyPuts.push({
                    strike: strike,
                    premium: premium,
                    expiry: expiry,
                    date: new Date().toLocaleDateString('zh-TW'),
                    id: Date.now(),
                    symbol: currentStock
                });
            }

            document.getElementById('buy-put-strike').value = '';
            document.getElementById('buy-put-premium').value = '';
            document.getElementById('buy-put-expiry').value = '';
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        
        // Callè¢«è¡Œä½¿
        function exerciseCall() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const select = document.getElementById('exercise-call-select');
            
            if (!select.value) {
                alert('è«‹é¸æ“‡è¢«è¡Œä½¿çš„Call');
                return;
            }
            
            const [symbol, callId] = select.value.split('_');
            const stockData = dashboardData.stocks[symbol];
            if (!stockData) return;
            
            const call = stockData.calls.find(c => c.id == callId);
            if (!call || call.exercised || call.closed) {
                alert('è©²Callå·²è¢«è¡Œä½¿æˆ–å·²å¹³å€‰');
                return;
            }
            
            // ä½¿ç”¨Callçš„strikeåƒ¹æ ¼ä½œç‚ºè¡Œä½¿åƒ¹æ ¼
            const exercisePrice = call.strike;
            
            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('exerciseCall', {symbol, callId, exercisePrice});
            
            // æ¨™è¨˜ç‚ºå·²è¡Œä½¿
            call.exercised = true;
            call.exercisePrice = exercisePrice;
            call.exerciseDate = new Date().toLocaleDateString('zh-TW');
            
            // è‡ªå‹•æ¸›å°‘è‚¡ç¥¨æŒå€‰ï¼ˆ100è‚¡ï¼Œå› ç‚º1å£Call = 100è‚¡ï¼‰
            // æ³¨æ„ï¼šé€™è£¡è³£å‡ºè‚¡ç¥¨æ”¶åˆ°çš„éŒ¢æœƒå¢åŠ å¯ç”¨è³‡é‡‘ï¼Œä½†é€™æ˜¯æ­£å¸¸çš„ç¾é‡‘æµ
            // è³‡ç”¢ç¸½å€¼æœƒé€šéupdatePnL()è‡ªå‹•è¨ˆç®—ï¼ˆç¾é‡‘ + è‚¡ç¥¨å¸‚å€¼ï¼‰
            stockData.operations.push({
                type: 'sell',
                shares: 100,
                price: call.strike,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: symbol,
                reason: `Callè¢«è¡Œä½¿ (${call.strike} Call)`
            });
            
            alert(`${symbol} $${call.strike} Callå·²è¢«è¡Œä½¿ï¼Œå·²è‡ªå‹•è³£å‡º100è‚¡ @ $${call.strike}`);
            select.value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        
        // Putè¢«è¡Œä½¿
        function exercisePut() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            const select = document.getElementById('exercise-put-select');
            
            if (!select.value) {
                alert('è«‹é¸æ“‡è¢«è¡Œä½¿çš„Put');
                return;
            }
            
            const [symbol, putId] = select.value.split('_');
            const stockData = dashboardData.stocks[symbol];
            if (!stockData) return;
            
            const put = stockData.puts.find(p => p.id == putId);
            if (!put || put.exercised || put.closed) {
                alert('è©²Putå·²è¢«è¡Œä½¿æˆ–å·²å¹³å€‰');
                return;
            }
            
            // ä½¿ç”¨Putçš„strikeåƒ¹æ ¼ä½œç‚ºè¡Œä½¿åƒ¹æ ¼
            const exercisePrice = put.strike;
            
            // ä¿å­˜å¿«ç…§
            saveOperationSnapshot('exercisePut', {symbol, putId, exercisePrice});
            
            // æ¨™è¨˜ç‚ºå·²è¡Œä½¿
            put.exercised = true;
            put.exercisePrice = exercisePrice;
            put.exerciseDate = new Date().toLocaleDateString('zh-TW');
            
            // è‡ªå‹•å¢åŠ è‚¡ç¥¨æŒå€‰ï¼ˆ100è‚¡ï¼Œå› ç‚º1å£Put = 100è‚¡ï¼‰
            // æ³¨æ„ï¼šé€™è£¡è²·å…¥è‚¡ç¥¨æ”¯ä»˜çš„éŒ¢æœƒæ¸›å°‘å¯ç”¨è³‡é‡‘ï¼Œä½†é€™æ˜¯æ­£å¸¸çš„ç¾é‡‘æµ
            // è³‡ç”¢ç¸½å€¼æœƒé€šéupdatePnL()è‡ªå‹•è¨ˆç®—ï¼ˆç¾é‡‘ + è‚¡ç¥¨å¸‚å€¼ï¼‰
            stockData.operations.push({
                type: 'buy',
                shares: 100,
                price: put.strike,
                date: new Date().toLocaleDateString('zh-TW'),
                id: Date.now(),
                symbol: symbol,
                reason: `Putè¢«è¡Œä½¿ (${put.strike} Put)`
            });
            
            alert(`${symbol} $${put.strike} Putå·²è¢«è¡Œä½¿ï¼Œå·²è‡ªå‹•è²·å…¥100è‚¡ @ $${put.strike}`);
            select.value = '';
            updateStockSelect();
            updateAvailableCash();
            updateDisplay();
            saveData();
        }
        

        // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        function clearAll() {
            if (!dashboardData.userId) {
                alert('è«‹å…ˆç™»éŒ„');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                // ä¿å­˜ç•¶å‰ç”¨æˆ¶ID
                const currentUserId = dashboardData.userId;
                
                // é‡ç½®æ•¸æ“šçµæ§‹ï¼Œä½†ä¿ç•™userId
                dashboardData = {
                    userId: currentUserId,
                    capitalAdditions: [],
                    stocks: {}
                };
                currentPrices = {
                    stocks: {}
                };
                currentStock = '';
                operationHistory = [];
                document.getElementById('stock-symbol').value = '';
                document.getElementById('add-capital').value = '';
                updateStockSelect();
                
                // æ¸…é™¤æŒå€‰ç¸½è¦½
                const overviewDiv = document.getElementById('all-positions-overview');
                if (overviewDiv) {
                    overviewDiv.innerHTML = '<p style="color: #999; font-style: italic;">è«‹è¼¸å…¥æŒå€‰æ•¸æ“š</p>';
                }
                
                // æ¸…é™¤ç”¨æˆ¶ç‰¹å®šçš„localStorageæ•¸æ“š
                const userKey = `trading_user_${currentUserId}`;
                const userData = localStorage.getItem(userKey);
                if (userData) {
                    try {
                        const parsed = JSON.parse(userData);
                        // ä¿ç•™ç”¨æˆ¶ä¿¡æ¯å’Œå¯†ç¢¼ï¼Œåªæ¸…é™¤äº¤æ˜“æ•¸æ“š
                        const clearedUserData = {
                            password: parsed.password,
                            dashboardData: {
                                userId: currentUserId,
                                capitalAdditions: [],
                                stocks: {}
                            },
                            createdAt: parsed.createdAt || new Date().toISOString()
                        };
                        localStorage.setItem(userKey, JSON.stringify(clearedUserData));
                    } catch (e) {
                        console.error('æ¸…é™¤ç”¨æˆ¶æ•¸æ“šæ™‚å‡ºéŒ¯:', e);
                    }
                }
                
                // æ¸…é™¤é€šç”¨çš„åƒ¹æ ¼æ•¸æ“šï¼ˆå¯é¸ï¼Œå› ç‚ºåƒ¹æ ¼æ˜¯å…¨å±€çš„ï¼‰
                // localStorage.removeItem('tradingPrices');
                
                // é‡ç½®ä¸Šä¸€æ­¥æŒ‰éˆ•
                const undoBtn = document.getElementById('undo-btn');
                if (undoBtn) {
                    undoBtn.disabled = true;
                }
                
                updateDisplay();
                alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ï¼');
            }
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            if (!currentStock || !dashboardData.stocks[currentStock]) {
                // æ²’æœ‰é¸ä¸­è‚¡ç¥¨ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
                document.getElementById('total-shares').textContent = '0';
                document.getElementById('avg-cost').textContent = '0.00';
                document.getElementById('current-stage').textContent = 'æœªé¸æ“‡è‚¡ç¥¨';
                document.getElementById('decision-node').textContent = 'è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨';
                updateAvailableCash();
                updatePnL();
                generateTasks(0, 0, [], []);
                updateHistory();
                return;
            }

            const stockData = getCurrentStockData();
            
            // è¨ˆç®—ç¸½æŒè‚¡æ•¸å’Œå¹³å‡æˆæœ¬ï¼ˆä½¿ç”¨FIFOæ–¹æ³•ï¼‰
            let totalShares = 0;
            let totalCost = 0;
            let buyQueue = [];
            
            stockData.operations.forEach(op => {
                if (op.type === 'buy') {
                    buyQueue.push({shares: op.shares, price: op.price});
                    totalShares += op.shares;
                    totalCost += op.shares * op.price;
                } else if (op.type === 'sell') {
                    let remaining = op.shares;
                    while (remaining > 0 && buyQueue.length > 0) {
                        if (buyQueue[0].shares <= remaining) {
                            remaining -= buyQueue[0].shares;
                            totalCost -= buyQueue[0].shares * buyQueue[0].price;
                            totalShares -= buyQueue[0].shares;
                            buyQueue.shift();
                        } else {
                            totalCost -= remaining * buyQueue[0].price;
                            totalShares -= remaining;
                            buyQueue[0].shares -= remaining;
                            remaining = 0;
                        }
                    }
                }
            });

            const avgCost = totalShares > 0 ? (totalCost / totalShares).toFixed(2) : 0;

            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            document.getElementById('total-shares').textContent = totalShares;
            document.getElementById('avg-cost').textContent = avgCost;

            // åˆ¤æ–·ç•¶å‰éšæ®µå’Œæ±ºç­–æ¨¹ç¯€é»
            const openCalls = stockData.calls.filter(c => !c.closed && !c.exercised);
            const openPuts = stockData.puts.filter(p => !p.closed && !p.exercised);
            const stage = determineStage(totalShares, openCalls, openPuts);
            document.getElementById('current-stage').textContent = stage.stage;
            document.getElementById('decision-node').textContent = stage.node;

            // æ›´æ–°æ‰€æœ‰æŒå€‰ç¸½è¦½
            updateAllPositionsOverview();

            // æ›´æ–°å¯ç”¨è³‡é‡‘
            updateAvailableCash();

            // è¨ˆç®—æç›Š
            updatePnL();

            // ç”Ÿæˆä»»å‹™æ¸…å–®
            generateTasks(currentStock, totalShares, avgCost, openCalls, openPuts);

            // æ›´æ–°æ“ä½œæ­·å²
            updateHistory();
        }
        
        // æ›´æ–°æ‰€æœ‰æŒå€‰ç¸½è¦½ï¼ˆåŒ…å«å³æ™‚åƒ¹æ ¼è¼¸å…¥ï¼‰
        function updateAllPositionsOverview() {
            const overviewDiv = document.getElementById('all-positions-overview');
            if (!overviewDiv) return;
            
            const allPositions = [];
            
            // éæ­·æ‰€æœ‰è‚¡ç¥¨
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                // è¨ˆç®—è‚¡ç¥¨æŒå€‰
                let shares = 0;
                let cost = 0;
                let buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                        shares += op.shares;
                        cost += op.shares * op.price;
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                shares -= buyQueue[0].shares;
                                cost -= buyQueue[0].shares * buyQueue[0].price;
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                shares -= remaining;
                                cost -= remaining * buyQueue[0].price;
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });
                const avgCost = shares > 0 ? cost / shares : 0;
                const stockPrice = currentPrices.stocks[symbol]?.stock || 0;
                const stockValue = stockPrice > 0 ? stockPrice * shares : avgCost * shares;
                const stockPnL = stockPrice > 0 ? (stockPrice - avgCost) * shares : 0;
                
                if (shares > 0) {
                    allPositions.push({
                        type: 'stock',
                        symbol: symbol,
                        shares: shares,
                        avgCost: avgCost,
                        currentPrice: stockPrice,
                        value: stockValue,
                        pnl: stockPnL,
                        id: `stock_${symbol}`
                    });
                }
                
                // CallæŒå€‰ï¼ˆè³£å‡ºCallï¼Œæç›Šè¦åéä¾†ï¼‰
                const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                openCalls.forEach(call => {
                    const key = `${call.strike}_${call.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.calls?.[key] || call.premium;
                    // è³£å‡ºCallï¼šåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼Œåƒ¹æ ¼ä¸Šæ¼²æ˜¯è™§æï¼ˆæç›Šåéä¾†ï¼‰
                    const callPnL = (call.premium - currentPrice) * 100; // è³£å‡ºæ™‚ï¼špremium - currentPrice
                    
                    allPositions.push({
                        type: 'call',
                        symbol: symbol,
                        strike: call.strike,
                        expiry: call.expiry,
                        premium: call.premium,
                        currentPrice: currentPrice,
                        value: currentPrice * 100,
                        pnl: callPnL,
                        id: call.id
                    });
                });
                
                // PutæŒå€‰ï¼ˆè³£å‡ºPutï¼Œæç›Šè¦åéä¾†ï¼‰
                const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                openPuts.forEach(put => {
                    const key = `${put.strike}_${put.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.puts?.[key] || put.premium;
                    // è³£å‡ºPutï¼šåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼Œåƒ¹æ ¼ä¸Šæ¼²æ˜¯è™§æï¼ˆæç›Šåéä¾†ï¼‰
                    const putPnL = (put.premium - currentPrice) * 100; // è³£å‡ºæ™‚ï¼špremium - currentPrice
                    
                    allPositions.push({
                        type: 'put',
                        symbol: symbol,
                        strike: put.strike,
                        expiry: put.expiry,
                        premium: put.premium,
                        currentPrice: currentPrice,
                        value: currentPrice * 100,
                        pnl: putPnL,
                        id: put.id
                    });
                });
            });
            
            if (allPositions.length === 0) {
                overviewDiv.innerHTML = '<p style="color: #999; font-style: italic;">ç„¡æŒå€‰</p>';
            } else {
                overviewDiv.innerHTML = allPositions.map(pos => {
                    const pnlColor = pos.pnl >= 0 ? '#4caf50' : '#f44336';
                    if (pos.type === 'stock') {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} è‚¡ç¥¨</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">${pos.shares}è‚¡ @ $${pos.avgCost.toFixed(2)}</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="stock-price-${pos.symbol}" value="${pos.currentPrice > 0 ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="è¼¸å…¥å³æ™‚è‚¡åƒ¹" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updateStockPriceFromOverview('${pos.symbol}')" style="padding: 6px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">æ›´æ–°</button>
                                </div>
                                ${pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="font-size: 0.9em;">å¸‚å€¼: $${pos.value.toFixed(2)}</span> | 
                                        <span style="color: ${pnlColor}; font-weight: bold;">æœªå¯¦ç¾æç›Š: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">è«‹è¼¸å…¥å³æ™‚è‚¡åƒ¹æŸ¥çœ‹æç›Š</div>'}
                            </div>
                        `;
                    } else if (pos.type === 'call') {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} $${pos.strike} Call</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">è³£å‡º @ $${pos.premium.toFixed(2)}/è‚¡</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="call-price-${pos.id}" value="${pos.currentPrice !== pos.premium ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="è¼¸å…¥å³æ™‚åƒ¹ï¼ˆæ¯è‚¡ï¼‰" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updateCallPriceFromOverview('${pos.symbol}', ${pos.strike}, '${pos.expiry}', ${pos.id})" style="padding: 6px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">æ›´æ–°</button>
                                </div>
                                ${pos.currentPrice !== pos.premium || pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="color: ${pnlColor}; font-weight: bold;">æœªå¯¦ç¾æç›Š: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">è«‹è¼¸å…¥å³æ™‚åƒ¹æ ¼æŸ¥çœ‹æç›Š</div>'}
                                <div style="margin-top: 5px; font-size: 0.85em; color: #666;">åˆ°æœŸ: ${pos.expiry}</div>
                            </div>
                        `;
                    } else {
                        return `
                            <div style="padding: 12px; margin: 6px 0; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px; min-height: 90px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <strong style="font-size: 1.1em;">${pos.symbol} $${pos.strike} Put</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">è³£å‡º @ $${pos.premium.toFixed(2)}/è‚¡</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px; margin-top: 8px;">
                                    <input type="number" id="put-price-${pos.id}" value="${pos.currentPrice !== pos.premium ? pos.currentPrice.toFixed(2) : ''}" step="0.01" placeholder="è¼¸å…¥å³æ™‚åƒ¹ï¼ˆæ¯è‚¡ï¼‰" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                                    <button onclick="updatePutPriceFromOverview('${pos.symbol}', ${pos.strike}, '${pos.expiry}', ${pos.id})" style="padding: 6px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">æ›´æ–°</button>
                                </div>
                                ${pos.currentPrice !== pos.premium || pos.currentPrice > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                                        <span style="color: ${pnlColor}; font-weight: bold;">æœªå¯¦ç¾æç›Š: $${pos.pnl.toFixed(2)}</span>
                                    </div>
                                ` : '<div style="margin-top: 8px; font-size: 0.85em; color: #999;">è«‹è¼¸å…¥å³æ™‚åƒ¹æ ¼æŸ¥çœ‹æç›Š</div>'}
                                <div style="margin-top: 5px; font-size: 0.85em; color: #666;">åˆ°æœŸ: ${pos.expiry}</div>
                            </div>
                        `;
                    }
                }).join('');
            }
        }
        
        // å¾æŒå€‰ç¸½è¦½æ›´æ–°è‚¡ç¥¨åƒ¹æ ¼
        function updateStockPriceFromOverview(symbol) {
            const input = document.getElementById(`stock-price-${symbol}`);
            const price = parseFloat(input.value);
            if (price > 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                currentPrices.stocks[symbol].stock = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
            }
        }
        
        // å¾æŒå€‰ç¸½è¦½æ›´æ–°Callåƒ¹æ ¼
        function updateCallPriceFromOverview(symbol, strike, expiry, callId) {
            const input = document.getElementById(`call-price-${callId}`);
            const price = parseFloat(input.value);
            if (price >= 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                if (!currentPrices.stocks[symbol].calls) {
                    currentPrices.stocks[symbol].calls = {};
                }
                currentPrices.stocks[symbol].calls[`${strike}_${expiry}`] = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
            }
        }
        
        // å¾æŒå€‰ç¸½è¦½æ›´æ–°Putåƒ¹æ ¼
        function updatePutPriceFromOverview(symbol, strike, expiry, putId) {
            const input = document.getElementById(`put-price-${putId}`);
            const price = parseFloat(input.value);
            if (price >= 0) {
                if (!currentPrices.stocks[symbol]) {
                    currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
                }
                if (!currentPrices.stocks[symbol].puts) {
                    currentPrices.stocks[symbol].puts = {};
                }
                currentPrices.stocks[symbol].puts[`${strike}_${expiry}`] = price;
                savePrices();
                updatePnL();
                updateDisplay();
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼');
            }
        }
        
        // æ›´æ–°å¯ç”¨è³‡é‡‘
        function updateAvailableCash() {
            if (!dashboardData.stocks) {
                dashboardData.stocks = {};
            }
            
            // è¨ˆç®—æ‰€æœ‰æ·»åŠ çš„è³‡é‡‘
            let totalCash = 0;
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                totalCash = dashboardData.capitalAdditions.reduce((sum, addition) => sum + addition.amount, 0);
            }
            
            // è¨ˆç®—æ‰€æœ‰è‚¡ç¥¨çš„ç¾é‡‘æµ
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                // è‚¡ç¥¨è²·è³£ç¾é‡‘æµ
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        totalCash -= op.shares * op.price;
                    } else if (op.type === 'sell') {
                        totalCash += op.shares * op.price;
                    }
                });
                
                // æœŸæ¬Šæ¬Šåˆ©é‡‘ï¼ˆè³£å‡ºæ™‚æ”¶åˆ°æ¬Šåˆ©é‡‘ï¼Œè²·å›æ™‚æ”¯ä»˜ï¼‰
                stock.calls.forEach(call => {
                    if (!call.closed && !call.exercised) {
                        // æœªå¹³å€‰çš„è³£Callï¼Œå·²æ”¶åˆ°æ¬Šåˆ©é‡‘
                        totalCash += call.premium * 100;
                    } else if (call.closed) {
                        // å·²å¹³å€‰ï¼Œè¨ˆç®—æ·¨æç›Š
                        totalCash += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (!put.closed && !put.exercised) {
                        // æœªå¹³å€‰çš„è³£Putï¼Œå·²æ”¶åˆ°æ¬Šåˆ©é‡‘
                        totalCash += put.premium * 100;
                    } else if (put.closed) {
                        // å·²å¹³å€‰ï¼Œè¨ˆç®—æ·¨æç›Š
                        totalCash += (put.premium - put.closePrice) * 100;
                    }
                });
                
                // è²·å…¥çš„Call/Putï¼ˆé–‹å€‰æ™‚æ”¯ä»˜æ¬Šåˆ©é‡‘ï¼‰
                stock.buyCalls.forEach(buyCall => {
                    totalCash -= buyCall.premium * 100;
                });
                
                stock.buyPuts.forEach(buyPut => {
                    totalCash -= buyPut.premium * 100;
                });
            });
            
            const cashElement = document.getElementById('available-cash');
            if (cashElement) {
                cashElement.textContent = `$${totalCash.toFixed(2)}`;
            }
        }


        // æ›´æ–°Callåƒ¹æ ¼
        function updateCallPrice(symbol, strike, expiry, price) {
            if (!currentPrices.stocks[symbol]) {
                currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
            }
            if (!currentPrices.stocks[symbol].calls) {
                currentPrices.stocks[symbol].calls = {};
            }
            currentPrices.stocks[symbol].calls[`${strike}_${expiry}`] = parseFloat(price);
            savePrices();
            updatePnL();
            updateDisplay();
        }

        // æ›´æ–°Putåƒ¹æ ¼
        function updatePutPrice(symbol, strike, expiry, price) {
            if (!currentPrices.stocks[symbol]) {
                currentPrices.stocks[symbol] = {stock: 0, calls: {}, puts: {}};
            }
            if (!currentPrices.stocks[symbol].puts) {
                currentPrices.stocks[symbol].puts = {};
            }
            currentPrices.stocks[symbol].puts[`${strike}_${expiry}`] = parseFloat(price);
            savePrices();
            updatePnL();
            updateDisplay();
        }

        // è¨ˆç®—æç›Šï¼ˆæ”¯æŒå¤šè‚¡ç¥¨ï¼‰
        function updatePnL() {
            let totalRealizedPnL = 0;
            let totalUnrealizedPnL = 0;
            
            // è¨ˆç®—å¯ç”¨è³‡é‡‘ï¼ˆç¾é‡‘ï¼‰
            let availableCash = 0;
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                availableCash = dashboardData.capitalAdditions.reduce((sum, addition) => sum + addition.amount, 0);
            }
            
            // è¨ˆç®—æ‰€æœ‰è‚¡ç¥¨çš„ç¾é‡‘æµ
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        availableCash -= op.shares * op.price;
                    } else if (op.type === 'sell') {
                        availableCash += op.shares * op.price;
                    }
                });
                
                // æœŸæ¬Šæ¬Šåˆ©é‡‘ï¼ˆè³£å‡ºæ™‚æ”¶åˆ°ï¼Œè²·å›æ™‚æ”¯ä»˜ï¼‰
                stock.calls.forEach(call => {
                    if (!call.closed && !call.exercised) {
                        availableCash += call.premium * 100; // æ¯å£100è‚¡
                    } else if (call.closed) {
                        availableCash += (call.premium - call.closePrice) * 100;
                    }
                });
                
                stock.puts.forEach(put => {
                    if (!put.closed && !put.exercised) {
                        availableCash += put.premium * 100; // æ¯å£100è‚¡
                    } else if (put.closed) {
                        availableCash += (put.premium - put.closePrice) * 100;
                    }
                });
                
                // è²·å…¥çš„Call/Putï¼ˆé–‹å€‰æ™‚æ”¯ä»˜æ¬Šåˆ©é‡‘ï¼‰
                stock.buyCalls.forEach(buyCall => {
                    availableCash -= buyCall.premium * 100;
                });
                
                stock.buyPuts.forEach(buyPut => {
                    availableCash -= buyPut.premium * 100;
                });
            });

            // è¨ˆç®—ç¸½è³‡ç”¢åƒ¹å€¼ = å¯ç”¨è³‡é‡‘ + æ‰€æœ‰è‚¡ç¥¨å¸‚å€¼ + æ‰€æœ‰æœŸæ¬Šå¸‚å€¼
            let totalAssets = availableCash;

            // éæ­·æ‰€æœ‰è‚¡ç¥¨
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                let realizedPnL = 0;
                let unrealizedPnL = 0;
                
                // è‚¡ç¥¨å·²å¯¦ç¾æç›Š
                let buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                realizedPnL += buyQueue[0].shares * (op.price - buyQueue[0].price);
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                realizedPnL += remaining * (op.price - buyQueue[0].price);
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });

                // Callå·²å¯¦ç¾æç›Š
                stock.calls.forEach(call => {
                    if (call.closed && call.closePrice !== undefined) {
                        // è²·å›å¹³å€‰ï¼špremium - closePrice
                        realizedPnL += (call.premium - call.closePrice) * 100;
                    } else if (call.exercised) {
                        // è¢«è¡Œä½¿ï¼šè¦–ç‚ºä»¥0å…ƒè²·å›ï¼Œè³ºåˆ°å…¨éƒ¨æ¬Šåˆ©é‡‘
                        realizedPnL += call.premium * 100;
                    }
                });

                // Putå·²å¯¦ç¾æç›Š
                stock.puts.forEach(put => {
                    if (put.closed && put.closePrice !== undefined) {
                        // è²·å›å¹³å€‰ï¼špremium - closePrice
                        realizedPnL += (put.premium - put.closePrice) * 100;
                    } else if (put.exercised) {
                        // è¢«è¡Œä½¿ï¼šè¦–ç‚ºä»¥0å…ƒè²·å›ï¼Œè³ºåˆ°å…¨éƒ¨æ¬Šåˆ©é‡‘
                        realizedPnL += put.premium * 100;
                    }
                });

                // è¨ˆç®—ç•¶å‰è‚¡ç¥¨æŒå€‰å’Œæˆæœ¬
                let shares = 0;
                let cost = 0;
                buyQueue = [];
                stock.operations.forEach(op => {
                    if (op.type === 'buy') {
                        buyQueue.push({shares: op.shares, price: op.price});
                        shares += op.shares;
                        cost += op.shares * op.price;
                    } else if (op.type === 'sell') {
                        let remaining = op.shares;
                        while (remaining > 0 && buyQueue.length > 0) {
                            if (buyQueue[0].shares <= remaining) {
                                shares -= buyQueue[0].shares;
                                cost -= buyQueue[0].shares * buyQueue[0].price;
                                remaining -= buyQueue[0].shares;
                                buyQueue.shift();
                            } else {
                                shares -= remaining;
                                cost -= remaining * buyQueue[0].price;
                                buyQueue[0].shares -= remaining;
                                remaining = 0;
                            }
                        }
                    }
                });
                const avgCost = shares > 0 ? cost / shares : 0;

                // è‚¡ç¥¨å¸‚å€¼ï¼ˆåŠ å…¥ç¸½è³‡ç”¢ï¼‰
                const stockPrice = currentPrices.stocks[symbol]?.stock || 0;
                if (stockPrice > 0 && shares > 0) {
                    totalAssets += stockPrice * shares;
                    unrealizedPnL += (stockPrice - avgCost) * shares;
                } else if (shares > 0) {
                    totalAssets += avgCost * shares; // å¦‚æœæ²’æœ‰å³æ™‚åƒ¹æ ¼ï¼Œä½¿ç”¨æˆæœ¬åƒ¹
                }

                // Callæœªå¯¦ç¾æç›Šå’Œå¸‚å€¼ï¼ˆè³£å‡ºCallï¼šåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼Œåƒ¹æ ¼ä¸Šæ¼²æ˜¯è™§æï¼‰
                const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                openCalls.forEach(call => {
                    const key = `${call.strike}_${call.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.calls?.[key] || call.premium;
                    const callValue = currentPrice * 100; // æ¯å£100è‚¡
                    totalAssets -= callValue; // è³£å‡ºCallæ˜¯è² å‚µï¼Œéœ€è¦æ¸›å»
                    // è³£å‡ºCallï¼špremium - currentPriceï¼ˆåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼‰
                    unrealizedPnL += (call.premium - currentPrice) * 100;
                });

                // Putæœªå¯¦ç¾æç›Šå’Œå¸‚å€¼ï¼ˆè³£å‡ºPutï¼šåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼Œåƒ¹æ ¼ä¸Šæ¼²æ˜¯è™§æï¼‰
                const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                openPuts.forEach(put => {
                    const key = `${put.strike}_${put.expiry}`;
                    const currentPrice = currentPrices.stocks[symbol]?.puts?.[key] || put.premium;
                    const putValue = currentPrice * 100; // æ¯å£100è‚¡
                    totalAssets -= putValue; // è³£å‡ºPutæ˜¯è² å‚µï¼Œéœ€è¦æ¸›å»
                    // è³£å‡ºPutï¼špremium - currentPriceï¼ˆåƒ¹æ ¼ä¸‹è·Œæ˜¯ç›ˆåˆ©ï¼‰
                    unrealizedPnL += (put.premium - currentPrice) * 100;
                });

                totalRealizedPnL += realizedPnL;
                totalUnrealizedPnL += unrealizedPnL;
            });

            // æ›´æ–°é¡¯ç¤º
            const realizedColor = totalRealizedPnL >= 0 ? '#4caf50' : '#f44336';
            const unrealizedColor = totalUnrealizedPnL >= 0 ? '#4caf50' : '#f44336';
            
            document.getElementById('realized-pnl').textContent = `$${totalRealizedPnL.toFixed(2)}`;
            document.getElementById('realized-pnl').style.color = realizedColor;
            
            document.getElementById('unrealized-pnl').textContent = `$${totalUnrealizedPnL.toFixed(2)}`;
            document.getElementById('unrealized-pnl').style.color = unrealizedColor;
            
            document.getElementById('total-assets').textContent = `$${totalAssets.toFixed(2)}`;
        }

        // åˆ¤æ–·ç•¶å‰éšæ®µï¼ˆä½¿ç”¨æœªå¹³å€‰çš„callså’Œputsï¼‰
        function determineStage(shares, calls, puts) {
            if (shares === 0) {
                return { stage: 'æœªé–‹å§‹', node: 'ç­‰å¾…åˆå§‹å»ºå€‰' };
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰Strangle
            if (calls.length > 0 && puts.length > 0) {
                return { 
                    stage: 'éšæ®µå››ï¼šStrangleç®¡ç†', 
                    node: 'æƒ…å¢ƒD1ï¼šStrangleç®¡ç†åˆ†æ”¯' 
                };
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰Call
            if (calls.length > 0) {
                const latestCall = calls[calls.length - 1];
                const today = new Date();
                const expiry = new Date(latestCall.expiry);
                const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

                if (daysUntilExpiry > 3) {
                    return { 
                        stage: 'éšæ®µäºŒï¼šé€±ä¸­ç®¡ç†', 
                        node: 'ç›£æ§GTCè¨‚å–®ï¼ˆ$5è²·å›Callï¼‰' 
                    };
                } else {
                    return { 
                        stage: 'éšæ®µä¸‰ï¼šçµç®—å‰', 
                        node: `ç­‰å¾…é€±äº”çµç®—ï¼ˆå‰©é¤˜${daysUntilExpiry}å¤©ï¼‰` 
                    };
                }
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰Put
            if (puts.length > 0) {
                return { 
                    stage: 'éšæ®µå››ï¼šåªè³£Putéšæ®µ', 
                    node: 'ç­‰å¾…Putè¡Œæ¬Šæˆ–éæœŸ' 
                };
            }

            // åªæœ‰æŒè‚¡
            if (shares === 150) {
                return { 
                    stage: 'éšæ®µä¸€ï¼šåˆå§‹å»ºå€‰', 
                    node: 'éœ€è¦è³£å‡ºCovered Call' 
                };
            }

            return { 
                stage: 'éšæ®µå››ï¼šé‡å•Ÿéšæ®µ', 
                node: 'æ ¹æ“šæŒå€‰æ±ºå®šä¸‹ä¸€æ­¥' 
            };
        }

        // ç”Ÿæˆä»»å‹™æ¸…å–®ï¼ˆæ”¯æŒå¤šè‚¡ç¥¨ï¼‰
        function generateTasks(symbol, shares, avgCost, calls, puts) {
            const taskList = document.getElementById('task-list');
            const tasks = [];

            if (!symbol) {
                taskList.innerHTML = '<p style="color: #999; font-style: italic;">è«‹å…ˆé¸æ“‡æˆ–æ–°å¢è‚¡ç¥¨</p>';
                return;
            }

            if (shares === 0) {
                tasks.push(`ğŸ“ ${symbol}: è¼¸å…¥åˆå§‹è²·å…¥æ“ä½œï¼ˆå»ºè­°ï¼š150è‚¡ @ $11.00ï¼‰`);
                tasks.push(`ğŸ“ ${symbol}: è¼¸å…¥è³£Callæ“ä½œï¼ˆå»ºè­°ï¼š$12 Callï¼‰`);
            } else if (shares > 0 && calls.length === 0) {
                tasks.push(`âš ï¸ ${symbol}: ç«‹å³è³£å‡ºCovered Callï¼ˆå»ºè­°ï¼š$12 Callï¼‰`);
                tasks.push(`ğŸ“ ${symbol}: æ›GTCè¨‚å–®ï¼šä»¥$5è²·å›Callï¼ˆé–å®š90%åˆ©æ½¤ï¼‰`);
            } else if (calls.length > 0) {
                calls.forEach(call => {
                    const today = new Date();
                    const expiry = new Date(call.expiry);
                    const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    
                    tasks.push(`ğŸ“Š ${symbol}: ç›£æ§$${call.strike} Callåƒ¹æ ¼ï¼Œç•¶è·Œè‡³$5æ™‚GTCè¨‚å–®æœƒè‡ªå‹•æˆäº¤`);
                    tasks.push(`â° ${symbol}: $${call.strike} Callè·é›¢åˆ°æœŸé‚„æœ‰ ${daysUntilExpiry} å¤©`);
                    
                    if (daysUntilExpiry <= 1) {
                        tasks.push(`âš ï¸ ${symbol}: æº–å‚™é€±äº”çµç®—ï¼šæª¢æŸ¥è‚¡åƒ¹æ˜¯å¦æœƒè¶…é$${call.strike}`);
                    }
                });

                if (calls.length > 0 && puts.length > 0) {
                    tasks.push(`ğŸ”„ ${symbol}: Strangleç®¡ç†ï¼šç›£æ§Callå’ŒPutçš„åƒ¹æ ¼è®ŠåŒ–`);
                    tasks.push(`ğŸ“ ${symbol}: æ›GTCè¨‚å–®åˆ†åˆ¥è²·å›Callå’ŒPutï¼ˆé–å®š80-90%åˆ©æ½¤ï¼‰`);
                }
            }

            if (puts.length > 0 && calls.length === 0) {
                puts.forEach(put => {
                    tasks.push(`ğŸ“Š ${symbol}: ç›£æ§$${put.strike} Putåƒ¹æ ¼ï¼Œæº–å‚™åœ¨$${put.strike}è¡Œæ¬Šæ™‚åŠ å€‰`);
                });
            }

            // æ·»åŠ æ‰€æœ‰è‚¡ç¥¨çš„ä»»å‹™
            Object.keys(dashboardData.stocks).forEach(stockSymbol => {
                if (stockSymbol !== symbol) {
                    const stock = dashboardData.stocks[stockSymbol];
                    const openCalls = stock.calls.filter(c => !c.closed && !c.exercised);
                    const openPuts = stock.puts.filter(p => !p.closed && !p.exercised);
                    
                    if (openCalls.length > 0) {
                        openCalls.forEach(call => {
                            tasks.push(`ğŸ“Š ${stockSymbol}: ç›£æ§$${call.strike} Call`);
                        });
                    }
                    if (openPuts.length > 0) {
                        openPuts.forEach(put => {
                            tasks.push(`ğŸ“Š ${stockSymbol}: ç›£æ§$${put.strike} Put`);
                        });
                    }
                }
            });

            if (tasks.length === 0) {
                taskList.innerHTML = '<p style="color: #999; font-style: italic;">è«‹è¼¸å…¥æŒå€‰æ•¸æ“šä»¥ç”Ÿæˆä»»å‹™</p>';
            } else {
                taskList.innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">' + 
                    tasks.map(task => `<li style="padding: 10px; margin: 4px 0; background: #f0f0f0; border-radius: 4px; min-height: 45px; display: flex; align-items: center;">${task}</li>`).join('') + 
                    '</ul>';
            }
        }
        

        // æ›´æ–°æ“ä½œæ­·å²ï¼ˆæ”¯æŒå¤šè‚¡ç¥¨ï¼‰
        function updateHistory() {
            const historyDiv = document.getElementById('operation-history');
            const allOps = [];

            // æ·»åŠ è³‡é‡‘è¨˜éŒ„
            if (dashboardData.capitalAdditions && dashboardData.capitalAdditions.length > 0) {
                dashboardData.capitalAdditions.forEach(addition => {
                    allOps.push({
                        type: 'æ·»åŠ è³‡é‡‘',
                        desc: `$${addition.amount.toFixed(2)}`,
                        date: addition.date
                    });
                });
            }

            // éæ­·æ‰€æœ‰è‚¡ç¥¨çš„æ“ä½œ
            Object.keys(dashboardData.stocks).forEach(symbol => {
                const stock = dashboardData.stocks[symbol];
                
                stock.operations.forEach(op => {
                    allOps.push({
                        type: op.type === 'buy' ? 'è²·å…¥' : 'è³£å‡º',
                        desc: `${symbol}: ${op.shares}è‚¡ @ $${op.price.toFixed(2)}${op.reason ? ` (${op.reason})` : ''}`,
                        date: op.date
                    });
                });

                stock.calls.forEach(call => {
                    if (call.exercised) {
                        allOps.push({
                            type: 'Callè¢«è¡Œä½¿',
                            desc: `${symbol} $${call.strike.toFixed(2)} Callè¢«è¡Œä½¿ï¼Œè‡ªå‹•è³£å‡º100è‚¡ @ $${call.strike}`,
                            date: call.exerciseDate
                        });
                    } else if (call.closed) {
                        allOps.push({
                            type: 'è³£Callï¼ˆå·²å¹³å€‰ï¼‰',
                            desc: `${symbol} $${call.strike.toFixed(2)} Callï¼Œè³£å‡º $${call.premium.toFixed(2)}ï¼Œè²·å› $${call.closePrice.toFixed(2)}ï¼Œæç›Š $${((call.premium - call.closePrice) * 100).toFixed(2)}`,
                            date: call.closeDate
                        });
                    } else {
                        allOps.push({
                            type: 'è³£Call',
                            desc: `${symbol} $${call.strike.toFixed(2)} Callï¼Œæ¬Šåˆ©é‡‘ $${call.premium.toFixed(2)}`,
                            date: call.date
                        });
                    }
                });

                stock.puts.forEach(put => {
                    if (put.exercised) {
                        allOps.push({
                            type: 'Putè¢«è¡Œä½¿',
                            desc: `${symbol} $${put.strike.toFixed(2)} Putè¢«è¡Œä½¿ï¼Œè‡ªå‹•è²·å…¥100è‚¡ @ $${put.strike}`,
                            date: put.exerciseDate
                        });
                    } else if (put.closed) {
                        allOps.push({
                            type: 'è³£Putï¼ˆå·²å¹³å€‰ï¼‰',
                            desc: `${symbol} $${put.strike.toFixed(2)} Putï¼Œè³£å‡º $${put.premium.toFixed(2)}ï¼Œè²·å› $${put.closePrice.toFixed(2)}ï¼Œæç›Š $${((put.premium - put.closePrice) * 100).toFixed(2)}`,
                            date: put.closeDate
                        });
                    } else {
                        allOps.push({
                            type: 'è³£Put',
                            desc: `${symbol} $${put.strike.toFixed(2)} Putï¼Œæ¬Šåˆ©é‡‘ $${put.premium.toFixed(2)}`,
                            date: put.date
                        });
                    }
                });
            });

            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            allOps.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allOps.length === 0) {
                historyDiv.innerHTML = '<p style="color: #999; font-style: italic;">å°šç„¡æ“ä½œè¨˜éŒ„</p>';
            } else {
                historyDiv.innerHTML = '<ul style="list-style: none; padding: 0;">' + 
                    allOps.map(op => 
                        `<li style="padding: 8px; margin: 5px 0; background: #f8f9fa; border-left: 3px solid #3498db; border-radius: 4px;">
                            <strong>${op.type}</strong> - ${op.desc} <span style="color: #999; font-size: 0.9em;">(${op.date})</span>
                        </li>`
                    ).join('') + 
                    '</ul>';
            }
        }

        // ç›£è½è‚¡ç¥¨ä»£è™Ÿè¼¸å…¥
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            const symbolInput = document.getElementById('stock-symbol');
            if (symbolInput) {
                symbolInput.value = dashboardData.stockSymbol;
                symbolInput.addEventListener('blur', function() {
                    dashboardData.stockSymbol = this.value;
                    saveData();
                });
            }

            // å®šæœŸæ›´æ–°é¡¯ç¤ºï¼ˆæ¯30ç§’ï¼‰
            setInterval(updateDisplay, 30000);
            
            // è¼‰å…¥ä¿å­˜çš„åƒ¹æ ¼
            const savedPrices = localStorage.getItem('tradingPrices');
            if (savedPrices) {
                currentPrices = JSON.parse(savedPrices);
            }
            
            // åˆå§‹åŒ–æ™‚æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard();
        });

        // ä¿å­˜åƒ¹æ ¼åˆ°localStorage
        function savePrices() {
            localStorage.setItem('tradingPrices', JSON.stringify(currentPrices));
        }
    </script>
</body>
</html>

